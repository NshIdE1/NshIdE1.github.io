<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>从实践中学习unidbg使用(六) | NshIdE&#39;s Home</title>
  <meta name="keywords" content=" Unidbg ">
  <meta name="description" content="从实践中学习unidbg使用(六) | NshIdE&#39;s Home">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="tags">
<meta property="og:url" content="https://nshide1.github.io/tags/">
<meta property="og:site_name" content="NshIdE&#39;s Home">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-03-04T12:20:04.979Z">
<meta property="article:modified_time" content="2025-03-04T12:20:04.979Z">
<meta property="article:author" content="NshIdE">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/logo.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/logo.jpg"/>
</a>
<div class="author">
    <span>NshIdE</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/NshIdE1/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="csdn"
               href="https://www.csdn.net/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=1621925986&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(40)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="其他">
            
            其他
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Android-RE">
            
            Android-RE
            <small>(2)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Android学习">
            
            Android学习
            <small>(9)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Angr入门">
            
            Angr入门
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="CTF">
            
            CTF
            <small>(15)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Frida入门">
            
            Frida入门
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Java学习">
            
            Java学习
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Unidbg学习">
            
            Unidbg学习
            <small>(10)</small>
        </div>
        
    </li>

            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="40">
<input type="hidden" id="yelog_site_word_count" value="221.9k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://bananashipsbbq.github.io/">bananaships</a></li>
            
            <li><a target="_blank" href="https://astralprisma.github.io/">AstralPrisma</a></li>
            
            <li><a target="_blank" href="https://monoceros406.github.io/">Monoceros406</a></li>
            
            <li><a target="_blank" href="https://github.com/Thir0th">Thir0th</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="search shortcut key i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="switch to outline view shortcut key w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="return"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="case sensitive"></i>
            <i class="iconfont icon-tag" data-title="label"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">outline</div>
            <i class="iconfont icon-list" data-title="switch to article list"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>抽象</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>符号执行</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>取证</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>应急响应</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CTF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Frida</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>go</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Harmony</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>il2Cpps</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>iOS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ISW</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RE</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SIMD</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Unidbg</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Unity</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WritesUp</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="All CTF "
           href="/2025/10/25/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%BC%BA%E7%BD%91%C2%B7%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E5%9B%BD%E9%99%85%E7%B2%BE%E8%8B%B1%E6%8C%91%E6%88%98%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,Android,il2Cpps"
           data-author="" >
            <span class="post-title" title="第八届强网·拟态防御国际精英挑战赛">第八届强网·拟态防御国际精英挑战赛</span>
            <span class="post-date" title="2025-10-25 17:31:37">2025/10/25</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/10/22/Android%20APP%20%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android APP 常见漏洞">Android APP 常见漏洞</span>
            <span class="post-date" title="2025-10-22 17:06:07">2025/10/22</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/10/10/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20PackageInfo%20%E5%92%8C%20LoadedApk/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="从源码分析 PackageInfo 和 LoadedApk">从源码分析 PackageInfo 和 LoadedApk</span>
            <span class="post-date" title="2025-10-10 18:15:17">2025/10/10</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/09/09/2025%E5%B9%B4%E6%B9%BE%E5%8C%BA%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="2025年湾区杯网络安全大赛初赛">2025年湾区杯网络安全大赛初赛</span>
            <span class="post-date" title="2025-09-09 09:34:17">2025/09/09</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/09/08/Android%20SO%20%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android SO 文件加载过程">Android SO 文件加载过程</span>
            <span class="post-date" title="2025-09-08 17:18:50">2025/09/08</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/25/Dex%20%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Dex 文件结构学习">Dex 文件结构学习</span>
            <span class="post-date" title="2025-08-25 17:33:29">2025/08/25</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/19/ClassLoader%20%E6%9C%BA%E5%88%B6/"
           data-tag="Android,Java"
           data-author="" >
            <span class="post-title" title="ClassLoader 机制">ClassLoader 机制</span>
            <span class="post-date" title="2025-08-19 17:42:51">2025/08/19</span>
        </a>
        
        
        <a  class="All Java学习 "
           href="/2025/08/19/Java%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"
           data-tag="Android,Java"
           data-author="" >
            <span class="post-title" title="Java学习----反射机制">Java学习----反射机制</span>
            <span class="post-date" title="2025-08-19 17:00:02">2025/08/19</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/19/Android%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android 应用启动流程">Android 应用启动流程</span>
            <span class="post-date" title="2025-08-19 11:14:13">2025/08/19</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/19/%E5%AE%89%E5%8D%93%E5%8A%A0%E5%9B%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="安卓加固学习记录">安卓加固学习记录</span>
            <span class="post-date" title="2025-08-19 10:50:46">2025/08/19</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/14/Android%20%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94NDK%20%E5%BC%80%E5%8F%91/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android 开发--NDK 开发">Android 开发--NDK 开发</span>
            <span class="post-date" title="2025-08-14 17:56:58">2025/08/14</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/08/10/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E5%85%AD)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(六)">从实践中学习unidbg使用(六)</span>
            <span class="post-date" title="2025-08-10 10:25:02">2025/08/10</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/08/08/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%BA%94)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(五)">从实践中学习unidbg使用(五)</span>
            <span class="post-date" title="2025-08-08 17:45:59">2025/08/08</span>
        </a>
        
        
        <a  class="All Android学习 "
           href="/2025/08/05/%E6%BC%AB%E8%B0%88%E5%94%AF%E4%B8%80%E8%AE%BE%E5%A4%87ID/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="漫谈唯一设备 ID">漫谈唯一设备 ID</span>
            <span class="post-date" title="2025-08-05 18:00:44">2025/08/05</span>
        </a>
        
        
        <a  class="All 其他 "
           href="/2025/07/24/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Linux%20%E7%B3%BB%E7%BB%9F%E4%B8%8B%20proc%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AE%B9/"
           data-tag="Android,Linux"
           data-author="" >
            <span class="post-title" title="浅谈 Linux 系统下 proc 文件系统内容">浅谈 Linux 系统下 proc 文件系统内容</span>
            <span class="post-date" title="2025-07-24 17:56:57">2025/07/24</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/07/24/Unidbg%20%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%EF%BC%88%E4%BA%8C%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="Unidbg 中处理文件访问(二)">Unidbg 中处理文件访问(二)</span>
            <span class="post-date" title="2025-07-24 17:00:12">2025/07/24</span>
        </a>
        
        
        <a  class="All Android-RE "
           href="/2025/07/23/2025%E7%AC%AC%E5%8D%81%E5%B1%8A%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9D%E8%B5%9B-%E5%AE%89%E5%8D%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/"
           data-tag="RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="2025第十届游戏安全竞赛-初赛-安卓客户端安全">2025第十届游戏安全竞赛-初赛-安卓客户端安全</span>
            <span class="post-date" title="2025-07-23 15:32:11">2025/07/23</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/07/19/%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="创建模拟器和加载模块">创建模拟器和加载模块</span>
            <span class="post-date" title="2025-07-19 15:14:29">2025/07/19</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/07/15/Unidbg%20%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%EF%BC%88%E4%B8%80%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="Unidbg 中处理文件访问(一)">Unidbg 中处理文件访问(一)</span>
            <span class="post-date" title="2025-07-15 16:52:06">2025/07/15</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/07/08/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E5%9B%9B)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(四)">从实践中学习unidbg使用(四)</span>
            <span class="post-date" title="2025-07-08 11:44:49">2025/07/08</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/07/01/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%B8%89)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(三)">从实践中学习unidbg使用(三)</span>
            <span class="post-date" title="2025-07-01 15:29:42">2025/07/01</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/06/07/%E7%AC%AC%E4%B8%80%E5%B1%8AOpenHarmonyCTF/"
           data-tag="CTF,RE,WritesUp,Harmony"
           data-author="" >
            <span class="post-title" title="第一届OpenHarmonyCTF">第一届OpenHarmonyCTF</span>
            <span class="post-date" title="2025-06-07 13:32:45">2025/06/07</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/06/04/%E8%A1%A5%E5%BA%93%E5%87%BD%E6%95%B0%EF%BC%88%E4%BA%94%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="补库函数(五)">补库函数(五)</span>
            <span class="post-date" title="2025-06-04 19:07:56">2025/06/04</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/06/02/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%BA%8C)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(二)">从实践中学习unidbg使用(二)</span>
            <span class="post-date" title="2025-06-02 15:33:15">2025/06/02</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/05/31/D%5E3CTF2025/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="D^3CTF2025">D^3CTF2025</span>
            <span class="post-date" title="2025-05-31 16:21:11">2025/05/31</span>
        </a>
        
        
        <a  class="All Unidbg学习 "
           href="/2025/05/28/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%B8%80)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="从实践中学习unidbg使用(一)">从实践中学习unidbg使用(一)</span>
            <span class="post-date" title="2025-05-28 16:39:23">2025/05/28</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/05/17/Parloo2025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="Parloo RE">Parloo RE</span>
            <span class="post-date" title="2025-05-17 09:34:20">2025/05/17</span>
        </a>
        
        
        <a  class="All Android-RE "
           href="/2025/05/07/%E8%AE%B0%E4%B8%80%E6%AC%A1APK%E5%88%86%E6%9E%90/"
           data-tag="RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="记一次APK分析">记一次APK分析</span>
            <span class="post-date" title="2025-05-07 21:12:00">2025/05/07</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/26/%E4%B8%80%E9%81%93%E5%BE%88%E9%80%86%E5%A4%A9%E7%9A%84RC4/"
           data-tag="CTF,RE,WritesUp,抽象"
           data-author="" >
            <span class="post-title" title="抽象RC4">抽象RC4</span>
            <span class="post-date" title="2025-04-26 22:21:19">2025/04/26</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/24/%E5%BE%88%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E4%B8%80%E9%81%93%E9%A2%98/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="很有意思的一道题">很有意思的一道题</span>
            <span class="post-date" title="2025-04-24 21:56:18">2025/04/24</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/23/%E4%BA%AC%E9%BA%92CTF2025%20%E7%83%AD%E8%BA%AB%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,iOS,SIMD"
           data-author="" >
            <span class="post-title" title="京麒CTF2025热身赛">京麒CTF2025热身赛</span>
            <span class="post-date" title="2025-04-23 13:33:59">2025/04/23</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/14/TGCTF2025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TGCTF2025 RE">TGCTF2025 RE</span>
            <span class="post-date" title="2025-04-14 18:51:29">2025/04/14</span>
        </a>
        
        
        <a  class="All Angr入门 "
           href="/2025/04/14/Angr%E5%85%A5%E9%97%A8/"
           data-tag="符号执行"
           data-author="" >
            <span class="post-title" title="Angr入门">Angr入门</span>
            <span class="post-date" title="2025-04-14 18:50:44">2025/04/14</span>
        </a>
        
        
        <a  class="All Frida入门 "
           href="/2025/04/14/Frida%E5%85%A5%E9%97%A8/"
           data-tag="Android,Frida"
           data-author="" >
            <span class="post-title" title="Frida入门">Frida入门</span>
            <span class="post-date" title="2025-04-14 18:47:37">2025/04/14</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/12/TEXSAWCTF%202025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TEXSAWCTF 2025">TEXSAWCTF 2025</span>
            <span class="post-date" title="2025-04-12 15:32:31">2025/04/12</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/23/NCTF2024/"
           data-tag="CTF,RE,WritesUp,vm,go"
           data-author="" >
            <span class="post-title" title="NCTF2024">NCTF2024</span>
            <span class="post-date" title="2025-03-23 11:58:53">2025/03/23</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/18/CISCN%20x%20CCB%20%E5%8D%8A%E5%86%B3%E8%B5%9B%202025%20ISW(%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94)/"
           data-tag="ISW,应急响应,取证"
           data-author="" >
            <span class="post-title" title="CISCN x CCB 半决赛 2025 ISW(应急响应)">CISCN x CCB 半决赛 2025 ISW(应急响应)</span>
            <span class="post-date" title="2025-03-18 10:24:23">2025/03/18</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/11/TPCTF%202025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TPCTF 2025">TPCTF 2025</span>
            <span class="post-date" title="2025-03-11 21:41:19">2025/03/11</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/06/VishwaCTF2025/"
           data-tag="CTF,RE,WritesUp,Android,Unity"
           data-author="" >
            <span class="post-title" title="VishwaCTF2025">VishwaCTF2025</span>
            <span class="post-date" title="2025-03-06 21:52:51">2025/03/06</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/03/HGAME%20RE/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="HGAME-RE-WEEK1">HGAME-RE-WEEK1</span>
            <span class="post-date" title="2025-03-03 22:20:33">2025/03/03</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="Toggle full screen shortcut key s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-从实践中学习unidbg使用(六)" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">从实践中学习unidbg使用(六)</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Unidbg学习">Unidbg学习</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color2">Unidbg</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2025-08-14 14:42:58'>2025-08-10 10:25</time>
        
    </div>
    <div class="article-meta">
        
        <span>Count:19.1k</span>
        
        
        <span id="busuanzi_container_page_pv">
            Views 👀 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="Jump to comment area">
            <a href="#comments">
                Comment:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8-%E5%85%AD"><span class="toc-text">从实践中学习unidbg使用(六)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%BC%95%E8%A8%80"><span class="toc-text">一、引言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BB%BB%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、任务介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">三、初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81getEnvironmentInfo"><span class="toc-text">四、getEnvironmentInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81getEnvironmentInfoExtra"><span class="toc-text">五、getEnvironmentInfoExtra</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81getExtrarnalEquipmentInfo"><span class="toc-text">六、getExtrarnalEquipmentInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81getHWEquipmentInfo"><span class="toc-text">七、getHWEquipmentInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AB%E3%80%81getHWProperty"><span class="toc-text">八、getHWProperty</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%9D%E3%80%81getHWStatus"><span class="toc-text">九、getHWStatus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E3%80%81getLocationInfo"><span class="toc-text">十、getLocationInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81getPlatformInfo"><span class="toc-text">十一、getPlatformInfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81getUserAction"><span class="toc-text">十二、getUserAction</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E5%B0%BE%E5%A3%B0"><span class="toc-text">十三、尾声</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E5%8F%82%E8%80%83"><span class="toc-text">十四、参考</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="从实践中学习unidbg使用-六"><a href="#从实践中学习unidbg使用-六" class="headerlink" title="从实践中学习unidbg使用(六)"></a>从实践中学习unidbg使用(六)</h1><h3 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h3><p>本篇样本详见参考</p>
<h3 id="二、任务介绍"><a href="#二、任务介绍" class="headerlink" title="二、任务介绍"></a>二、任务介绍</h3><p><strong>Jadx</strong> 反编译 APK，找到 <strong>com.meituan.android.common.mtguard.NBridge</strong> 类，这是 <strong>MTGuard 安全 SDK</strong> 的一个 Java 桥接层。其中有一个叫 <strong>SIUACollector</strong> 的内部类，里面有以下这些 Native 方法。</p>
<pre><code class="language-Java">private native String getEnvironmentInfo();

private native String getEnvironmentInfoExtra();

private native String getExternalEquipmentInfo();

private native String getHWEquipmentInfo();

private native String getHWProperty();

private native String getHWStatus();

private native String getLocationInfo();

private native String getPlatformInfo();

private native String getUserAction();

public native String startCollection();
</code></pre>
<p>是 “<strong>安全信息与用户行为采集器</strong>” ，收集 <strong>硬件信息</strong>、检查 <strong>网络信息</strong>、获取 <strong>应用信息</strong>、<strong>电池状态</strong> 等。</p>
<p>请在 Unidbg 中依次执行这十个函数，本篇的重点是巩固 Unidbg 补环境的形式，以及学习 Unidbg 补环境的内容。</p>
<h3 id="三、初始化"><a href="#三、初始化" class="headerlink" title="三、初始化"></a>三、初始化</h3><p>首先搭一个基本架子</p>
<pre><code class="language-java">package com.test4;

import com.github.unidbg.AndroidEmulator;
import com.github.unidbg.arm.backend.Unicorn2Factory;
import com.github.unidbg.linux.android.AndroidEmulatorBuilder;
import com.github.unidbg.linux.android.AndroidResolver;
import com.github.unidbg.linux.android.dvm.AbstractJni;
import com.github.unidbg.linux.android.dvm.DalvikModule;
import com.github.unidbg.linux.android.dvm.DvmClass;
import com.github.unidbg.linux.android.dvm.VM;
import com.github.unidbg.memory.Memory;

import java.io.File;

public class TEST4 extends AbstractJni &#123;
    private final AndroidEmulator emulator;
    private final DvmClass SIUACollector;
    private final VM vm;

    public TEST4() &#123;
        emulator = AndroidEmulatorBuilder
                .for32Bit()
                .addBackendFactory(new Unicorn2Factory(true))
                .setProcessName(&quot;com.dianping.v1&quot;)
                .build();
        Memory memory = emulator.getMemory();
        memory.setLibraryResolver(new AndroidResolver(23));
        vm = emulator.createDalvikVM(new File(&quot;E:\\AndroidTools\\unidbg\\unidbg-android\\src\\test\\java\\com\\test4\\dazhongdianping.apk&quot;));
        vm.setJni(this);
        vm.setVerbose(true);
        DalvikModule dm = vm.loadLibrary(&quot;mtguard&quot;, true);
        SIUACollector = vm.resolveClass(&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector&quot;);
        dm.callJNI_OnLoad(emulator);

    &#125;
    
    public static void main(String[] args) &#123;
        TEST4 test4 = new TEST4();
    &#125;
    
&#125;
</code></pre>
<p>内部类和外部类之间用过 <strong>$</strong> 分割，这是 Java 中固定的表示法。</p>
<p>运行看到报错</p>
<pre><code class="language-shell">[10:57:05 459]  INFO [com.github.unidbg.linux.AndroidElfLoader] (AndroidElfLoader:481) - libmtguard.so load dependency libandroid.so failed
[10:57:05 472]  INFO [com.github.unidbg.linux.AndroidElfLoader] (AndroidElfLoader:481) - libmtguard.so load dependency libjnigraphics.so failed
JNIEnv-&gt;FindClass(com/meituan/android/common/mtguard/NBridge) was called from RX@0x1200545d[libmtguard.so]0x545d
JNIEnv-&gt;RegisterNatives(com/meituan/android/common/mtguard/NBridge, RW@0x120d0004[libmtguard.so]0xd0004, 1) was called from RX@0x120054c7[libmtguard.so]0x54c7
RegisterNative(com/meituan/android/common/mtguard/NBridge, main(I[Ljava/lang/Object;)[Ljava/lang/Object;, RX@0x1205c589[libmtguard.so]0x5c589)
JNIEnv-&gt;FindClass(com/meituan/android/common/mtguard/NBridge$SIUACollector) was called from RX@0x12005591[libmtguard.so]0x5591
JNIEnv-&gt;RegisterNatives(com/meituan/android/common/mtguard/NBridge$SIUACollector, RW@0x122d205c, 10) was called from RX@0x120055c7[libmtguard.so]0x55c7
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getHWProperty()Ljava/lang/String;, RX@0x1200a931[libmtguard.so]0xa931)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getEnvironmentInfoExtra()Ljava/lang/String;, RX@0x12007111[libmtguard.so]0x7111)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getEnvironmentInfo()Ljava/lang/String;, RX@0x12006df9[libmtguard.so]0x6df9)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getHWStatus()Ljava/lang/String;, RX@0x1201a86d[libmtguard.so]0x1a86d)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getHWEquipmentInfo()Ljava/lang/String;, RX@0x12028841[libmtguard.so]0x28841)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getExternalEquipmentInfo()Ljava/lang/String;, RX@0x120353f5[libmtguard.so]0x353f5)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getUserAction()Ljava/lang/String;, RX@0x12040159[libmtguard.so]0x40159)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getPlatformInfo()Ljava/lang/String;, RX@0x120464e1[libmtguard.so]0x464e1)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, getLocationInfo()Ljava/lang/String;, RX@0x1204f909[libmtguard.so]0x4f909)
RegisterNative(com/meituan/android/common/mtguard/NBridge$SIUACollector, startCollection()Ljava/lang/String;, RX@0x1205ab41[libmtguard.so]0x5ab41)
</code></pre>
<p>加载 libandroid.so、libjnigraphics.so 失败，前面我们提过它俩的虚拟模块。</p>
<pre><code class="language-Java">public TEST4() &#123;
        emulator = AndroidEmulatorBuilder
                .for32Bit()
                .addBackendFactory(new Unicorn2Factory(true))
                .setProcessName(&quot;com.dianping.v1&quot;)
                .build();
        Memory memory = emulator.getMemory();
        memory.setLibraryResolver(new AndroidResolver(23));
        vm = emulator.createDalvikVM(new File(&quot;E:\\AndroidTools\\unidbg\\unidbg-android\\src\\test\\java\\com\\test4\\dazhongdianping.apk&quot;));
        vm.setJni(this);
        vm.setVerbose(true);
        
        // 使用 libandroid.so 的虚拟模块
        new AndroidModule(emulator, vm).register(memory);
        // 使用 libjnigraphics.so 的虚拟模块
        new JniGraphics(emulator, vm).register(memory);
        
        DalvikModule dm = vm.loadLibrary(&quot;mtguard&quot;, true);
        SIUACollector = vm.resolveClass(&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector&quot;);
        dm.callJNI_OnLoad(emulator);

    &#125;
</code></pre>
<p>再次运行就不会报依赖库缺少的错误了，Unidbg 目前一共实现有以下几个虚拟模块。<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250810110108107.png" alt="image-20250810110108107"></p>
<h3 id="四、getEnvironmentInfo"><a href="#四、getEnvironmentInfo" class="headerlink" title="四、getEnvironmentInfo"></a>四、getEnvironmentInfo</h3><p>这十个函数都是实例方法，为了免于重复 <strong>newObject</strong>，将 <strong>SIUACollector</strong> 处理为 DvmObject。同时，添加对文件访问的拦截处理，样本可能有文件操作。</p>
<pre><code class="language-Java">package com.test4;

import com.github.unidbg.AndroidEmulator;
import com.github.unidbg.Emulator;
import com.github.unidbg.arm.backend.Unicorn2Factory;
import com.github.unidbg.file.FileResult;
import com.github.unidbg.file.IOResolver;
import com.github.unidbg.linux.android.AndroidEmulatorBuilder;
import com.github.unidbg.linux.android.AndroidResolver;
import com.github.unidbg.linux.android.dvm.*;
import com.github.unidbg.memory.Memory;
import com.github.unidbg.virtualmodule.android.AndroidModule;
import com.github.unidbg.virtualmodule.android.JniGraphics;

import java.io.File;

public class TEST4 extends AbstractJni implements IOResolver &#123;
    private final AndroidEmulator emulator;
    private final DvmObject&lt;?&gt; SIUACollector;
    private final VM vm;

    public TEST4() &#123;
        emulator = AndroidEmulatorBuilder
                .for32Bit()
                .addBackendFactory(new Unicorn2Factory(true))
                .setProcessName(&quot;com.dianping.v1&quot;)
                .build();
        Memory memory = emulator.getMemory();
        memory.setLibraryResolver(new AndroidResolver(23));
        vm = emulator.createDalvikVM(new File(&quot;E:\\AndroidTools\\unidbg\\unidbg-android\\src\\test\\java\\com\\test4\\dazhongdianping.apk&quot;));
        vm.setJni(this);
        vm.setVerbose(true);

        emulator.getSyscallHandler().addIOResolver(this);

        // 使用 libandroid.so 的虚拟模块
        new AndroidModule(emulator, vm).register(memory);
        // 使用 libjnigraphics.so 的虚拟模块
        new JniGraphics(emulator, vm).register(memory);

        DalvikModule dm = vm.loadLibrary(&quot;mtguard&quot;, true);
        SIUACollector = vm.resolveClass(&quot;com/meituan/android/common/mtguard/NBridge$SIUACollector&quot;).newObject(null);
        dm.callJNI_OnLoad(emulator);

    &#125;

    @Override
    public FileResult resolve(Emulator emulator, String pathname, int oflags) &#123;
        System.out.println(&quot;lilac open: &quot; + pathname);
        return null;
    &#125;

    public static void main(String[] args) &#123;
        TEST4 test4 = new TEST4();
        System.out.println(&quot;[*] getEnvironmentInfo:&quot; + test4.getEnvironmentInfo());
    &#125;


&#125;
</code></pre>
<p>发起对 getEnvironmentInfo 的调用</p>
<pre><code class="language-Java">    public static void main(String[] args) &#123;
        TEST4 test4 = new TEST4();
        System.out.println(&quot;[*] getEnvironmentInfo:&quot; + test4.getEnvironmentInfo());
    &#125;


    public String getEnvironmentInfo() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getEnvironmentInfo()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;
</code></pre>
<p>运行发现直接得出了结果，无需补环境。</p>
<pre><code class="language-shell">JNIEnv-&gt;NewStringUTF(&quot;0|0|0|-|0|&quot;) was called from RX@0x12006f5f[libmtguard.so]0x6f5f
JNIEnv-&gt;NewStringUTF(&quot;0|0|0|-|0|&quot;) was called from RX@0x12006ef7[libmtguard.so]0x6ef7
[*] getEnvironmentInfo:0|0|0|-|0|
</code></pre>
<h3 id="五、getEnvironmentInfoExtra"><a href="#五、getEnvironmentInfoExtra" class="headerlink" title="五、getEnvironmentInfoExtra"></a>五、getEnvironmentInfoExtra</h3><p>发起调用</p>
<pre><code class="language-Java">    public static void main(String[] args) &#123;
        TEST4 test4 = new TEST4();
        System.out.println(&quot;[*] getEnvironmentInfo:&quot; + test4.getEnvironmentInfo());
        System.out.println(&quot;[*] getEvironmentInfoExtra:&quot; + test4.getEvironmentInfoExtra());
    &#125;


    public String getEnvironmentInfo() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getEnvironmentInfo()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;
    public String getEvironmentInfoExtra() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getEnvironmentInfoExtra()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;
</code></pre>
<p>运行发现报错，需要开始补环境了</p>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250810113618928.png" alt="image-20250810113618928"></p>
<p>分配一个 <strong>StringBuilder</strong> 对象。对 <strong>allocObject</strong> 这个 JNI 调用感到陌生，上网查了下，它用于分配对象，我们可以在 AbstractJNI 中得到参考。</p>
<pre><code class="language-java">    @Override
    public DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;
        if (&quot;java/util/HashMap-&gt;allocObject&quot;.equals(signature)) &#123;
            return dvmClass.newObject(new HashMap&lt;&gt;());
        &#125;

        throw new UnsupportedOperationException(signature);
    &#125;
</code></pre>
<p>同理处理</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;
        switch (signature) &#123;
            case &quot;java/lang/StringBuilder-&gt;allocObject&quot;: &#123;
                return dvmClass.newObject(new StringBuilder());
            &#125;
        &#125;
        return super.allocObject(vm, dvmClass, signature);
    &#125;
</code></pre>
<p>但是按照前文所讨论的规范，StringBuilder 是 JDK 中的类库，使用 <strong>ProxyDvmObject.createObject</strong> 更好。</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;
        switch (signature) &#123;
            case &quot;java/lang/StringBuilder-&gt;allocObject&quot;: &#123;
                return ProxyDvmObject.createObject(vm, new StringBuilder());
            &#125;
        &#125;
        return super.allocObject(vm, dvmClass, signature);
    &#125;
</code></pre>
<p>继续运行，报错<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250810114335805.png" alt="image-20250810114335805"></p>
<p>刚分配的 <strong>StringBuilder</strong> 对象，这里在做初始化，什么都不必处理。</p>
<pre><code class="language-Java">    @Override
    public void callVoidMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;java/lang/StringBuilder-&gt;&lt;init&gt;()V&quot;: &#123;
                return;
            &#125;
        &#125;
        super.callVoidMethodV(vm, dvmObject, signature, vaList);
    &#125;
</code></pre>
<p>其实 Unidbg 在 <strong>allocObject</strong> 这个 JNI 方法上的处理逻辑不太好，这里还没体现出来，后面再说。</p>
<p>继续运行和报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>这个方法就是我们上一个补的 <strong>getEnvironmentInof</strong>，你可能觉得像下面这样处理就好了</p>
<pre><code class="language-Java">@Override
public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
    switch (signature)&#123;
        case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;&quot;:&#123;
            return new StringObject(vm, getEnvironmentInfo());
        &#125;
    &#125;
    return super.callObjectMethodV(vm, dvmObject, signature, vaList);
&#125;
</code></pre>
<p>但事实上这是行不通的，Native 方法里调用另一个 Native 方法，这属于嵌套调用，Unidbg 暂不支持这么做，所以这里手动填入先前得到的结果，</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;0|0|0|-|0|&quot;);
            &#125;
        &#125;
        return super.callObjectMethodV(vm, dvmObject, signature, vaList);
    &#125;
</code></pre>
<p>继续运行和报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:97)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>按照语义补 append 方法</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getEnvironmentInfo()Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;0|0|0|-|0|&quot;);
            &#125;
            case &quot;java/lang/StringBuilder-&gt;append(Ljava/lang/String;)Ljava/lang/StringBuilder;&quot;: &#123;
                String str = vaList.getObjectArg(0).getValue().toString();
                return ProxyDvmObject.createObject(vm, ((StringBuilder) dvmObject.getValue()).append(str));
            &#125;
        &#125;
        return super.callObjectMethodV(vm, dvmObject, signature, vaList);
    &#125;
</code></pre>
<p>继续运行和报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isVPN()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:101)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>看起来是用于检测 VPN，<strong>Jadx</strong> 中看看它的实现，样本采用了自家的热修复技术<img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/favicon.ico" alt="img"><a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/09/14/android-robust.html">Android热更新方案 Robust</a>，代码看起来不太舒服。</p>
<pre><code class="language-JAVA">        private String isVPN() &#123;
            Object[] objArr = new Object[0];
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            return PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;b6362e66d9b10061bc6c2e73cafc0cc8&quot;, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;b6362e66d9b10061bc6c2e73cafc0cc8&quot;) : EnvInfoWorker.isVPN();
        &#125;
</code></pre>
<p>末尾的 <strong>EnvInfoWorker.isVPN()</strong> 是其实现函数。</p>
<pre><code class="language-Java">public static synchronized String isVPN() &#123;
    synchronized (EnvInfoWorker.class) &#123;
        Object[] objArr = new Object[0];
        ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
        if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;b5d91cd54a8036812d448963f1a976c9&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
            return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;b5d91cd54a8036812d448963f1a976c9&quot;);
        &#125;
        Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();
        if (networkInterfaces == null) &#123;
            return &quot;0&quot;;
        &#125;
        Iterator it = Collections.list(networkInterfaces).iterator();
        while (it.hasNext()) &#123;
            NetworkInterface networkInterface = (NetworkInterface) it.next();
            if (networkInterface.isUp()) &#123;
                if (networkInterface.getInterfaceAddresses().size() != 0 &amp;&amp; &quot;tun0&quot;.equals(networkInterface.getName())) &#123;
                    return &quot;1&quot;;
                &#125;
            &#125;
            if (&quot;ppp0&quot;.equals(networkInterface.getName())) &#123;
                return &quot;1&quot;;
            &#125;
        &#125;
        return &quot;0&quot;;
    &#125;
&#125;
</code></pre>
<p>问了下 chatGPT，当客户端运行 <strong>VPN</strong> 时，会创建 <strong>tun0</strong> 或 <strong>ppp0</strong> 节点，所以出现带有明显特征的网络接口名称，就可以认定是使用了 <strong>VPN</strong> 协议进行通信。示例代码如下</p>
<pre><code class="language-Java">private void isDeviceInVPN() &#123;
    try &#123;
        Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();
        while (networkInterfaces.hasMoreElements()) &#123;
            String name = networkInterfaces.nextElement().getName();
            if (name.equals(&quot;tun0&quot;) || name.equals(&quot;ppp0&quot;)) &#123;
                stop();
            &#125;
        &#125;
    &#125; catch (SocketException e) &#123;
        e.printStackTrace();
    &#125;
&#125;
</code></pre>
<p>和样本此处进行对照，可以发现返回 0 是没检测到，返回 1 就是检测到了。</p>
<p>读者可能想图方便，使用 Frida 在真实设备上 Hook 或 Call 这个函数，直接获得结果。但这么做有弊端，如果你真机使用了 VPN，那么就会返回 1.</p>
<pre><code class="language-Java">            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isVPN()Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;0&quot;);
            &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;mContext:Landroid/content/Context;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:171)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:141)
	at com.github.unidbg.linux.android.dvm.DvmField.getObjectField(DvmField.java:126)
	at com.github.unidbg.linux.android.dvm.DalvikVM$92.handle(DalvikVM.java:1408)
</code></pre>
<p>Context 是一个相当特殊的对象，前面遇到过它，这里我们先用最朴素的方法去处理它——<strong>resolveClass</strong> 占位。</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; getObjectField(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;mContext:Landroid/content/Context;&quot;: &#123;
                return vm.resolveClass(&quot;android/content/Context&quot;).newObject(null);
            &#125;
        &#125;
        return super.getObjectField(vm, dvmObject, signature);
    &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;brightness(Landroid/content/Context;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:104)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>回到 <strong>Jadx</strong> 中找到对应函数</p>
<pre><code class="language-Java">        private String brightness(Context context) &#123;
            Object[] objArr = &#123;context&#125;;
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            return PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;e3c10305f195ff2aac2fd606a6235fb2&quot;, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;e3c10305f195ff2aac2fd606a6235fb2&quot;) : DeviceInfoWorker.brightness(context);
        &#125;
</code></pre>
<pre><code class="language-Java">    public static String brightness(Context context) &#123;
        Object[] objArr = &#123;context&#125;;
        ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
        if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;af80a1c664fdf95866b7caabf24ab495&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
            return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;af80a1c664fdf95866b7caabf24ab495&quot;);
        &#125;
        try &#123;
            return StringUtils.toString(Settings.System.getInt(context.getContentResolver(), &quot;screen_brightness&quot;) / 255.0f);
        &#125; catch (Throwable th) &#123;
            c.a(th);
            return StringUtils.toString(0.0f);
        &#125;
    &#125;
</code></pre>
<p>从函数名和基本逻辑上看，似乎是获取屏幕亮度，Google 搜索 <strong>getContentResolver</strong> + <strong>screen_brightness</strong></p>
<p>，找到如下代码</p>
<pre><code class="language-Java">/**
 * 获取系统默认屏幕亮度值 屏幕亮度值范围（0-255）
 * **/
private int getScreenBrightness(Context context) &#123;
    ContentResolver contentResolver = context.getContentResolver();
    int defVal = 0;
    return Settings.System.getInt(contentResolver,
            Settings.System.SCREEN_BRIGHTNESS, defVal);
&#125;
</code></pre>
<p>样本中返回的是 0 - 1 之间的一个数，然后转字符串，我这里选择 0.8</p>
<pre><code class="language-Java">            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;brightness(Landroid/content/Context;)Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;0.8&quot;);
            &#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-Java">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;systemVolume(Landroid/content/Context;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:107)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>也还是一样回到 <strong>Jadx</strong> 中查看样本的伪代码，这里是获取音量</p>
<pre><code class="language-Java">        private String systemVolume(Context context) &#123;
            Object[] objArr = &#123;context&#125;;
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            return PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;25bed8eb997e1fc4de8fea79d40481a3&quot;, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;25bed8eb997e1fc4de8fea79d40481a3&quot;) : DeviceInfoWorker.systemVolume(context);
        &#125;
</code></pre>
<pre><code class="language-Java">    public static String systemVolume(Context context) &#123;
        Object[] objArr = &#123;context&#125;;
        ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
        if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;94db8653238995da6df94fea33fbbf79&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
            return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;94db8653238995da6df94fea33fbbf79&quot;);
        &#125;
        try &#123;
            AudioManager audioManager = (AudioManager) context.getSystemService(&quot;audio&quot;);
            return StringUtils.toString((audioManager.getStreamVolume(1) * 100) / audioManager.getStreamMaxVolume(1));
        &#125; catch (Throwable th) &#123;
            c.a(th);
            return &quot;&quot;;
        &#125;
    &#125;
</code></pre>
<p>直接返回 0，也就是静音</p>
<pre><code class="language-Java">            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;systemVolume(Landroid/content/Context;)Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;0&quot;);
            &#125;
</code></pre>
<p>继续运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isAccessibilityEnable()Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodA(DvmMethod.java:124)
</code></pre>
<p>这次是 <strong>isAccessibilityEnable</strong> ，也就是所谓的无障碍服务。无障碍服务的本意是帮助残疾人士、老人、小孩等，但长久以来被用于自动化控制，比如抢单，因此无障碍服务是风险检测、环境检测、反欺诈检测的重要一环。</p>
<pre><code class="language-Java">    @Override
    public boolean callBooleanMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isAccessibilityEnable()Z&quot;: &#123;
                return false;
            &#125;
        &#125;
        return super.callBooleanMethodV(vm, dvmObject, signature, vaList);
    &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;valueOf(I)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:504)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:438)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callStaticObjectMethodA(DvmMethod.java:64)
</code></pre>
<p>这个没什么问题，也是直接参照语义直接补就好了</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; callStaticObjectMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;java/lang/String-&gt;valueOf(I)Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, String.valueOf(vaList.getIntArg(0)));
            &#125;
        &#125;
        return super.callStaticObjectMethodV(vm, dvmClass, signature, vaList);
    &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;uiAutomatorClickCount()I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callIntMethodA(DvmMethod.java:134)
</code></pre>
<p><strong>uiAutomatorClickCount</strong> 的具体实现如下</p>
<pre><code class="language-Java">    public static int uiAutomatorClickCount() &#123;
        Object[] objArr = new Object[0];
        ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
        if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;7e55945fa3fd311f57ffc508c34fa364&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
            return ((Integer) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;7e55945fa3fd311f57ffc508c34fa364&quot;)).intValue();
        &#125;
        if (verify()) &#123;
            return mAdapter.uiAutomatorCount();
        &#125;
        return 0;
    &#125;
</code></pre>
<p>这个类的主要作用是返回 <strong>UI Automator 点击次数</strong>，可以Frida Hook 看一下</p>
<pre><code class="language-js">Java.perform(function() &#123;
    let SIUACollector = Java.use(&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;);
    SIUACollector[&quot;uiAutomatorClickCount&quot;].implementation = function () &#123;
        console.log(&#39;uiAutomatorClickCount is called&#39;);
        let ret = this.uiAutomatorClickCount();
        console.log(&#39;uiAutomatorClickCount ret value is &#39; + ret);
        return ret;
    &#125;;
&#125;)
</code></pre>
<p>结果如下</p>
<pre><code class="language-shell">uiAutomatorClickCount ret value is 0
</code></pre>
<p>那么就可以补环境了</p>
<pre><code class="language-Java">    @Override
    public int callIntMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;uiAutomatorClickCount()I&quot;: &#123;
                return 0;
            &#125;
        &#125;
        return super.callIntMethodV(vm, dvmObject, signature, vaList);
    &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;toString()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:110)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/lang/StringBuilder-&gt;toString()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, dvmObject.getValue().toString());
&#125;
</code></pre>
<p>运行，终于跑通了</p>
<pre><code class="language-shell">[*] getEvironmentInfoExtra:0|0|0|-|0|0|0.8|0|0|0|
</code></pre>
<p>这个结果和上一个结果一样，有很多 0，看起来就像是收集信息，然后使用 <strong>|</strong> 作为分割并拼接起来。</p>
<h3 id="六、getExtrarnalEquipmentInfo"><a href="#六、getExtrarnalEquipmentInfo" class="headerlink" title="六、getExtrarnalEquipmentInfo"></a>六、getExtrarnalEquipmentInfo</h3><p>新增对它的call</p>
<pre><code class="language-Java">    public static void main(String[] args) &#123;
        TEST4 test4 = new TEST4();
        System.out.println(&quot;[*] getEnvironmentInfo:&quot; + test4.getEnvironmentInfo());
        System.out.println(&quot;[*] getEvironmentInfoExtra:&quot; + test4.getEnvironmentInfoExtra());
        System.out.println(&quot;[*] getExtrernalEquipmentInfo:&quot; + test4.getExternalEquipmentInfo());
    &#125;


    public String getEnvironmentInfo() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getEnvironmentInfo()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;
    public String getEnvironmentInfoExtra() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getEnvironmentInfoExtra()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;

    public String getExternalEquipmentInfo() &#123;
        String result = SIUACollector.callJniMethodObject(emulator, &quot;getExternalEquipmentInfo()Ljava/lang/String;&quot;).getValue().toString();
        return result;
    &#125;
</code></pre>
<p>运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/Context-&gt;getApplicationContext()Landroid/content/Context;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:210)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>简单占位</p>
<pre><code class="language-Java">case &quot;android/content/Context-&gt;getApplicationContext()Landroid/content/Context;&quot;:&#123;
    return vm.resolveClass(&quot;android/content/Context&quot;).newObject(null);
&#125;
</code></pre>
<p>运行，继续报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/Context-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:210)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>系统服务是 Android 所提供的一项重要服务，在 JNI 补环境中出现频率相当高，Unidbg 对它做了专门处理，可以参考 AbstractJni，其中有如下片段</p>
<pre><code class="language-Java">            case &quot;android/app/Application-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;&quot;: &#123;
                StringObject serviceName = vaList.getObjectArg(0);
                assert serviceName != null;
                return new SystemService(vm, serviceName.getValue());
            &#125;
</code></pre>
<p>抄一下</p>
<pre><code class="language-Java">case &quot;android/content/Context-&gt;getSystemService(Ljava/lang/String;)Ljava/lang/Object;&quot;:&#123;
    StringObject serviceName = vaList.getObjectArg(0);
    assert serviceName != null;
    return new SystemService(vm, serviceName.getValue());
&#125;
</code></pre>
<p>继续运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:230)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodA(DvmMethod.java:124)
</code></pre>
<p>isPermissionGranted 具体什么作用？根据函数名、函数实现可以看出，就是大致用来检测 App 是否有某项权限。</p>
<pre><code class="language-Java">        private boolean isPermissionGranted(String str, Context context) &#123;
            Object[] objArr = &#123;str, context&#125;;
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            return PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;a0fa204a6b6694d5ab23ad161583721d&quot;, RobustBitConfig.DEFAULT_VALUE) ? ((Boolean) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;a0fa204a6b6694d5ab23ad161583721d&quot;)).booleanValue() : Permissions.isPermissionGranted(str, context);
        &#125;
</code></pre>
<pre><code class="language-Java">    public static boolean isPermissionGranted(String str, Context context) &#123;
        Object[] objArr = &#123;str, context&#125;;
        ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
        if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;44db3326d9c0bbe25993cff8771e9a68&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
            return ((Boolean) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;44db3326d9c0bbe25993cff8771e9a68&quot;)).booleanValue();
        &#125;
        try &#123;
            return Build.VERSION.SDK_INT &gt;= 23 ? context.getApplicationContext().getApplicationInfo().targetSdkVersion &gt;= 23 ? context.checkSelfPermission(str) == 0 : PermissionChecker.a(context, str) == 0 : PermissionChecker.a(context, str) == 0;
        &#125; catch (Throwable th) &#123;
            c.a(th);
            DFPLog.error(th);
            return false;
        &#125;
    &#125;
</code></pre>
<p>打印一下当前调用的参数。</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z&quot;:&#123;
    String permissionName = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;[!] check permission:&quot;+permissionName);
&#125;
</code></pre>
<p>运行查看输出</p>
<pre><code>[!] check permission: android.permission.READ_PHONE_STATE
</code></pre>
<p>这个权限很明显了，就是 “允许访问电话状态权限”，直接返回 True</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z&quot;:&#123;
    String permissionName = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;check permission:&quot;+permissionName);
    if(permissionName.equals(&quot;android.permission.READ_PHONE_STATE&quot;))&#123;
        return true;
    &#125;else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build$VERSION-&gt;SDK_INT:I
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticIntField(AbstractJni.java:136)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticIntField(AbstractJni.java:128)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticIntField(DvmField.java:121)
	at com.github.unidbg.linux.android.dvm.DalvikVM$147.handle(DalvikVM.java:2358)
</code></pre>
<p>这里是在获取 SDK 的版本，直接返回目前常见的 Android 15，即 35</p>
<pre><code class="language-Java">    @Override
    public int getStaticIntField(BaseVM vm, DvmClass dvmClass, String signature) &#123;
        switch (signature) &#123;
            case &quot;android/os/Build$VERSION-&gt;SDK_INT:I&quot;: &#123;
                return 35;
            &#125;
        &#125;
        return super.getStaticIntField(vm, dvmClass, signature);
    &#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;checkBuildAttribute(Ljava/lang/String;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:208)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>先打印一下参数，看看是啥</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;checkBuildAttribute(Ljava/lang/String;)Ljava/lang/String;&quot;: &#123;
                String arg = vaList.getObjectArg(0).getValue().toString();
                System.out.println(&quot;[!] checkBuildAttribute: &quot; + arg);
            &#125;
</code></pre>
<p>运行，但是这个参数不知道是啥</p>
<pre><code class="language-shell">[!] checkBuildAttribute: -
</code></pre>
<p>所以还是 <strong>Jadx</strong> 看看伪代码吧</p>
<pre><code class="language-Java">        private String checkBuildAttribute(String str) &#123;
            Object[] objArr = &#123;str&#125;;
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            return PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;3b097946787cf593049f918e4d2f8a4e&quot;, RobustBitConfig.DEFAULT_VALUE) ? (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;3b097946787cf593049f918e4d2f8a4e&quot;) : (TextUtils.isEmpty(str) || str.equalsIgnoreCase(&quot;unknown&quot;)) ? CommonConstant.Symbol.MINUS : str;
        &#125;
</code></pre>
<p>前面就是常规的热修复判断，后面就是做简单的字符串校验，若字符串为空或是 <code>&quot;unknown&quot;</code>，返回 <code>&quot;-&quot;</code>；否则返回字符串本身。</p>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;checkBuildAttribute(Ljava/lang/String;)Ljava/lang/String;&quot;:&#123;
    String arg = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;checkBuildAttribute:&quot;+arg);
    return new StringObject(vm, arg.isEmpty() || arg.equalsIgnoreCase(&quot;unknown&quot;) ? &quot;-&quot; : arg);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/view/WindowManager-&gt;getDefaultDisplay()Landroid/view/Display;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:213)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>这是一个 Android 对象，按照前面所说的补环境原则直接处理。</p>
<pre><code class="language-Java">case &quot;android/view/WindowManager-&gt;getDefaultDisplay()Landroid/view/Display;&quot;:&#123;
    return vm.resolveClass(&quot;android/view/Display&quot;).newObject(null);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/view/Display-&gt;getHeight()I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:273)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callIntMethodA(DvmMethod.java:134)
</code></pre>
<p>又是 Android FrameWork 层的 API，拷打了下 chatGPT，它和 <strong>getWidth</strong></p>
<p>一起用于获取屏幕的宽高。对于这类基本设备信息，完全可以通过 ADB 获取。</p>
<pre><code class="language-shell">└─Δ adb shell wm size
Physical size: 1080x2400
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;android/view/Display-&gt;getHeight()I&quot;:&#123;
    return 2400;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:416)
	at com.dianping.NBridge.callObjectMethodV(NBridge.java:139)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">            case &quot;java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;&quot;: &#123;
                int value = vaList.getIntArg(0); // 直接取 int
                ((StringBuilder) dvmObject.getValue()).append(value); // 自动转成字符串拼接
                return dvmObject; // append 返回 this
            &#125;
</code></pre>
<p>继续补环境</p>
<pre><code class="language-Java">case &quot;java/lang/StringBuilder-&gt;append(C)Ljava/lang/StringBuilder;&quot;:&#123;
    return ProxyDvmObject.createObject(vm, ((StringBuilder) dvmObject.getValue()).append((char)vaList.getIntArg(0)));
&#125;
</code></pre>
<p>遇到新报错，刚刚补过高，现在补的是宽</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/view/Display-&gt;getWidth()I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:279)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
</code></pre>
<p>依旧是根据上面 adb 获取的值进行补</p>
<pre><code class="language-Java">case &quot;android/view/Display-&gt;getWidth()I&quot;:&#123;
    return 1080;
&#125;
</code></pre>
<p>运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalInternalMemorySize()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:219)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p><strong>getTotalInternalMemorySize</strong> 这个函数名就很清晰直白，再看看代码逻辑验证一下</p>
<pre><code class="language-Java">        private String getTotalInternalMemorySize() &#123;
            Object[] objArr = new Object[0];
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;838e88ccfd19d138e498f2d967b7d987&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
                return (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;838e88ccfd19d138e498f2d967b7d987&quot;);
            &#125;
            StatFs statFs = new StatFs(Environment.getDataDirectory().getPath());
            return fileSize(statFs.getBlockCount() * statFs.getBlockSize());
        &#125;
</code></pre>
<p>这个逻辑就很简单，<strong>Environment.getDataDirectory()</strong> 就是 data 文件夹，它是存储的根目录。<strong>StatFs</strong> 底层对应于 stat 结构体</p>
<pre><code class="language-c++">struct stat &#123;
    dev_t     st_dev;     /* ID of device containing file */
    ino_t     st_ino;     /* inode number */
    mode_t    st_mode;    /* protection */
    nlink_t   st_nlink;   /* number of hard links */
    uid_t     st_uid;     /* user ID of owner */
    gid_t     st_gid;     /* group ID of owner */
    dev_t     st_rdev;    /* device ID (if special file) */
    off_t     st_size;    /* total size, in bytes */
    blksize_t st_blksize; /* blocksize for file system I/O */
    blkcnt_t  st_blocks;  /* number of 512B blocks allocated */
    time_t    st_atime;   /* time of last access */
    time_t    st_mtime;   /* time of last modification */
    time_t    st_ctime;   /* time of last status change */
&#125;;
</code></pre>
<p>这里是 <strong>st_blksize * st_blocks</strong>，返回 data 文件夹的实际大小，单位是 <strong>Bit</strong>。在 Native 代码实现也经常是这个逻辑。最后看 <strong>fileSize</strong> 函数的实现，它将很大的比特值转为更为直观和合适的 <strong>MB</strong> 和 <strong>GB</strong>。</p>
<pre><code class="language-Java">        private String fileSize(long j) &#123;
            Object[] objArr = &#123;new Long(j)&#125;;
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;6a69a740a4e2f5966b7d134666227a92&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
                return (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;6a69a740a4e2f5966b7d134666227a92&quot;);
            &#125;
            StringBuilder sb = new StringBuilder();
            String str = &quot;&quot;;
            if (j &gt;= 1024) &#123;
                str = &quot;KB&quot;;
                j /= 1024;
                if (j &gt;= 1024) &#123;
                    str = &quot;MB&quot;;
                    j /= 1024;
                    if (j &gt;= 1024) &#123;
                        str = &quot;GB&quot;;
                        j /= 1024;
                    &#125;
                &#125;
            &#125;
            sb.append(j);
            sb.append(str);
            return sb.toString();
        &#125;
</code></pre>
<p>这里直接通过 Frida Call 获取这个值。</p>
<pre><code class="language-js">function callSIUACollector() &#123;
  setTimeout(function () &#123;
    Java.perform(function () &#123;
      const ActivityThread = Java.use(&quot;android.app.ActivityThread&quot;);
      let context = ActivityThread.currentApplication().getApplicationContext();
      const ContextClass = Java.use(&quot;android.content.Context&quot;);
      const ctx = Java.cast(context, ContextClass);

      let SIUACollector = Java.use(
        &quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;
      );
      // 传context创建实例
      let instance = SIUACollector.$new(ctx);

      let result = instance.getTotalInternalMemorySize();
      console.log(&quot;ret: &quot; + result);
    &#125;);
  &#125;, 3000);
&#125;
callSIUACollector();
</code></pre>
<p>我的测试机跑下来是 226GB</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalInternalMemorySize()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;226GB&quot;);
&#125;
</code></pre>
<p>运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalExternalMemorySize()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:222)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>那么看看 <strong>getTotalExternalMemorySize</strong> 具体实现</p>
<pre><code class="language-Java">
        private String getTotalExternalMemorySize() &#123;
            Object[] objArr = new Object[0];
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;522b1633753f28d5eb161a6c3ff3faa1&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
                return (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;522b1633753f28d5eb161a6c3ff3faa1&quot;);
            &#125;
            try &#123;
                if (!Environment.getExternalStorageState().equals(&quot;mounted&quot;)) &#123;
                    return &quot;&quot;;
                &#125;
                StatFs statFs = new StatFs(Environment.getExternalStorageDirectory().getPath());
                return fileSize(statFs.getBlockCount() * statFs.getBlockSize());
            &#125; catch (Exception e) &#123;
                c.a(e);
                MTGuardLog.error(e);
                return &quot;&quot;;
            &#125;
        &#125;
</code></pre>
<p>这段代码实现了 <strong>获取外部存储总容量</strong> 的功能，<strong>Environment.getExternalStorageDirectory().getPath()</strong> 获取外部存储的路径，同样的采取 Frida call 一下</p>
<pre><code class="language-js">function callSIUACollector() &#123;
  setTimeout(function () &#123;
    Java.perform(function () &#123;
      const ActivityThread = Java.use(&quot;android.app.ActivityThread&quot;);
      let context = ActivityThread.currentApplication().getApplicationContext();
      const ContextClass = Java.use(&quot;android.content.Context&quot;);
      const ctx = Java.cast(context, ContextClass);

      let SIUACollector = Java.use(
        &quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;
      );
      // 传context创建实例
      let instance = SIUACollector.$new(ctx);

      let result = instance.getTotalExternalMemorySize();
      console.log(&quot;ret: &quot; + result);
    &#125;);
  &#125;, 3000);
&#125;
callSIUACollector();
</code></pre>
<p>结果如下</p>
<pre><code class="language-shell">ret: 226GB
</code></pre>
<p>同样是 226GB </p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getTotalExternalMemorySize()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;226GB&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">[!] check permission: android.permission.ACCESS_WIFI_STATE
[11:18:19 847]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x123, PC=unidbg@0xfffe02c4, LR=RX@0x1203d9a3[libmtguard.so]0x3d9a3, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:251)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodA(DvmMethod.java:124)
</code></pre>
<p>这是在确认是否有访问 WiFi 状态的权限，直接选择返回 True。</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;isPermissionGranted(Ljava/lang/String;Landroid/content/Context;)Z&quot;:&#123;
    String permissionName = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;check permission:&quot;+permissionName);
    if(permissionName.equals(&quot;android.permission.READ_PHONE_STATE&quot;))&#123;
        return true;
    &#125;else if(permissionName.equals(&quot;android.permission.ACCESS_WIFI_STATE&quot;))&#123;
        return true;
    &#125;
    else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/text/TextUtils-&gt;isEmpty(Ljava/lang/CharSequence;)Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticBooleanMethodV(AbstractJni.java:191)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticBooleanMethodV(AbstractJni.java:186)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callStaticBooleanMethodV(DvmMethod.java:184)
</code></pre>
<p>这是 Android FrameWork 中处理字符串的工具类，这种工具函数往往不会很复杂，在 <a target="_blank" rel="noopener" href="http://aospxref.com/android-9.0.0_r61/search?project=frameworks&full=&defs=&refs=&path=TextUtils.java&hist=&type=&xrd=&nn=1">AOSP</a> 中找一下它的实现。(但是目前 Google 官方好像关闭了它的访问)</p>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250813112300853.png" alt="image-20250813112300853"></p>
<p>找到具体实现</p>
<pre><code class="language-Java">public static boolean isEmpty(CharSequence str) &#123;
    return str == null || str.length() == 0;
&#125;
</code></pre>
<p>复写一下</p>
<pre><code class="language-Java">@Override
public boolean callStaticBooleanMethodV(BaseVM vm, DvmClass dvmClass, String signature, VaList vaList) &#123;
    switch (signature)&#123;
        case &quot;android/text/TextUtils-&gt;isEmpty(Ljava/lang/CharSequence;)Z&quot;:&#123;
            String str = vaList.getObjectArg(0).getValue().toString();
            return str == null || str.length() == 0;
        &#125;
    &#125;
    return super.callStaticBooleanMethodV(vm, dvmClass, signature, vaList);
&#125;
</code></pre>
<p>继续运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/telephony/TelephonyManager-&gt;getSimOperator()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:225)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>又是 Android FrameWork 里的函数，Google 找篇文章看下，比如<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/87602090">这篇</a>，得知这是在获取运行商相关的信息。</p>
<p>同样可以通过 ADB 获取得到相关信息</p>
<pre><code class="language-shell">└─Δ adb shell
ares:/ $ getprop | grep sim
[gsm.sim.num.simlock]: []
[gsm.sim.preiccid_0]: []
[gsm.sim.preiccid_1]: []
[gsm.sim.state]: [ABSENT,ABSENT]
[gsm.sim1.num.simlock]: []
[gsm.sim1.type]: []
[gsm.sim2.type]: []
[persist.log.tag.IsimFileHandler]: [I]
[persist.log.tag.IsimRecords]: [I]
[persist.log.tag.MtkCsimFH]: [I]
[persist.log.tag.MtkIsimFH]: [I]
[persist.log.tag.MtkUsimFH]: [I]
[persist.log.tag.VsimAdaptor]: [I]
[persist.radio.multisim.config]: [dsds]
[persist.vendor.radio.msimmode]: [dsds]
[persist.vendor.radio.sim.mode]: [3]
[persist.vendor.radio.simswitch]: [1]
[ril.csim.mlpl_mspl_ver0]: [,]
[ril.csim.mlpl_mspl_ver1]: [,]
[ro.mtk_perf_simple_start_win]: [1]
[ro.vendor.mtk_external_sim_only_slots]: [0]
[ro.vendor.mtk_external_sim_support]: [1]
[ro.vendor.mtk_sim_card_onoff]: [3]
[ro.vendor.radio.max.multisim]: [dsds]
[ro.vendor.sim_me_lock_mode]: [3]
[vendor.gsm.external.sim.connected]: [0]
[vendor.gsm.external.sim.timeout]: [13,13]
[vendor.gsm.modem.vsim.capability]: [2,2]
[vendor.gsm.sim.extended.format1]: [0]
[vendor.gsm.sim.extended.format2]: [0]
[vendor.gsm.sim.retry.pin1]: []
[vendor.gsm.sim.retry.pin1.2]: []
[vendor.gsm.sim.retry.pin2]: []
[vendor.gsm.sim.retry.pin2.2]: []
[vendor.gsm.sim.retry.puk1]: []
[vendor.gsm.sim.retry.puk1.2]: []
[vendor.gsm.sim.retry.puk2]: []
[vendor.gsm.sim.retry.puk2.2]: []
[vendor.gsm.sim.slot.lock.card.valid]: [2]
[vendor.gsm.sim.slot.lock.card.valid.2]: [2]
[vendor.gsm.sim.slot.lock.policy]: [3]
[vendor.gsm.sim.slot.lock.service.capability]: [4]
[vendor.gsm.sim.slot.lock.service.capability.2]: [4]
[vendor.gsm.sim.slot.lock.state]: [0]
[vendor.ril.sim.onoff.support]: [1]
[vendor.ril.sim.uicc.applications.enable.state]: [0]
[vendor.ril.sim.uicc.applications.enable.state.2]: [0]
[vendor.ril.simswitch.no_reset_support]: [1]
[vendor.ril.simswitch.tpluswsupport]: [1]
</code></pre>
<p>但是我的测试机上没插卡，也看不太懂，直接试一下返回一个空字符串，不行再伪造一个。</p>
<p>而如果测试机是有卡的话，是可以采集到值的，返回的值是由 MCC + MNC 组成。</p>
<p><code>MCC</code>由国际电信联盟 ITU 在全世界范围内统一分配和管理，唯一识别移动用户所属的国家，共3位，中国为460。</p>
<p><code>MNC</code>用于识别移动用户所归属的移动通信网，2~3位。中国移动系统使用 00、02、04、07，中国联通系统使用 01、06、09，中国电信使用 03、05、11，中国铁通系统使用 20 。</p>
<pre><code class="language-Java">case &quot;android/telephony/TelephonyManager-&gt;getSimOperator()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;&quot;);
&#125;
</code></pre>
<p>继续运行，发现还真过了，然后报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getAccessSubType()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:226)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
	at com.github.unidbg.linux.android.dvm.DalvikVM$33.handle(DalvikVM.java:578)
</code></pre>
<p>去 <strong>Jadx</strong> 中看看伪代码实现</p>
<pre><code class="language-Java">
        @SuppressLint(&#123;&quot;MissingPermission&quot;&#125;)
        private String getAccessSubType() &#123;
            Object[] objArr = new Object[0];
            ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
            if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;4e473c1fae47c0bf65e6f819cd3eaf7c&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
                return (String) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;4e473c1fae47c0bf65e6f819cd3eaf7c&quot;);
            &#125;
            Context context = this.mContext;
            if (context == null) &#123;
                return StringUtil.NULL;
            &#125;
            if (!isPermissionGranted(&quot;android.permission.ACCESS_NETWORK_STATE&quot;, context)) &#123;
                return CommonConstant.Symbol.MINUS;
            &#125;
            ConnectivityManager connectivityManager = (ConnectivityManager) this.mContext.getApplicationContext().getSystemService(&quot;connectivity&quot;);
            NetworkInfo activeNetworkInfo = connectivityManager != null ? connectivityManager.getActiveNetworkInfo() : null;
            if (activeNetworkInfo == null) &#123;
                return StringUtil.NULL;
            &#125;
            if (activeNetworkInfo.getType() == 1) &#123;
                return &quot;wifi&quot;;
            &#125;
            if (activeNetworkInfo.getType() != 0) &#123;
                return &quot;&quot;;
            &#125;
            int subtype = activeNetworkInfo.getSubtype();
            return (subtype == 4 || subtype == 1 || subtype == 2) ? &quot;2G&quot; : (subtype == 3 || subtype == 8 || subtype == 6 || subtype == 5 || subtype == 12) ? &quot;3G&quot; : subtype == 13 ? &quot;4G&quot; : &quot;&quot;;
        &#125;
</code></pre>
<p>看起来是在获取网络类型</p>
<pre><code class="language-Java">//检测当前的网络模式，可以是：wifi/2G/3G/4G
case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getAccessSubType()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;wifi&quot;);
&#125;
</code></pre>
<p>继续运行，得到结果</p>
<pre><code class="language-shell">[*] getExternalEquipmentInfo:-|-|-|2400421080|226GB|226GB|AQmac|-|wifi|
</code></pre>
<h3 id="七、getHWEquipmentInfo"><a href="#七、getHWEquipmentInfo" class="headerlink" title="七、getHWEquipmentInfo"></a>七、getHWEquipmentInfo</h3><p>首先先初始化发起调用看看报什么错</p>
<pre><code class="language-Java">public String getHWEquipmentInfo()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getHWEquipmentInfo()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getCpuInfoType()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:140)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>去 <strong>Jadx</strong> 中查看对应方法的伪代码</p>
<pre><code class="language-Java">private String getCpuInfoType()&#123;
       Closeable uCloseable;
       Throwable throwable;
       String str1;
       int i = 0;
       Object[] objArray = new Object[i];
       ChangeQuickRedirect changeQuickR = NBridge$SIUACollector.changeQuickRedirect;
       if (PatchProxy.isSupport(objArray, this, changeQuickR, false, &quot;e8c17f92755628eaeec9e7e53ee668d7&quot;, 0x4000000000000000)) &#123;
          return PatchProxy.accessDispatch(objArray, this, changeQuickR, i, &quot;e8c17f92755628eaeec9e7e53ee668d7&quot;);
       &#125;
       String str = &quot;&quot;;
       int i1 = 0;
       try&#123;
          super(new InputStreamReader(new FileInputStream(&quot;/proc/cpuinfo&quot;)));
          try&#123;
             while ((str1 = this.readLine()) != null) &#123;
                if (str1.startsWith(&quot;Processor&quot;)) &#123;
                   str = &quot;arm&quot;;
                   break ;
                &#125;else if(str1.startsWith(&quot;model name&quot;))&#123;
                   str = &quot;x86&quot;;
                   break ;
                &#125;
             &#125;
             this.close();
          label_005e :
             this.safeClose(uCloseable);
             return str;
          &#125;catch(java.lang.Exception e1)&#123;
          &#125;
          c.a(throwable);
          MTGuardLog.error(throwable);
          goto label_005e ;
       &#125;catch(java.lang.Exception e2)&#123;
          uCloseable = i1;
          throwable = e2;
       &#125;
    &#125;
</code></pre>
<p>根据方法名和代码逻辑可知，该方法就是读取 <strong>&#x2F;proc&#x2F;cpuinfo</strong> 文件，根据内容判断 CPU 架构类型(arm&#x2F;x86)，继续补环境</p>
<pre><code class="language-Java">// CPU 架构
case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getCpuInfoType()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;arm&quot;);
&#125;
</code></pre>
<p>运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/BufferedReader-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:93)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
	at com.github.unidbg.linux.android.dvm.DalvikVM$24.handle(DalvikVM.java:365)
</code></pre>
<p>前面也遇到过一个 <strong>allocObject</strong>，你可能想如法炮制</p>
<pre><code class="language-Java">case &quot;java/io/BufferedReader-&gt;allocObject&quot;:&#123;
    return ProxyDvmObject.createObject(vm, new BufferedReader());
&#125;
</code></pre>
<p>但最好不要这么做了，这是有隐患的处理方法。BufferedReader 没有无参构造函数，它所需要的初始化参数在 <strong>allocObject</strong> 阶段并没有展露出来，在后续真正初始化的时候才有值。</p>
<p>这里直接用空的 <strong>dvmObject</strong> 占位，这里的 dvmClass 等价于 <strong>vm.resolveClass(“java&#x2F;io&#x2F;BufferedReader”)</strong>。</p>
<pre><code class="language-Java">    @Override
    public DvmObject&lt;?&gt; allocObject(BaseVM vm, DvmClass dvmClass, String signature) &#123;
        switch (signature) &#123;
            case &quot;java/lang/StringBuilder-&gt;allocObject&quot;: &#123;
                return ProxyDvmObject.createObject(vm, new StringBuilder());
            &#125;
            case &quot;java/io/BufferedReader-&gt;allocObject&quot;: &#123;
                return dvmClass.newObject(null);
            &#125;
        &#125;
        return super.allocObject(vm, dvmClass, signature);
    &#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/InputStreamReader-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:96)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
</code></pre>
<p>是 InputStreamReader，同样占位处理</p>
<pre><code class="language-Java">case &quot;java/io/InputStreamReader-&gt;allocObject&quot;:&#123;
    return dvmClass.newObject(signature);
&#125;
</code></pre>
<p>运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/FileInputStream-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:102)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
</code></pre>
<p>是 <strong>FileInputStream</strong>，同理</p>
<pre><code class="language-Java">case &quot;java/io/FileInputStream-&gt;allocObject&quot;:&#123;
    return dvmClass.newObject(signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:115)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>终于到了调用其 <strong>init</strong> 函数做初始化的逻辑，因为 <strong>callVoid</strong> 系列 API 没有返回值，它的操作基于原先的占位 <strong>dvmObject</strong>，因为我们没法对它重新复制，所以我声明一个全局变量处理它以及后面的逻辑，应该说挺麻烦的。</p>
<pre><code class="language-Java">public class TEST4 extends AbstractJni implements IOResolver &#123;
    private final AndroidEmulator emulator;
    private final DvmObject&lt;?&gt; SIUACollector;
    private final VM vm;
    public FileInputStream fileInputStream;
</code></pre>
<p>然后补具体逻辑</p>
<pre><code class="language-Java">case &quot;java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;FileInputStream:&quot;+name);
    try &#123;
        fileInputStream = new FileInputStream(name);
    &#125; catch (FileNotFoundException e) &#123;
        e.printStackTrace();
    &#125;
    return;
&#125;
</code></pre>
<p>运行发现有问题</p>
<pre><code class="language-shell">FileInputStream: /proc/cpuinfo
JNIEnv-&gt;CallVoidMethodA(java.io.FileInputStream@2ddc8ecb, &lt;init&gt;(&quot;/proc/cpuinfo&quot;)) was called from RX@0x12030391[libmtguard.so]0x30391
JNIEnv-&gt;GetMethodID(java/io/InputStreamReader.&lt;init&gt;(Ljava/io/InputStream;)V) =&gt; 0x692aa2f2 was called from RX@0x12006369[libmtguard.so]0x6369
[14:33:20 104]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x13b, PC=unidbg@0xfffe0444, LR=RX@0x12029ed7[libmtguard.so]0x29ed7, syscall=null
java.lang.UnsupportedOperationException: java/io/InputStreamReader-&gt;&lt;init&gt;(Ljava/io/InputStream;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:128)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callVoidMethodA(DvmMethod.java:234)
	at com.github.unidbg.linux.android.dvm.DalvikVM$60.handle(DalvikVM.java:1076)
java.io.FileNotFoundException: \proc\cpuinfo (系统找不到指定的路径。)
	at java.base/java.io.FileInputStream.open0(Native Method)
	at java.base/java.io.FileInputStream.open(FileInputStream.java:219)
</code></pre>
<p>程序在访问 &#x2F;proc&#x2F;cpuinfo 文件，首先将 &#x2F;proc&#x2F;cpuinfo 文件拖到本地</p>
<pre><code class="language-shell">└─Δ adb pull /proc/cpuinfo xxx\unidbg\unidbg-android\src\test\java\com\test4
* daemon not running; starting now at tcp:5037
* daemon started successfully
/proc/cpuinfo: 1 file pulled, 0 skipped. 0.2 MB/s (1919 bytes in 0.011s)
</code></pre>
<p>然后做路径重定位</p>
<pre><code class="language-Java">case &quot;java/io/FileInputStream-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    if(name.equals(&quot;/proc/cpuinfo&quot;))&#123;
        name = &quot;unidbg-android/src/test/java/com/test4/cpuinfo&quot;;
    &#125;
    System.out.println(&quot;FileInputStream:&quot;+name);
    try &#123;
        fileInputStream = new FileInputStream(name);
    &#125; catch (FileNotFoundException e) &#123;
        e.printStackTrace();
    &#125;
    return;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/InputStreamReader-&gt;&lt;init&gt;(Ljava/io/InputStream;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:131)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callVoidMethodA(DvmMethod.java:234)
</code></pre>
<p>同理处理为全局变量</p>
<pre><code class="language-Java">public class TEST4 extends AbstractJni implements IOResolver &#123;
    private final AndroidEmulator emulator;
    private final DvmObject&lt;?&gt; SIUACollector;
    private final VM vm;
    public FileInputStream fileInputStream;
    public InputStreamReader inputStreamReader;
</code></pre>
<p>补方法逻辑</p>
<pre><code class="language-Java">case &quot;java/io/InputStreamReader-&gt;&lt;init&gt;(Ljava/io/InputStream;)V&quot;:&#123;
    inputStreamReader = new InputStreamReader(fileInputStream);
    return;
&#125;
</code></pre>
<p>这个 InputStream 参数就是我们之前定义的全局变量 InputStream，所以拿过来用。</p>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/BufferedReader-&gt;&lt;init&gt;(Ljava/io/Reader;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:137)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>这三个其实就是一连套的…</p>
<pre><code class="language-Java">public class TEST4 extends AbstractJni implements IOResolver &#123;
    private final AndroidEmulator emulator;
    private final DvmObject&lt;?&gt; SIUACollector;
    private final VM vm;
    public FileInputStream fileInputStream;
    public InputStreamReader inputStreamReader;
    public BufferedReader bufferedReader;
</code></pre>
<p>处理</p>
<pre><code class="language-Java">case &quot;java/io/BufferedReader-&gt;&lt;init&gt;(Ljava/io/Reader;)V&quot;:&#123;
    bufferedReader = new BufferedReader(inputStreamReader);
    return;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/BufferedReader-&gt;readLine()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:180)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>似乎回归到了我们更熟悉的逻辑里了</p>
<pre><code class="language-Java">case &quot;java/io/BufferedReader-&gt;readLine()Ljava/lang/String;&quot;:&#123;
    String oneline;
    try &#123;
        oneline = bufferedReader.readLine();
        if(oneline != null)&#123;
            return new StringObject(vm, oneline);
        &#125;else &#123;
            return null;
        &#125;
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;compareToIgnoreCase(Ljava/lang/String;)I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:234)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
</code></pre>
<p>JDK 方法，正常补即可</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;compareToIgnoreCase(Ljava/lang/String;)I&quot;:&#123;
    String str = vaList.getObjectArg(0).getValue().toString();
    return dvmObject.getValue().toString().compareToIgnoreCase(str);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;lastIndexOf(I)I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:238)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
</code></pre>
<p>依旧是 JDK 方法</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;lastIndexOf(I)I&quot;:&#123;
    return dvmObject.getValue().toString().lastIndexOf(vaList.getIntArg(0));
&#125;
</code></pre>
<p>继续运行和补环境</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;substring(I)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:194)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>补</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;substring(I)Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, dvmObject.getValue().toString().substring(vaList.getIntArg(0)));
&#125;
</code></pre>
<p>报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:197)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">            case &quot;java/lang/StringBuilder-&gt;append(I)Ljava/lang/StringBuilder;&quot;: &#123;
                int value = vaList.getIntArg(0); // 直接取 int
                ((StringBuilder) dvmObject.getValue()).append(value); // 自动转成字符串拼接
                return dvmObject; // append 返回 this
            &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/BufferedReader-&gt;close()V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:139)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/io/BufferedReader-&gt;close()V&quot;:&#123;
    try &#123;
        bufferedReader.close();
    &#125; catch (IOException e) &#123;
        e.printStackTrace();
    &#125;
    return;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:229)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>传感器一向是收集信息的重点，处理它需要更多的耐心。</p>
<p>首先是这个 API 的原型</p>
<pre><code class="language-Java">Sensor getDefaultSensor(int type)
</code></pre>
<p>它会从传感器服务获取指定类型的传感器，有相当多的类型，详见 Android <a target="_blank" rel="noopener" href="http://aospxref.com/android-8.0.0_r36/xref/frameworks/base/core/java/android/hardware/Sensor.java">源码</a>。</p>
<pre><code class="language-Java">public static final int TYPE_ACCELEROMETER = 1;
public static final int TYPE_ORIENTATION = 3;
public static final int TYPE_POSE_6DOF = 28;
public static final int TYPE_PRESSURE = 6;
public static final int TYPE_PROXIMITY = 8;
public static final int TYPE_RELATIVE_HUMIDITY = 12;
public static final int TYPE_ROTATION_VECTOR = 11;
public static final int TYPE_SIGNIFICANT_MOTION = 17;
public static final int TYPE_STATIONARY_DETECT = 29;
public static final int TYPE_STEP_COUNTER = 19;
public static final int TYPE_STEP_DETECTOR = 18;
public static final int TYPE_GRAVITY = 9;
</code></pre>
<p>打印参数，看看样本在获取哪类传感器</p>
<pre><code class="language-Java">case &quot;android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;&quot;:&#123;
    int type = vaList.getIntArg(0);
    System.out.println(&quot;Sensor type:&quot;+type);
&#125;
</code></pre>
<p>运行</p>
<pre><code class="language-Java">Sensor type:1
</code></pre>
<p>1 对应于加速度传感器，下面做常规补环境，将 type 设为 DvmObject 的值，因为担心样本会获取多种传感器，所以提前处理，便于区分。</p>
<pre><code class="language-Java">case &quot;android/hardware/SensorManager-&gt;getDefaultSensor(I)Landroid/hardware/Sensor;&quot;:&#123;
    int type = vaList.getIntArg(0);
    return vm.resolveClass(&quot;android/hardware/Sensor&quot;).newObject(type);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getName()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:234)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>这里是在获取传感器的名字</p>
<p>读者可以写一个 Android Java 层 demo，来理解这里的逻辑，在 JNI 中看起来有点懵，但 Java 复写其实相当简单</p>
<pre><code class="language-Java">SensorManager manager= (SensorManager)getSystemService(SENSOR_SERVICE);
Sensor accelSensor = manager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);
Log.e(&quot;lilac sensor Name&quot;,accelSensor.getName());
</code></pre>
<p>在我的测试机上返回 ACCELEROMETER</p>
<p>收集传感器的信息，可以一定程度上阻止 “改机” ，国内主要品牌、主要型号 所对应的传感器信息都可以查到，如果你修改了 Android 设备信息，比如从 pixel 改成 红米 K40，那么对应的，各类传感器信息也要改。如果不协调同步地改，就会有破绽。</p>
<p>继续补环境</p>
<pre><code class="language-Java">case &quot;android/hardware/Sensor-&gt;getName()Ljava/lang/String;&quot;:&#123;
    int type = (Integer) dvmObject.getValue();
    System.out.println(&quot;Sensor type: &quot; + type);
    if(type == 1)&#123;
        return new StringObject(vm, &quot;ACCELEROMETER&quot;);
    &#125;else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
</code></pre>
<p>运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:244)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>传感器有一系列可供获取的属性。</p>
<ul>
<li>getMaximumRange() 最大取值范围</li>
<li>getName() 设备名称</li>
<li>getPower() 功率</li>
<li>getResolution() 精度</li>
<li>getType() 传感器类型</li>
<li>getVentor() 设备供应商</li>
<li>getVersions() 设备版本号</li>
</ul>
<p>这里是在获取设备供应商信息，在 Android demo 中如法炮制</p>
<pre><code class="language-Java">SensorManager manager= (SensorManager)getSystemService(SENSOR_SERVICE);
Sensor accelSensor = manager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);
Log.e(&quot;lilac sensor Name&quot;,accelSensor.getName());
Log.e(&quot;lilac sensor Vendor&quot;,accelSensor.getVendor());
</code></pre>
<p>运行demo，看下日志就知道了<br>我的测试机返回的是，<strong>lsm6dsoe_acc</strong>，是 STMicroelectronics (ST) 生产的 MEMS 传感器。继续补环境</p>
<pre><code class="language-Java">case &quot;android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;&quot;:&#123;
    int type = (int) dvmObject.getValue();
    System.out.println(&quot;Sensor getVendor:&quot; + type);
    if(type == 1)&#123;
        return new StringObject(vm, &quot;lsm6dsoe_acc&quot;);
    &#125;else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">[!] Sensor type(getName): 9
[15:14:41 209]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x1202ad4f[libmtguard.so]0x2ad4f, syscall=null
java.lang.UnsupportedOperationException: android/hardware/Sensor-&gt;getName()Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:240)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>可以看到，它又获得了另一种传感器，9 是 TYPE_GRAVITY 即重力传感器。将 Android demo 稍加修改</p>
<pre><code class="language-Java">SensorManager manager= (SensorManager)getSystemService(SENSOR_SERVICE);
Sensor accelSensor = manager.getDefaultSensor(Sensor.TYPE_GRAVITY);
Log.e(&quot;lilac sensor Name&quot;,accelSensor.getName());
Log.e(&quot;lilac sensor Vendor&quot;,accelSensor.getVendor());
</code></pre>
<p>传感器名为 GRAVITY，vendor 是 MTK，继续完善补环境</p>
<pre><code class="language-Java">case &quot;android/hardware/Sensor-&gt;getName()Ljava/lang/String;&quot;:&#123;
    int type = (int) dvmObject.getValue();
    System.out.println(&quot;Sensor getName:&quot;+type);
    if(type == 1)&#123;
        return new StringObject(vm, &quot;ACCELEROMETER&quot;);
    &#125;else if(type == 9)&#123;
        return new StringObject(vm, &quot;GRAVITY&quot;);
    &#125;
    else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
case &quot;android/hardware/Sensor-&gt;getVendor()Ljava/lang/String;&quot;:&#123;
    int type = (int) dvmObject.getValue();
    System.out.println(&quot;Sensor getVendor:&quot;+type);
    if(type == 1)&#123;
        return new StringObject(vm, &quot;lsm6dsoe_acc&quot;);
    &#125;else if(type == 9)&#123;
        return new StringObject(vm, &quot;MTK&quot;);
    &#125;
    else &#123;
        throw new UnsupportedOperationException(signature);
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;safeClose(Ljava/io/Closeable;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:147)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callVoidMethodA(DvmMethod.java:234)
</code></pre>
<p>在 Jadx 中查看对应的反编译代码</p>
<pre><code class="language-Java">private void safeClose(Closeable closeable) &#123;
    Object[] objArr = &#123;closeable&#125;;
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;148f9159176b748328c0fe05c9308265&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;148f9159176b748328c0fe05c9308265&quot;);
    &#125; else &#123;
        MTGUtils.safeClose(closeable);
    &#125;
&#125;
</code></pre>
<p>看起来是处理完之后的资源关闭操作，简单处理即可</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;safeClose(Ljava/io/Closeable;)V&quot;:&#123;
    return;
&#125;
</code></pre>
<p>继续运行，发现已经跑完了</p>
<pre><code class="language-shell">[*] getHWEquipmentInfo:-|MT6893Z/CZA|8|ACCELEROMETER|lsm6dsoe_acc|GYROSCOPE|MTK|
</code></pre>
<h3 id="八、getHWProperty"><a href="#八、getHWProperty" class="headerlink" title="八、getHWProperty"></a>八、getHWProperty</h3><p>发起调用</p>
<pre><code class="language-Java">public String getHWProperty()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getHWProperty()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>新一轮的补环境</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;BOARD:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>对于 Build 下的数据，同样可以写 demo 看，这个办法灵活好用，或者使用 ADB 也行。这里就直接使用 adb 指令了</p>
<pre><code class="language-shell">└─Δ adb shell
ares:/ $ getprop | grep board
[ro.board.first_api_level]: [30]
[ro.board.platform]: [mt6893]
[ro.miui.has_security_keyboard]: [1]
[ro.product.board]: [ares]
[sys.haptic.intensityforkeyboard]: [true]
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">@Override
public DvmObject&lt;?&gt; getStaticObjectField(BaseVM vm, DvmClass dvmClass, String signature) &#123;
    switch (signature)&#123;
        case &quot;android/os/Build-&gt;BOARD:Ljava/lang/String;&quot;:&#123;
            return new StringObject(vm, &quot;mt6893&quot;);
        &#125;
    &#125;
    return super.getStaticObjectField(vm, dvmClass, signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;MANUFACTURER:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:366)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>同理</p>
<pre><code class="language-shell">ares:/ $ getprop | grep manufacturer
[ro.product.bootimage.manufacturer]: [xiaomi]
[ro.product.manufacturer]: [Xiaomi]
[ro.product.odm.manufacturer]: [Xiaomi]
[ro.product.product.manufacturer]: [Xiaomi]
[ro.product.system.manufacturer]: [xiaomi]
[ro.product.system_ext.manufacturer]: [xiaomi]
[ro.product.vendor.manufacturer]: [Xiaomi]
[ro.product.vendor_dlkm.manufacturer]: [xiaomi]
[ro.soc.manufacturer]: [Mediatek]
</code></pre>
<p>结果是 Xiaomi，补环境</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;MANUFACTURER:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;Xiaomi&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;BRAND:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:369)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>brand 肯定是红米，不过还是运行一下看看</p>
<pre><code class="language-shell">ares:/ $ getprop | grep brand
[ro.product.bootimage.brand]: [redmi]
[ro.product.brand]: [Redmi]
[ro.product.odm.brand]: [Redmi]
[ro.product.product.brand]: [Redmi]
[ro.product.system.brand]: [redmi]
[ro.product.system_ext.brand]: [redmi]
[ro.product.vendor.brand]: [Redmi]
[ro.product.vendor_dlkm.brand]: [redmi]
</code></pre>
<p>结果是 Redmi</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;BRAND:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;Redmi&quot;);
&#125;
</code></pre>
<p>继续运行，接着是 MODEL</p>
<pre><code class="language-Java">java.lang.UnsupportedOperationException: android/os/Build-&gt;MODEL:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:372)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
</code></pre>
<p>同理</p>
<pre><code class="language-shell">ares:/ $ getprop | grep model
[ro.product.bootimage.model]: [ares]
[ro.product.model]: [M2012K10C]
[ro.product.odm.model]: [M2012K10C]
[ro.product.product.model]: [M2012K10C]
[ro.product.system.model]: [missi]
[ro.product.system_ext.model]: [missi]
[ro.product.vendor.model]: [M2012K10C]
[ro.product.vendor_dlkm.model]: [ares]
[ro.soc.model]: [MT6893]
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;MODEL:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;M2012K10C&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:269)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>getSysProp 是一个用于获取系统属性的工具函数，反编译代码如下。</p>
<pre><code class="language-Java">public static String getSysProp(String str) &#123;
    Object[] objArr = &#123;str&#125;;
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;31aaabc5cd1287cb6e2e62ee32d788e0&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;31aaabc5cd1287cb6e2e62ee32d788e0&quot;);
    &#125;
    if (TextUtils.isEmpty(str)) &#123;
        return &quot;&quot;;
    &#125;
    try &#123;
        Class&lt;?&gt; cls = Class.forName(&quot;android.os.SystemProperties&quot;);
        return (String) cls.getDeclaredMethod(&quot;get&quot;, String.class).invoke(cls, str);
    &#125; catch (Throwable th) &#123;
        c.a(th);
        MTGuardLog.error(th);
        return &quot;&quot;;
    &#125;
&#125;
</code></pre>
<p>浅浅打印一下参数</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;getSysProp:&quot;+name);
&#125;
</code></pre>
<p>运行代码</p>
<pre><code class="language-shell">[!] getSysProp: ro.product.cpu.abi
[15:54:43 498]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x1200d2a7[libmtguard.so]0xd2a7, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:273)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
	at com.github.unidbg.linux.android.dvm.DalvikVM$33.handle(DalvikVM.java:578)
</code></pre>
<p>既然是属性信息，用 adb 获取很方便，第一个就是</p>
<pre><code class="language-shell">ares:/ $ getprop | grep ro.product.cpu.abi
[ro.product.cpu.abi]: [arm64-v8a]
[ro.product.cpu.abilist]: [arm64-v8a,armeabi-v7a,armeabi]
[ro.product.cpu.abilist32]: [armeabi-v7a,armeabi]
[ro.product.cpu.abilist64]: [arm64-v8a]
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;getSysProp:&quot;+name);
    if(name.equals(&quot;ro.product.cpu.abi&quot;))&#123;
        return new StringObject(vm, &quot;arm64-v8a&quot;);
    &#125;
    throw new UnsupportedOperationException(signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">[!] getSysProp: ro.product.cpu.abi2
[15:58:21 719]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x12018613[libmtguard.so]0x18613, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:274)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>我的测试机就一个分区，所以用 adb 指令查不到，那么直接返回空字符串就好</p>
<pre><code class="language-Java">else if(name.equals(&quot;ro.product.cpu.abi2&quot;)) &#123;
    return new StringObject(vm, &quot;&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;PRODUCT:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:386)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
</code></pre>
<p>接连着的是 PRODUCT、HARDWARE、DEVICE，依次补环境</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;PRODUCT:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;missi&quot;);
&#125;
case &quot;android/os/Build-&gt;HARDWARE:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;mt6893&quot;);
&#125;
case &quot;android/os/Build-&gt;DEVICE:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;ares&quot;);
&#125;
</code></pre>
<p>穿插</p>
<pre><code class="language-shell">[!] getSysProp: ro.build.product
[16:04:14 251]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x1201831f[libmtguard.so]0x1831f, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:277)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>显然又是所谓的多重校验，多个 API 获取相同信息</p>
<p>然后又是 HOST 和 ID</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;HOST:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;c4-xm-ota-bd093.bj&quot;);
&#125;
case &quot;android/os/Build-&gt;ID:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;SP1A.210812.016&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build$VERSION-&gt;RELEASE:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:405)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>在 adb 中找到</p>
<pre><code class="language-shell">[ro.build.version.release]: [12]
</code></pre>
<p>然后补环境，继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/Integer-&gt;toString(I)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:504)
	at com.test4.TEST4.callStaticObjectMethodV(TEST4.java:327)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callStaticObjectMethodV(AbstractJni.java:438)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/lang/Integer-&gt;toString(I)Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, Integer.toString(vaList.getIntArg(0)));
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/Context-&gt;getResources()Landroid/content/res/Resources;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:284)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>Resources 即资源，看来是新的逻辑。</p>
<pre><code class="language-Java">case &quot;android/content/Context-&gt;getResources()Landroid/content/res/Resources;&quot;:&#123;
    return vm.resolveClass(&quot;android/content/res/Resources&quot;).newObject(null);
&#125;
</code></pre>
<p>继续运行，发现原来是想获取配置信息</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/res/Resources-&gt;getConfiguration()Landroid/content/res/Configuration;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:286)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;android/content/res/Resources-&gt;getConfiguration()Landroid/content/res/Configuration;&quot;:&#123;
    return vm.resolveClass(&quot;android/content/res/Configuration&quot;).newObject(null);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/res/Configuration-&gt;locale:Ljava/util/Locale;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:171)
	at com.test4.TEST4.getObjectField(TEST4.java:299)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:141)
</code></pre>
<p>具体而言，是获取区域信息，locale在 JDK 里也有，所以改用 createObject。</p>
<pre><code class="language-Java">case &quot;android/content/res/Configuration-&gt;locale:Ljava/util/Locale;&quot;:&#123;
    return ProxyDvmObject.createObject(vm, Locale.getDefault());
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;TAGS:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:421)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>ADB grep 一下，ro.build.tags 的值是 release-keys。</p>
<pre><code class="language-shell">ares:/ $ getprop | grep tags
[debug.atrace.tags.enableflags]: [0]
[ro.bootimage.build.tags]: [release-keys]
[ro.build.tags]: [release-keys]
[ro.product.build.tags]: [release-keys]
[ro.system.build.tags]: [release-keys]
[ro.system_ext.build.tags]: [release-keys]
[ro.vendor.build.tags]: [release-keys]
[ro.vendor_dlkm.build.tags]: [release-keys]
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;TAGS:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;release-keys&quot;);
&#125;
</code></pre>
<p>继续运行，</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build-&gt;FINGERPRINT:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:424)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
</code></pre>
<p>接下来是 FINGERPRINT、TYPE。</p>
<pre><code class="language-Java">case &quot;android/os/Build-&gt;FINGERPRINT:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;redmi/missi/missi:12/SP1A.210812.016/V13.0.8.0.SKJCNXM:user/release-keys&quot;);
&#125;
case &quot;android/os/Build-&gt;TYPE:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;user&quot;);
&#125;
</code></pre>
<p>运行，又是 getSysProp</p>
<pre><code class="language-shell">[!] getSysProp: ro.build.description
[16:53:59 982]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x1200ca17[libmtguard.so]0xca17, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:282)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>adb 获取一下信息，然后补环境</p>
<pre><code class="language-shell">ares:/ $ getprop | grep ro.build.description
[ro.build.description]: [missi-user 12 SP1A.210812.016 V13.0.8.0.SKJCNXM release-keys]
</code></pre>
<p>继续补环境</p>
<pre><code class="language-Java">else if(name.equals(&quot;ro.build.description&quot;))&#123;
    return new StringObject(vm, &quot;missi-user 12 SP1A.210812.016 V13.0.8.0.SKJCNXM release-keys&quot;);
&#125;
</code></pre>
<p>运行，还是 getSysProp 调用，参数是 ro.secure</p>
<pre><code class="language-Java">else if(name.equals(&quot;ro.secure&quot;))&#123;
    return new StringObject(vm, &quot;1&quot;);
&#125;
</code></pre>
<p>继续，接着是 ro.debuggable</p>
<pre><code class="language-Java">if(name.equals(&quot;ro.debuggable&quot;))&#123;
    return new StringObject(vm, &quot;0&quot;);
&#125;
</code></pre>
<p>运行代码，得出结果。</p>
<pre><code class="language-shell">[*] getHWProperty: mt6893|Xiaomi|Redmi|M2012K10C|arm64-v8a|-|missi|mt6893|ares|missi|c4-xm-ota-bd093.bj|SP1A.210812.016|12|35|zh|CN|release-keys|redmi/missi/missi:12/SP1A.210812.016/V13.0.8.0.SKJCNXM:user/release-keys|user|missi-user 12 SP1A.210812.016 V13.0.8.0.SKJCNXM release-keys|1|0|
</code></pre>
<h3 id="九、getHWStatus"><a href="#九、getHWStatus" class="headerlink" title="九、getHWStatus"></a>九、getHWStatus</h3><p>发起调用</p>
<pre><code class="language-Java">public String getHWStatus()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getHWStatus()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>开始补环境</p>
<pre><code class="language-shell">[!] getSysProp: persist.sys.usb.config
[17:04:12 708]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x12023a11[libmtguard.so]0x23a11, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:297)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
	at com.github.unidbg.linux.android.dvm.DalvikVM$33.handle(DalvikVM.java:578)
</code></pre>
<p>这是在获取设备是否连接了 ADB，因此返回空字符串为好，接连三个都是类似的属性。</p>
<pre><code class="language-Java">if(name.equals(&quot;persist.sys.usb.config&quot;))&#123;
    return new StringObject(vm, &quot;&quot;);
&#125;
if(name.equals(&quot;sys.usb.config&quot;))&#123;
    return new StringObject(vm, &quot;&quot;);
&#125;
if(name.equals(&quot;sys.usb.state&quot;))&#123;
    return new StringObject(vm, &quot;&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:351)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callBooleanMethodA(DvmMethod.java:124)
	at com.github.unidbg.linux.android.dvm.DalvikVM$36.handle(DalvikVM.java:655)
</code></pre>
<p>查询可知，<strong>hasSystemFeature</strong> 用于确认设备是否有特定的功能模块，打印参数看看</p>
<pre><code class="language-Java">case &quot;android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;check hasSystemFeature:&quot;+name);
&#125;
</code></pre>
<p>发现是检测是否存在加速度传感器</p>
<pre><code class="language-shell">check hasSystemFeature:android.hardware.sensor.accelerometer
</code></pre>
<p>返回 True，继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;boolean2Integer(Z)I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:400)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callIntMethodA(DvmMethod.java:134)
</code></pre>
<p><strong>jadx</strong> 查看对应伪代码</p>
<pre><code class="language-Java">private int boolean2Integer(boolean z) &#123;
         return z ? 1 : 0;
&#125;
</code></pre>
<p>很简单，直接补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;boolean2Integer(Z)I&quot;: &#123;
                return vaList.getIntArg(0);
            &#125;
</code></pre>
<p>然后运行，发现又检测了不少传感器和硬件支持，参考文章中补了下面这么多，但是我并没有补这么多</p>
<pre><code class="language-Java">case &quot;android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z&quot;:&#123;
    String name = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;check hasSystemFeature:&quot;+name);
    switch (name)&#123;
            // 检测加速传感器
        case &quot;android.hardware.sensor.accelerometer&quot;:&#123;
            return true;
        &#125;
            // 检测陀螺仪传感器
        case &quot;android.hardware.sensor.gyroscope&quot;:&#123;
            return true;
        &#125;
            // wifi
        case &quot;android.hardware.wifi&quot;:&#123;
            return true;
        &#125;
            // 蓝牙
        case &quot;android.hardware.bluetooth&quot;:&#123;
            return true;
        &#125;
            // 蓝牙低功耗
        case &quot;android.hardware.bluetooth_le&quot;:&#123;
            return true;
        &#125;
            // 电话
        case &quot;android.hardware.telephony&quot;:&#123;
            return true;
        &#125;
            // USB 配件API
        case &quot;android.hardware.usb.accessory&quot;:&#123;
            return true;
        &#125;
            // gps
        case &quot;android.hardware.location.gps&quot;:&#123;
            return true;
        &#125;
            // nfc
        case &quot;android.hardware.nfc&quot;:&#123;
            return true;
        &#125;
    &#125;
&#125;
</code></pre>
<pre><code class="language-Java">case &quot;android/content/pm/PackageManager-&gt;hasSystemFeature(Ljava/lang/String;)Z&quot;: &#123;
                String name = vaList.getObjectArg(0).getValue().toString();
                System.out.println(&quot;[!] Check hasSystemFeature: &quot; + name);
                switch (name) &#123;
                    // 检测加速度传感器
                    case &quot;android.hardware.sensor.accelerometer&quot;: &#123;
                        return true;
                    &#125;
                    // 检测陀螺仪传感器
                    case &quot;android.hardware.sensor.gyroscope&quot;: &#123;
                        return true;
                    &#125;
                &#125;
            &#125;
</code></pre>
<p>在这个过程中，也还涉及到其他的几个补环境</p>
<pre><code class="language-shell">[!] getSysProp: gsm.version.baseband
[17:27:30 570]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x120, PC=unidbg@0xfffe0294, LR=RX@0x12024d7f[libmtguard.so]0x24d7f, syscall=null
java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getSysProp(Ljava/lang/String;)Ljava/lang/String;
	at com.test4.TEST4.callObjectMethodV(TEST4.java:306)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
	at com.github.unidbg.linux.android.dvm.DalvikVM$33.handle(DalvikVM.java:578)
</code></pre>
<p>也还是和之前一样补一下</p>
<pre><code class="language-Java">else if (name.equals(&quot;gsm.version.baseband&quot;)) &#123;
                    return new StringObject(vm, &quot;MOLY.NR15.R3.TC8.PR2.SP.V2.1.P23,MOLY.NR15.R3.TC8.PR2.SP.V2.1.P23&quot;);
                &#125;
                else if (name.equals(&quot;gsm.version.ril-impl&quot;)) &#123;
                    return new StringObject(vm, &quot;android reference-ril 1.0&quot;);
                &#125;
                else if (name.equals(&quot;gsm.sim.state&quot;)) &#123;
                    return new StringObject(vm, &quot;ABSENT,ABSENT&quot;);
                &#125;
                else if (name.equals(&quot;gsm.sim.state.2&quot;)) &#123;
                    return new StringObject(vm, &quot;&quot;);
                &#125;
                else if (name.equals(&quot;wifi.interface&quot;)) &#123;
                    return new StringObject(vm, &quot;&quot;);
                &#125;
</code></pre>
<p>还有一些其他类型的错误</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/File-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:122)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
	at com.github.unidbg.linux.android.dvm.DalvikVM$24.handle(DalvikVM.java:365)
</code></pre>
<p>和之前一样处理</p>
<pre><code class="language-Java">case &quot;java/io/File-&gt;allocObject&quot;: &#123;
                return dvmClass.newObject(signature);
            &#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:167)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>和先前一样，用全局变量处理，因为担心会初始化多个文件，所以命名为 file1</p>
<pre><code class="language-Java">public class TEST4 extends AbstractJni implements IOResolver &#123;
    private final AndroidEmulator emulator;
    private final DvmObject&lt;?&gt; SIUACollector;
    private final VM vm;
    public FileInputStream fileInputStream;
    public InputStreamReader inputStreamReader;
    public BufferedReader bufferedReader;
    public File file1;
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;:&#123;
    String path = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;filePath:&quot;+path);
&#125;
</code></pre>
<p>运行</p>
<pre><code class="language-shell">filePath:/sys/class/power_supply/battery/voltage_now
</code></pre>
<p>这是电池信息有关的文件</p>
<pre><code class="language-shell">1|ares:/ $ su
ares:/ # cat /sys/class/power_supply/battery/voltage_now
4227000
</code></pre>
<p>在 Unidbg 中建立对应的文件，补环境，重定向</p>
<pre><code class="language-Java">case &quot;java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;:&#123;
    String path = vaList.getObjectArg(0).getValue().toString();
    System.out.println(&quot;filePath:&quot;+path);
    if(path.equals(&quot;/sys/class/power_supply/battery/voltage_now&quot;))&#123;
        file1 = new File(&quot;unidbg-android/src/test/resources/dianping/files/voltage_now&quot;);
        return;
    &#125;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/io/File-&gt;exists()Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:391)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
</code></pre>
<p>继续补环境</p>
<pre><code class="language-Java">case &quot;java/io/File-&gt;exists()Z&quot;:&#123;
    return file1.exists();
&#125;
</code></pre>
<p>直接返回 true 也行，因为这里判断的就是我们刚处理的 file1 是否存在。<br>运行，然后样本又开始处理另一个文件</p>
<pre><code class="language-shell">Filepath: /sys/class/power_supply/battery/temp
[17:52:27 885]  WARN [com.github.unidbg.linux.ARM32SyscallHandler] (ARM32SyscallHandler:538) - handleInterrupt intno=2, NR=-452987096, svcNumber=0x13b, PC=unidbg@0xfffe0444, LR=RX@0x12026601[libmtguard.so]0x26601, syscall=null
java.lang.UnsupportedOperationException: java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:176)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/io/File-&gt;&lt;init&gt;(Ljava/lang/String;)V&quot;: &#123;
                String path = vaList.getObjectArg(0).getValue().toString();
                System.out.println(&quot;Filepath: &quot; + path);
                if (path.equals(&quot;/sys/class/power_supply/battery/voltage_now&quot;)) &#123;
                    file1 = new File(&quot;unidbg-android/src/test/java/com/test4/voltage_now&quot;);
                    return;
                &#125;
                else if (path.equals(&quot;/sys/class/power_supply/battery/temp&quot;)) &#123;
                    file2 = new File(&quot;unidbg-android/src/test/java/com/test4/temp&quot;);
                    return;
                &#125;
            &#125;
</code></pre>
<p>继续运行，得到结果</p>
<pre><code class="language-shell">[*] getHWStatus: -|-|-|1|1|MOLY.NR15.R3.TC8.PR2.SP.V2.1.P23,MOLY.NR15.R3.TC8.PR2.SP.V2.1.P23|android reference-ril 1.0|ABSENT,ABSENT|-|1|1|1|-|1|1|1|1|1|1|1|
</code></pre>
<h3 id="十、getLocationInfo"><a href="#十、getLocationInfo" class="headerlink" title="十、getLocationInfo"></a>十、getLocationInfo</h3><p>发起调用</p>
<pre><code class="language-Java">public String getLocationInfo()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getLocationInfo()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/net/wifi/WifiManager-&gt;getConnectionInfo()Landroid/net/wifi/WifiInfo;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:353)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;android/net/wifi/WifiManager-&gt;getConnectionInfo()Landroid/net/wifi/WifiInfo;&quot;:&#123;
    return vm.resolveClass(&quot;android/net/wifi/WifiInfo&quot;).newObject(signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/net/wifi/WifiInfo-&gt;getSSID()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:356)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>Google 的这个API 的作用是获取 WiFi 名，查看手机所连接的 WiFi 名，做补环境</p>
<pre><code class="language-java">case &quot;android/net/wifi/WifiInfo-&gt;getSSID()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;DX-MOBILE&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;equalsIgnoreCase(Ljava/lang/String;)Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:412)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
</code></pre>
<p>正常补环境</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;equalsIgnoreCase(Ljava/lang/String;)Z&quot;:&#123;
    return dvmObject.getValue().toString().equalsIgnoreCase(vaList.getObjectArg(0).getValue().toString());
&#125;
</code></pre>
<p>报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;equals(Ljava/lang/Object;)Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:415)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;equals(Ljava/lang/Object;)Z&quot;:&#123;
    return dvmObject.getValue().toString().equals(vaList.getObjectArg(0).getValue().toString());
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/String-&gt;length()I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:457)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
</code></pre>
<p>依旧正常补环境</p>
<pre><code class="language-Java">case &quot;java/lang/String-&gt;length()I&quot;: &#123;
    return dvmObject.getValue().toString().length();
&#125;
</code></pre>
<p>运行，继续报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/lang/StringBuilder-&gt;append(Ljava/lang/CharSequence;II)Ljava/lang/StringBuilder;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:359)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>这个稍微有点复杂</p>
<pre><code class="language-Java">				case &quot;java/lang/StringBuilder-&gt;append(Ljava/lang/CharSequence;II)Ljava/lang/StringBuilder;&quot;: &#123;
                // 参数
                CharSequence csq = (CharSequence) vaList.getObjectArg(0).getValue();
                int start = vaList.getIntArg(1);
                int end = vaList.getIntArg(2);

                // 构造新内容
                StringBuilder currentValue = (StringBuilder) dvmObject.getValue();
                StringBuilder sb = new StringBuilder(currentValue);
                sb.append(csq.subSequence(start, end));

                // 返回新的 StringBuilder 对象（因为 setValue() 不能直接改）
                return vm.resolveClass(&quot;java/lang/StringBuilder&quot;).newObject(sb);
            &#125;
</code></pre>
<p>不过一步一步拆开来写就好了。然后继续运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/net/wifi/WifiInfo-&gt;getBSSID()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:373)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>上网查了下这个 API 的功能，是获取 WiFi 接入点的唯一标识符，一般就是路由器无线网卡的 MAC 地址</p>
<p>。一样采用写一个 demo 的方式来获取这个值</p>
<pre><code class="language-Java">        // 检查并申请 Wi-Fi 和定位权限
        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED ||
                ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_WIFI_STATE) != PackageManager.PERMISSION_GRANTED) &#123;

            ActivityCompat.requestPermissions(this,
                    new String[]&#123;
                            Manifest.permission.ACCESS_FINE_LOCATION,
                            Manifest.permission.ACCESS_WIFI_STATE
                    &#125;, PERMISSION_REQUEST_CODE);
        &#125; else &#123;
            getBssid();
        &#125;
    &#125;

    // 获取 BSSID
    private void getBssid() &#123;
        WifiManager wifiManager = (WifiManager) getSystemService(WIFI_SERVICE);
        if (wifiManager != null) &#123;
            WifiInfo wifiInfo = wifiManager.getConnectionInfo();
            if (wifiInfo != null &amp;&amp; wifiInfo.getBSSID() != null) &#123;
                Log.e(&quot;当前BSSID&quot;, wifiInfo.getBSSID());
            &#125; else &#123;
                Log.e(&quot;当前BSSID&quot;, &quot;无法获取BSSID，权限不足或未连接Wi-Fi&quot;);
            &#125;
        &#125;
    &#125;

    // 处理运行时权限回调
    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions,
                                           @NonNull int[] grantResults) &#123;
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        if (requestCode == PERMISSION_REQUEST_CODE) &#123;
            boolean granted = true;
            for (int res : grantResults) &#123;
                if (res != PackageManager.PERMISSION_GRANTED) &#123;
                    granted = false;
                    break;
                &#125;
            &#125;
            if (granted) &#123;
                getBssid();
            &#125; else &#123;
                Log.e(&quot;当前BSSID&quot;, &quot;权限被拒绝，无法获取BSSID&quot;);
            &#125;
        &#125;
    &#125;
</code></pre>
<p>稍微有点复杂，因为需要申请权限。然后我获取的值是 3c:d2:e5: ab:81:b1。补环境</p>
<pre><code class="language-Java">            case &quot;android/net/wifi/WifiInfo-&gt;getBSSID()Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;3c:d2:e5:ab:81:b1&quot;);
            &#125;
</code></pre>
<p>继续</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/net/wifi/WifiInfo-&gt;getRssi()I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:477)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
</code></pre>
<p>这个 API 是用来获取 WiFi 信号强度的，也可以使用 上面的方法 来获取，当然也可以随意返回一个正常的值也可以</p>
<pre><code class="language-Java">WifiManager wifiManager = (WifiManager) getSystemService(Context.WIFI_SERVICE);
WifiInfo wifiInfo = wifiManager.getConnectionInfo();
int rssi = wifiInfo.getRssi();
Log.e(&quot;WiFi RSSI&quot;, String.valueOf(rssi));
</code></pre>
<p>我的测试机获取到的值是 -47，补环境</p>
<pre><code class="language-Java">            case &quot;android/net/wifi/WifiInfo-&gt;getRssi()I&quot;: &#123;
                return -47;
            &#125;
</code></pre>
<p>继续运行报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/telephony/TelephonyManager-&gt;getNetworkOperator()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:376)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>这个 API 是获取当前移动网络运行商的 MCC + MNC。没插卡，直接返回空字符串。</p>
<pre><code class="language-Java">            case &quot;android/telephony/TelephonyManager-&gt;getNetworkOperator()Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;&quot;);
            &#125;
</code></pre>
<p>继续运行，就跑通了</p>
<pre><code class="language-shell">[*] getLocationInfo: -|-|-|-|-|
</code></pre>
<h3 id="十一、getPlatformInfo"><a href="#十一、getPlatformInfo" class="headerlink" title="十一、getPlatformInfo"></a>十一、getPlatformInfo</h3><p>发起调用</p>
<pre><code class="language-Java">public String getPlatformInfo()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getPlatformInfo()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>运行，报错</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:139)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
	at com.github.unidbg.linux.android.dvm.DalvikVM$24.handle(DalvikVM.java:365)
</code></pre>
<p>同理处理</p>
<pre><code class="language-Java">case &quot;java/text/SimpleDateFormat-&gt;allocObject&quot;:&#123;
    return dvmClass.newObject(signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/util/Locale;)V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:196)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callVoidMethodA(DvmMethod.java:234)
</code></pre>
<p>依旧处理为全局变量，然后补环境</p>
<pre><code class="language-Java">case &quot;java/text/SimpleDateFormat-&gt;&lt;init&gt;(Ljava/lang/String;Ljava/util/Locale;)V&quot;:&#123;
    String pattern = vaList.getObjectArg(0).getValue().toString();
    Locale locale = (Locale) vaList.getObjectArg(1).getValue();
    simpleDateFormat = new SimpleDateFormat(pattern, locale);
    return;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: android/os/Build$VERSION-&gt;SDK:Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:103)
	at com.test4.TEST4.getStaticObjectField(TEST4.java:567)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getStaticObjectField(AbstractJni.java:53)
	at com.github.unidbg.linux.android.dvm.DvmField.getStaticObjectField(DvmField.java:106)
	at com.github.unidbg.linux.android.dvm.DalvikVM$142.handle(DalvikVM.java:2275)
</code></pre>
<p>前面我们补过 <strong>android&#x2F;os&#x2F;Build$VERSION-&gt;SDK_INT:I</strong>，它和此处作用一致，区别仅在于返回数字还是字符串。</p>
<pre><code class="language-Java">case &quot;android/os/Build$VERSION-&gt;SDK:Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;35&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/util/Date-&gt;allocObject
	at com.github.unidbg.linux.android.dvm.AbstractJni.allocObject(AbstractJni.java:812)
	at com.test4.TEST4.allocObject(TEST4.java:144)
	at com.github.unidbg.linux.android.dvm.DvmClass.allocObject(DvmClass.java:74)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;java/util/Date-&gt;allocObject&quot;:&#123;
    return dvmClass.newObject(signature);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/util/Date-&gt;&lt;init&gt;()V
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:1007)
	at com.test4.TEST4.callVoidMethodV(TEST4.java:207)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callVoidMethodV(AbstractJni.java:990)
</code></pre>
<p>这是一个无参构造，那可以回头修改 allocObject 那里的代码，是得思路更清晰</p>
<pre><code class="language-Java">case &quot;java/util/Date-&gt;allocObject&quot;:&#123;
    return ProxyDvmObject.createObject(vm, new Date());
&#125;
</code></pre>
<p>然后下面初始化的时候就不用做什么了</p>
<pre><code class="language-Java">case &quot;java/util/Date-&gt;&lt;init&gt;()V&quot;:&#123;
    return;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: java/text/SimpleDateFormat-&gt;format(Ljava/util/Date;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:403)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>补环境，直接返回一个固定的已格式化的时间字符串</p>
<pre><code class="language-Java">            case &quot;java/text/SimpleDateFormat-&gt;format(Ljava/util/Date;)Ljava/lang/String;&quot;: &#123;
                return new StringObject(vm, &quot;2025-08-04 09:05:05&quot;);
            &#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;androidAppCnt(Landroid/content/Context;)I
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:563)
	at com.test4.TEST4.callIntMethodV(TEST4.java:510)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callIntMethodV(AbstractJni.java:529)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callIntMethodA(DvmMethod.java:134)
</code></pre>
<p><strong>jadx</strong> 中看 androidAppCnt 的实现</p>
<pre><code class="language-Java">public static int androidAppCnt(Context context) &#123;
    int i;
    Object[] objArr = &#123;context&#125;;
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;e2af58080aad5d311267bb7c71e6cce2&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        return ((Integer) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;e2af58080aad5d311267bb7c71e6cce2&quot;)).intValue();
    &#125;
    int i2 = androidAppCntCache;
    if (i2 != 0) &#123;
        return i2;
    &#125;
    if (context == null) &#123;
        return 0;
    &#125;
    if (Thread.currentThread() == Looper.getMainLooper().getThread()) &#123;
        return androidAppCntCache;
    &#125;
    try &#123;
        lock.lock();
    &#125; catch (Throwable th) &#123;
        c.a(th);
    &#125;
    if (androidAppCntCache != 0) &#123;
        i = androidAppCntCache;
    &#125; else &#123;
        PackageManager pkgManager = getPkgManager(context);
        if (pkgManager == null) &#123;
            i = androidAppCntCache;
        &#125; else &#123;
            androidAppCntCache = pkgManager.getInstalledApplications(128).size();
            lock.unlock();
            return androidAppCntCache;
        &#125;
    &#125;
    lock.unlock();
    return i;
&#125;
</code></pre>
<p>代码逻辑是在获取设备安装了多少 App，相比较正常的用户设备，爬虫、黑灰产专用设备往往只安装很少的一些 App。读者可以随机返回一个大于 200 的数字，如果想确定测试机上的应用数，可以 Hook <strong>androidAppCnt</strong> 函数或者使用 ADB。</p>
<pre><code class="language-shell">└─Δ adb shell
ares:/ $ pm list package
package:com.miui.screenrecorder
package:com.mediatek.ims
package:com.mediatek.op01.phone.plugin
package:icu.nullptr.applistdetector
package:com.android.cts.priv.ctsshim
...
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;androidAppCnt(Landroid/content/Context;)I&quot;:&#123;
    return 408;
&#125;
</code></pre>
<p>新错误</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;appCache(Landroid/content/Context;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:406)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>具体代码逻辑是计算 App 缓存目录大小，直接 Hook 获取</p>
<pre><code class="language-js">function callSIUACollector() &#123;
  setTimeout(function () &#123;
    Java.perform(function () &#123;
      const ActivityThread = Java.use(&quot;android.app.ActivityThread&quot;);
      let context = ActivityThread.currentApplication().getApplicationContext();
      const ContextClass = Java.use(&quot;android.content.Context&quot;);
      const ctx = Java.cast(context, ContextClass);

      let SIUACollector = Java.use(
        &quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;
      );
      // 传context创建实例
      let instance = SIUACollector.$new(ctx);

      let result = instance.appCache(ctx);
      console.log(&quot;ret: &quot; + result);
    &#125;);
  &#125;, 3000);
&#125;
callSIUACollector();
</code></pre>
<p>我的测试机拿到的数据是 114324295。补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;appCache(Landroid/content/Context;)Ljava/lang/String;&quot;:
    return new StringObject(vm, &quot;114324295&quot;);
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;availableSystem()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:409)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>看伪代码</p>
<pre><code class="language-java">public static String availableSystem() &#123;
    Object[] objArr = new Object[0];
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;234b4d16d3aab7d4062d61d2146219de&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;234b4d16d3aab7d4062d61d2146219de&quot;);
    &#125;
    try &#123;
        File dataDirectory = Environment.getDataDirectory();
        if (!readable(dataDirectory)) &#123;
            return &quot;unknown&quot;;
        &#125;
        StatFs statFs = new StatFs(dataDirectory.getPath());
        return StringUtils.toString(statFs.getAvailableBlocks() * statFs.getBlockSize());
    &#125; catch (Throwable th) &#123;
        c.a(th);
        return &quot;unknown&quot;;
    &#125;
&#125;
</code></pre>
<p>用 frida hook 测试一下</p>
<pre><code class="language-js">Java.perform(function() &#123;
  let DeviceInfoWorker = Java.use(&quot;com.meituan.android.common.dfingerprint.collection.workers.DeviceInfoWorker&quot;);
  DeviceInfoWorker[&quot;availableSystem&quot;].implementation = function () &#123;
    console.log(&#39;availableSystem is called&#39;);
    let ret = this.availableSystem();
    console.log(&#39;availableSystem ret value is &#39; + ret);
    return ret;
  &#125;;
&#125;)
</code></pre>
<p>hook 结果</p>
<pre><code class="language-shell">availableSystem is called
availableSystem ret value is unknown
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;availableSystem()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;unknown&quot;);
&#125;
</code></pre>
<p>继续运行，还是在获取设备存储相关信息</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;totalMemory()Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:412)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p><strong>Jadx</strong> 中查看具体代码逻辑</p>
<pre><code class="language-Java">public static String totalMemory() &#123;
    Object[] objArr = new Object[0];
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, null, changeQuickRedirect2, true, &quot;a240e07aebe4d91708d281e29b9fc189&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        return (String) PatchProxy.accessDispatch(objArr, null, changeQuickRedirect2, true, &quot;a240e07aebe4d91708d281e29b9fc189&quot;);
    &#125;
    try &#123;
        FileReader fileReader = new FileReader(&quot;/proc/meminfo&quot;);
        BufferedReader bufferedReader = new BufferedReader(fileReader);
        bufferedReader.close();
        fileReader.close();
        return StringUtils.toString(Long.valueOf(bufferedReader.readLine().split(&quot;\\s+&quot;)[1]).intValue() * 1024);
    &#125; catch (Throwable th) &#123;
        c.a(th);
        return &quot;unknown&quot;;
    &#125;
&#125;
</code></pre>
<p>这里是在访问 &#x2F;proc&#x2F;meminfo 的首行，我们也可以在 adb 中复现这一过程</p>
<pre><code class="language-shell">└─Δ adb shell
ares:/ $ cat /proc/meminfo
MemTotal:        7714228 kB
MemFree:          187216 kB
MemAvailable:    3950016 kB
Buffers:            7428 kB
Cached:          4022680 kB
SwapCached:       139544 kB
</code></pre>
<p>进行一下单位转换，7714228 * 1024 &#x3D; 7,899,369,472 B<br>然后也可以 frida hook 验证一下</p>
<pre><code class="language-js">function callSIUACollector() &#123;
  setTimeout(function () &#123;
    Java.perform(function () &#123;
      const ActivityThread = Java.use(&quot;android.app.ActivityThread&quot;);
      let context = ActivityThread.currentApplication().getApplicationContext();
      const ContextClass = Java.use(&quot;android.content.Context&quot;);
      const ctx = Java.cast(context, ContextClass);

      let SIUACollector = Java.use(
        &quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;
      );
      // 传context创建实例
      let instance = SIUACollector.$new(ctx);

      let result = instance.totalMemory();
      console.log(&quot;ret: &quot; + result);
    &#125;);
  &#125;, 3000);
&#125;
callSIUACollector();
</code></pre>
<p>得到的结果</p>
<pre><code class="language-shell">ret: 7899369472
</code></pre>
<p>符合预期。补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;totalMemory()Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;7899369472&quot;);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getFirstLaunchTime(Landroid/content/Context;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:415)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
	at com.github.unidbg.linux.android.dvm.DvmMethod.callObjectMethodA(DvmMethod.java:94)
</code></pre>
<p>getFirstLaunchTime 语义清晰，即 App 安装后的首次启动时间。直接 Hook 查看</p>
<pre><code class="language-js">function callSIUACollector() &#123;
  setTimeout(function () &#123;
    Java.perform(function () &#123;
      const ActivityThread = Java.use(&quot;android.app.ActivityThread&quot;);
      let context = ActivityThread.currentApplication().getApplicationContext();
      const ContextClass = Java.use(&quot;android.content.Context&quot;);
      const ctx = Java.cast(context, ContextClass);

      let SIUACollector = Java.use(
        &quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;
      );
      // 传context创建实例
      let instance = SIUACollector.$new(ctx);

      let result = instance.getFirstLaunchTime(ctx);
      console.log(&quot;ret: &quot; + result);
    &#125;);
  &#125;, 3000);
&#125;
callSIUACollector();
</code></pre>
<p>hook 结果</p>
<pre><code class="language-shell">ret: 1755054762052
</code></pre>
<p>这是时间戳，转一下，不过得注意单位是毫秒<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250814115612408.png" alt="image-20250814115612408"></p>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getFirstLaunchTime(Landroid/content/Context;)Ljava/lang/String;&quot;:&#123;
    return new StringObject(vm, &quot;1755054762052&quot;);
&#125;
</code></pre>
<p>运行得到结果</p>
<pre><code class="language-shell">[*] getPlatformInfo: Android|com.dianping.v1|10.41.15|35|-|2025-08-04 09:05:05|408|114324295|-|7899369472|1755054762052|-|-|
</code></pre>
<h3 id="十二、getUserAction"><a href="#十二、getUserAction" class="headerlink" title="十二、getUserAction"></a>十二、getUserAction</h3><p>发起调用</p>
<pre><code class="language-Java">public String getUserAction()&#123;
    String result = SIUACollector.callJniMethodObject(emulator, &quot;getUserAction()Ljava/lang/String;&quot;).getValue().toString();
    return result;
&#125;
</code></pre>
<p>开始补环境</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;batteryHelper:Lcom/meituan/android/common/dfingerprint/collection/utils/BatteryHelper;
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:171)
	at com.test4.TEST4.getObjectField(TEST4.java:437)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getObjectField(AbstractJni.java:141)
</code></pre>
<p>从名字可以看出，是和电池有关的处理</p>
<pre><code>case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;batteryHelper:Lcom/meituan/android/common/dfingerprint/collection/utils/BatteryHelper;&quot;:&#123;
    return vm.resolveClass(&quot;com/meituan/android/common/dfingerprint/collection/utils/BatteryHelper&quot;).newObject(null);
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getBatteryInfo()Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:625)
	at com.test4.TEST4.callBooleanMethodV(TEST4.java:486)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callBooleanMethodV(AbstractJni.java:603)
</code></pre>
<p>看起来是在确认是否可以获取电池相关的信息</p>
<pre><code class="language-Java">private boolean getBatteryInfo() &#123;
    Object[] objArr = new Object[0];
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;2d10aac5384d6818e2765f99df76bffe&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        return ((Boolean) PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;2d10aac5384d6818e2765f99df76bffe&quot;)).booleanValue();
    &#125;
    Context context = this.mContext;
    if (context == null) &#123;
        return false;
    &#125;
    BatteryStatus batteryStatus = BatteryHelper.getInstance(context).getBatteryStatus();
    this.level = batteryStatus.batteryLevel;
    this.scale = batteryStatus.batteryScale;
    int i = batteryStatus.batteryStatus;
    int i2 = batteryStatus.batteryPlugged;
    if (i == 2 &amp;&amp; i2 == 2) &#123;
        this.status = 1;
    &#125; else &#123;
        this.status = 0;
    &#125;
    if (i2 == 2) &#123;
        this.plugged = true;
    &#125; else &#123;
        this.plugged = false;
    &#125;
    return true;
&#125;
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getBatteryInfo()Z&quot;:&#123;
    return true;
&#125;
</code></pre>
<p>继续运行</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;level:I
	at com.github.unidbg.linux.android.dvm.AbstractJni.getIntField(AbstractJni.java:648)
	at com.github.unidbg.linux.android.dvm.AbstractJni.getIntField(AbstractJni.java:640)
</code></pre>
<p><strong>this.level</strong> 在上面的 getBatteryInfo 方法里进行了赋值，如果追根溯源，逻辑则来自于下面这段代码</p>
<pre><code class="language-Java">private void recordStatus(Intent intent) &#123;
    Object[] objArr = &#123;intent&#125;;
    ChangeQuickRedirect changeQuickRedirect2 = changeQuickRedirect;
    if (PatchProxy.isSupport(objArr, this, changeQuickRedirect2, false, &quot;ca80b285aa559be35b7dd31c0b707222&quot;, RobustBitConfig.DEFAULT_VALUE)) &#123;
        PatchProxy.accessDispatch(objArr, this, changeQuickRedirect2, false, &quot;ca80b285aa559be35b7dd31c0b707222&quot;);
    &#125; else if (intent == null) &#123;
    &#125; else &#123;
        try &#123;
            int intExtra = intent.getIntExtra(&quot;level&quot;, 0);
            int intExtra2 = intent.getIntExtra(&quot;scale&quot;, 100);
            int intExtra3 = intent.getIntExtra(&quot;status&quot;, -1);
            int intExtra4 = intent.getIntExtra(&quot;plugged&quot;, 0);
            this.mBatteryStatus.batteryTemperature = intent.getIntExtra(&quot;temperature&quot;, 0) / 10.0f;
            this.mBatteryStatus.batteryLevel = intExtra;
            this.mBatteryStatus.batteryScale = intExtra2;
            this.mBatteryStatus.batteryStatus = intExtra3;
            this.mBatteryStatus.batteryPlugged = intExtra4;
        &#125; catch (Exception e) &#123;
            c.a(e);
            DFPLog.error(e);
        &#125;
    &#125;
&#125;
</code></pre>
<p>level 就是当前电量，scale 是总电量，它并不一定是 100.status 表示是否处于充电状态，plugged 则表示充电模式，Android 有两种充电模式，1 是充电器充电，也叫 AC 充电。2 是 USB 充电，比如插在电脑上充电。</p>
<p>样本接下来会依次获取这四个字段，读者可以 Hook SIUACollector 实例，获取这些字段。查看实例中某些字段的值，这个场景用 <a target="_blank" rel="noopener" href="https://github.com/r0ysue/r0tracer/blob/main/r0tracer.js">r0tracer</a> 会很舒服。</p>
<pre><code class="language-java">//A. 简易trace单个函数
traceClass(&quot;com.meituan.android.common.mtguard.NBridge$SIUACollector&quot;)
</code></pre>
<p>在输出日志中可以找到下面这些</p>
<pre><code class="language-shell">int     level =&gt; 100 =&gt; 100
boolean         plugged =&gt; false =&gt; false
int     scale =&gt; 100 =&gt; 100
int     status =&gt; 0 =&gt; 0
</code></pre>
<p>根据结果补环境</p>
<pre><code class="language-Java">public int getIntField(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature) &#123;
        switch (signature) &#123;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;level:I&quot;: &#123;
                return 100;
            &#125;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;scale:I&quot;: &#123;
                return 100;
            &#125;
            case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;status:I&quot;: &#123;
                return 0;
            &#125;
        &#125;
        return  super.getIntField(vm, dvmObject, signature);
    &#125;
</code></pre>
<p>继续</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;plugged:Z
	at com.github.unidbg.linux.android.dvm.AbstractJni.getBooleanField(AbstractJni.java:717)
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">@Override
public boolean getBooleanField(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature) &#123;
    switch (signature)&#123;
        case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;plugged:Z&quot;:&#123;
            return false;
        &#125;
    &#125;
    return super.getBooleanField(vm, dvmObject, signature);
&#125;
</code></pre>
<p>电池相关的大概告一段落了</p>
<pre><code class="language-shell">java.lang.UnsupportedOperationException: com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getDataActivity(Landroid/content/Context;)Ljava/lang/String;
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:417)
	at com.test4.TEST4.callObjectMethodV(TEST4.java:424)
	at com.github.unidbg.linux.android.dvm.AbstractJni.callObjectMethodV(AbstractJni.java:262)
</code></pre>
<p>刚才的 r0tracer 还有用，日志中搜索 getDataActivity。</p>
<pre><code class="language-shell">retval: 0 =&gt; &quot;0&quot;
*** exiting com.meituan.android.common.mtguard.NBridge$SIUACollector.getDataActivity
</code></pre>
<p>补环境</p>
<pre><code class="language-Java">case &quot;com/meituan/android/common/mtguard/NBridge$SIUACollector-&gt;getDataActivity(Landroid/content/Context;)Ljava/lang/String;&quot;:
    return new StringObject(vm, &quot;0&quot;);
</code></pre>
<p>得出结果</p>
<pre><code class="language-shell">[*] getUserAction: -|100|1|0|0|-|92cbbca8-4858-40cd-b96c-4c52cd6eb17b|0|
</code></pre>
<h3 id="十三、尾声"><a href="#十三、尾声" class="headerlink" title="十三、尾声"></a>十三、尾声</h3><p>写过最长最枯燥的一次，写了三天…</p>
<h3 id="十四、参考"><a href="#十四、参考" class="headerlink" title="十四、参考"></a>十四、参考</h3><p><a target="_blank" rel="noopener" href="https://www.yuque.com/lilac-2hqvv/xdwlsg/avlc01hrko6yvr26#L4RNF">Unidbg 的基本使用（六）</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 1621925986@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">💰</a>
</p>




    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: 'Ov23lif2sndX4YqUPQwk',
            clientSecret: 'c76a4c487d51bf36e4dd1496b3f44bdbea037d50',
            repo: 'NshIdE1.github.io',
            owner: 'NshIdE1',
            admin: ['NshIdE1'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2024-2025 NshIdE
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="Toggle full screen shortcut key s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    

    
</style>







</html>
