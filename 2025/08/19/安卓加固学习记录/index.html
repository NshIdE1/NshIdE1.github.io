<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>å®‰å“åŠ å›ºå­¦ä¹ è®°å½• | NshIdE&#39;s Home</title>
  <meta name="keywords" content=" Android ">
  <meta name="description" content="å®‰å“åŠ å›ºå­¦ä¹ è®°å½• | NshIdE&#39;s Home">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="categories">
<meta property="og:url" content="https://nshide1.github.io/categories/">
<meta property="og:site_name" content="NshIdE&#39;s Home">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2025-03-04T12:19:41.475Z">
<meta property="article:modified_time" content="2025-03-04T12:19:41.475Z">
<meta property="article:author" content="NshIdE">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/logo.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-dark.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0" ></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.1.0" ></script>

<meta name="generator" content="Hexo 7.3.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="">
  <input class="theme_blog_path" value="">
  <input id="theme_shortcut" value="true" />
  <input id="theme_highlight_on" value="true" />
  <input id="theme_code_copy" value="true" />
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/"
   class="avatar_target">
    <img class="avatar"
         src="/img/logo.jpg"/>
</a>
<div class="author">
    <span>NshIdE</span>
</div>

<div class="icon">
    
        
            <a title="github"
               href="https://github.com/NshIdE1/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-github"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="zhihu"
               href="https://www.zhihu.com/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-zhihu"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="csdn"
               href="https://www.csdn.net/"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-csdn"></use>
                    </svg>
                
            </a>
        
    
        
            <a title="qq"
               href="http://wpa.qq.com/msgrd?v=3&uin=1621925986&site=qq&menu=yes"
               target="_blank">
                
                    <svg class="iconfont-svg" aria-hidden="true">
                        <use xlink:href="#icon-qq"></use>
                    </svg>
                
            </a>
        
    
</div>





<ul>
    <li>
        <div class="all active" data-rel="All">All
            
                <small>(42)</small>
            
        </div>
    </li>
    
        
            
                
    <li>
        <div data-rel="å…¶ä»–">
            
            å…¶ä»–
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Android-RE">
            
            Android-RE
            <small>(2)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Androidå­¦ä¹ ">
            
            Androidå­¦ä¹ 
            <small>(10)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Angrå…¥é—¨">
            
            Angrå…¥é—¨
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="CTF">
            
            CTF
            <small>(16)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Fridaå…¥é—¨">
            
            Fridaå…¥é—¨
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Javaå­¦ä¹ ">
            
            Javaå­¦ä¹ 
            <small>(1)</small>
        </div>
        
    </li>

            
        
    
        
            
                
    <li>
        <div data-rel="Unidbgå­¦ä¹ ">
            
            Unidbgå­¦ä¹ 
            <small>(10)</small>
        </div>
        
    </li>

            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
        
            
            
            
    </div>
    <div>
        
            <a class="about  hasFriend  site_url"
               
               href="/about">About</a>
        
        <a style="width: 50%"
                
                                           class="friends">Friends</a>
        
    </div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="42">
<input type="hidden" id="yelog_site_word_count" value="231.8k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        Links
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://bananashipsbbq.github.io/">bananaships</a></li>
            
            <li><a target="_blank" href="https://astralprisma.github.io/">AstralPrisma</a></li>
            
            <li><a target="_blank" href="https://monoceros406.github.io/">Monoceros406</a></li>
            
            <li><a target="_blank" href="https://github.com/Thir0th">Thir0th</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="search shortcut key i"></i>
            <div class="right-title">All</div>
            <i class="iconfont icon-file-tree" data-title="switch to outline view shortcut key w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="return"></i>
            <input id="local-search-input" autocomplete="off"/>
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="case sensitive"></i>
            <i class="iconfont icon-tag" data-title="label"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">outline</div>
            <i class="iconfont icon-list" data-title="switch to article list"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>æŠ½è±¡</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ç¬¦å·æ‰§è¡Œ</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>å–è¯</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>å®æˆ˜</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>åº”æ€¥å“åº”</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Android</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>CTF</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Frida</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>go</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Harmony</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>il2Cpps</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>iOS</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>ISW</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Java</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Linux</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>RE</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>SIMD</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Unidbg</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>Unity</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>vm</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>WritesUp</a>
            </li>
        
    </div>

</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        
        <a  class="All CTF "
           href="/2026/01/04/HitCTF2025-Reverse%C2%B7VM/"
           data-tag="CTF,RE,WritesUp,vm"
           data-author="" >
            <span class="post-title" title="HitCTF2025-ReverseÂ·VM">HitCTF2025-ReverseÂ·VM</span>
            <span class="post-date" title="2026-01-04 16:19:02">2026/01/04</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/11/03/%E6%9F%90%E9%BB%91%E7%9B%92%20App%20%E7%99%BB%E5%BD%95%E5%8F%82%E6%95%B0%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"
           data-tag="Android,å®æˆ˜"
           data-author="" >
            <span class="post-title" title="æŸé»‘ç›’ App ç™»å½•å‚æ•°é€†å‘åˆ†æ">æŸé»‘ç›’ App ç™»å½•å‚æ•°é€†å‘åˆ†æ</span>
            <span class="post-date" title="2025-11-03 16:15:21">2025/11/03</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/10/25/%E7%AC%AC%E5%85%AB%E5%B1%8A%E5%BC%BA%E7%BD%91%C2%B7%E6%8B%9F%E6%80%81%E9%98%B2%E5%BE%A1%E5%9B%BD%E9%99%85%E7%B2%BE%E8%8B%B1%E6%8C%91%E6%88%98%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,Android,il2Cpps"
           data-author="" >
            <span class="post-title" title="ç¬¬å…«å±Šå¼ºç½‘Â·æ‹Ÿæ€é˜²å¾¡å›½é™…ç²¾è‹±æŒ‘æˆ˜èµ›">ç¬¬å…«å±Šå¼ºç½‘Â·æ‹Ÿæ€é˜²å¾¡å›½é™…ç²¾è‹±æŒ‘æˆ˜èµ›</span>
            <span class="post-date" title="2025-10-25 17:31:37">2025/10/25</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/10/22/Android%20APP%20%E5%B8%B8%E8%A7%81%E6%BC%8F%E6%B4%9E/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android APP å¸¸è§æ¼æ´">Android APP å¸¸è§æ¼æ´</span>
            <span class="post-date" title="2025-10-22 17:06:07">2025/10/22</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/10/10/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20PackageInfo%20%E5%92%8C%20LoadedApk/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="ä»æºç åˆ†æ PackageInfo å’Œ LoadedApk">ä»æºç åˆ†æ PackageInfo å’Œ LoadedApk</span>
            <span class="post-date" title="2025-10-10 18:15:17">2025/10/10</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/09/09/2025%E5%B9%B4%E6%B9%BE%E5%8C%BA%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E5%88%9D%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="2025å¹´æ¹¾åŒºæ¯ç½‘ç»œå®‰å…¨å¤§èµ›åˆèµ›">2025å¹´æ¹¾åŒºæ¯ç½‘ç»œå®‰å…¨å¤§èµ›åˆèµ›</span>
            <span class="post-date" title="2025-09-09 09:34:17">2025/09/09</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/09/08/Android%20SO%20%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android SO æ–‡ä»¶åŠ è½½è¿‡ç¨‹">Android SO æ–‡ä»¶åŠ è½½è¿‡ç¨‹</span>
            <span class="post-date" title="2025-09-08 17:18:50">2025/09/08</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/25/Dex%20%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E5%AD%A6%E4%B9%A0/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Dex æ–‡ä»¶ç»“æ„å­¦ä¹ ">Dex æ–‡ä»¶ç»“æ„å­¦ä¹ </span>
            <span class="post-date" title="2025-08-25 17:33:29">2025/08/25</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/19/ClassLoader%20%E6%9C%BA%E5%88%B6/"
           data-tag="Android,Java"
           data-author="" >
            <span class="post-title" title="ClassLoader æœºåˆ¶">ClassLoader æœºåˆ¶</span>
            <span class="post-date" title="2025-08-19 17:42:51">2025/08/19</span>
        </a>
        
        
        <a  class="All Javaå­¦ä¹  "
           href="/2025/08/19/Java%E5%AD%A6%E4%B9%A0%E2%80%94%E2%80%94%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/"
           data-tag="Android,Java"
           data-author="" >
            <span class="post-title" title="Javaå­¦ä¹ ----åå°„æœºåˆ¶">Javaå­¦ä¹ ----åå°„æœºåˆ¶</span>
            <span class="post-date" title="2025-08-19 17:00:02">2025/08/19</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/19/Android%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android åº”ç”¨å¯åŠ¨æµç¨‹">Android åº”ç”¨å¯åŠ¨æµç¨‹</span>
            <span class="post-date" title="2025-08-19 11:14:13">2025/08/19</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/19/%E5%AE%89%E5%8D%93%E5%8A%A0%E5%9B%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="å®‰å“åŠ å›ºå­¦ä¹ è®°å½•">å®‰å“åŠ å›ºå­¦ä¹ è®°å½•</span>
            <span class="post-date" title="2025-08-19 10:50:46">2025/08/19</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/14/Android%20%E5%BC%80%E5%8F%91%E2%80%94%E2%80%94NDK%20%E5%BC%80%E5%8F%91/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="Android å¼€å‘--NDK å¼€å‘">Android å¼€å‘--NDK å¼€å‘</span>
            <span class="post-date" title="2025-08-14 17:56:58">2025/08/14</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/08/10/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E5%85%AD)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(å…­)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(å…­)</span>
            <span class="post-date" title="2025-08-10 10:25:02">2025/08/10</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/08/08/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%BA%94)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(äº”)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(äº”)</span>
            <span class="post-date" title="2025-08-08 17:45:59">2025/08/08</span>
        </a>
        
        
        <a  class="All Androidå­¦ä¹  "
           href="/2025/08/05/%E6%BC%AB%E8%B0%88%E5%94%AF%E4%B8%80%E8%AE%BE%E5%A4%87ID/"
           data-tag="Android"
           data-author="" >
            <span class="post-title" title="æ¼«è°ˆå”¯ä¸€è®¾å¤‡ ID">æ¼«è°ˆå”¯ä¸€è®¾å¤‡ ID</span>
            <span class="post-date" title="2025-08-05 18:00:44">2025/08/05</span>
        </a>
        
        
        <a  class="All å…¶ä»– "
           href="/2025/07/24/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%20Linux%20%E7%B3%BB%E7%BB%9F%E4%B8%8B%20proc%20%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%86%85%E5%AE%B9/"
           data-tag="Android,Linux"
           data-author="" >
            <span class="post-title" title="æµ…è°ˆ Linux ç³»ç»Ÿä¸‹ proc æ–‡ä»¶ç³»ç»Ÿå†…å®¹">æµ…è°ˆ Linux ç³»ç»Ÿä¸‹ proc æ–‡ä»¶ç³»ç»Ÿå†…å®¹</span>
            <span class="post-date" title="2025-07-24 17:56:57">2025/07/24</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/07/24/Unidbg%20%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%EF%BC%88%E4%BA%8C%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="Unidbg ä¸­å¤„ç†æ–‡ä»¶è®¿é—®(äºŒ)">Unidbg ä¸­å¤„ç†æ–‡ä»¶è®¿é—®(äºŒ)</span>
            <span class="post-date" title="2025-07-24 17:00:12">2025/07/24</span>
        </a>
        
        
        <a  class="All Android-RE "
           href="/2025/07/23/2025%E7%AC%AC%E5%8D%81%E5%B1%8A%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9D%E8%B5%9B-%E5%AE%89%E5%8D%93%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8/"
           data-tag="RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="2025ç¬¬åå±Šæ¸¸æˆå®‰å…¨ç«èµ›-åˆèµ›-å®‰å“å®¢æˆ·ç«¯å®‰å…¨">2025ç¬¬åå±Šæ¸¸æˆå®‰å…¨ç«èµ›-åˆèµ›-å®‰å“å®¢æˆ·ç«¯å®‰å…¨</span>
            <span class="post-date" title="2025-07-23 15:32:11">2025/07/23</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/07/19/%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%8B%9F%E5%99%A8%E5%92%8C%E5%8A%A0%E8%BD%BD%E6%A8%A1%E5%9D%97/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="åˆ›å»ºæ¨¡æ‹Ÿå™¨å’ŒåŠ è½½æ¨¡å—">åˆ›å»ºæ¨¡æ‹Ÿå™¨å’ŒåŠ è½½æ¨¡å—</span>
            <span class="post-date" title="2025-07-19 15:14:29">2025/07/19</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/07/15/Unidbg%20%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE%EF%BC%88%E4%B8%80%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="Unidbg ä¸­å¤„ç†æ–‡ä»¶è®¿é—®(ä¸€)">Unidbg ä¸­å¤„ç†æ–‡ä»¶è®¿é—®(ä¸€)</span>
            <span class="post-date" title="2025-07-15 16:52:06">2025/07/15</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/07/08/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E5%9B%9B)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(å››)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(å››)</span>
            <span class="post-date" title="2025-07-08 11:44:49">2025/07/08</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/07/01/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%B8%89)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(ä¸‰)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(ä¸‰)</span>
            <span class="post-date" title="2025-07-01 15:29:42">2025/07/01</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/06/07/%E7%AC%AC%E4%B8%80%E5%B1%8AOpenHarmonyCTF/"
           data-tag="CTF,RE,WritesUp,Harmony"
           data-author="" >
            <span class="post-title" title="ç¬¬ä¸€å±ŠOpenHarmonyCTF">ç¬¬ä¸€å±ŠOpenHarmonyCTF</span>
            <span class="post-date" title="2025-06-07 13:32:45">2025/06/07</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/06/04/%E8%A1%A5%E5%BA%93%E5%87%BD%E6%95%B0%EF%BC%88%E4%BA%94%EF%BC%89/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="è¡¥åº“å‡½æ•°(äº”)">è¡¥åº“å‡½æ•°(äº”)</span>
            <span class="post-date" title="2025-06-04 19:07:56">2025/06/04</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/06/02/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%BA%8C)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(äºŒ)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(äºŒ)</span>
            <span class="post-date" title="2025-06-02 15:33:15">2025/06/02</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/05/31/D%5E3CTF2025/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="D^3CTF2025">D^3CTF2025</span>
            <span class="post-date" title="2025-05-31 16:21:11">2025/05/31</span>
        </a>
        
        
        <a  class="All Unidbgå­¦ä¹  "
           href="/2025/05/28/%E4%BB%8E%E5%AE%9E%E8%B7%B5%E4%B8%AD%E5%AD%A6%E4%B9%A0unidbg%E4%BD%BF%E7%94%A8(%E4%B8%80)/"
           data-tag="Unidbg"
           data-author="" >
            <span class="post-title" title="ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(ä¸€)">ä»å®è·µä¸­å­¦ä¹ unidbgä½¿ç”¨(ä¸€)</span>
            <span class="post-date" title="2025-05-28 16:39:23">2025/05/28</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/05/17/Parloo2025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="Parloo RE">Parloo RE</span>
            <span class="post-date" title="2025-05-17 09:34:20">2025/05/17</span>
        </a>
        
        
        <a  class="All Android-RE "
           href="/2025/05/07/%E8%AE%B0%E4%B8%80%E6%AC%A1APK%E5%88%86%E6%9E%90/"
           data-tag="RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="è®°ä¸€æ¬¡APKåˆ†æ">è®°ä¸€æ¬¡APKåˆ†æ</span>
            <span class="post-date" title="2025-05-07 21:12:00">2025/05/07</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/26/%E4%B8%80%E9%81%93%E5%BE%88%E9%80%86%E5%A4%A9%E7%9A%84RC4/"
           data-tag="CTF,RE,WritesUp,æŠ½è±¡"
           data-author="" >
            <span class="post-title" title="æŠ½è±¡RC4">æŠ½è±¡RC4</span>
            <span class="post-date" title="2025-04-26 22:21:19">2025/04/26</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/24/%E5%BE%88%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E4%B8%80%E9%81%93%E9%A2%98/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="å¾ˆæœ‰æ„æ€çš„ä¸€é“é¢˜">å¾ˆæœ‰æ„æ€çš„ä¸€é“é¢˜</span>
            <span class="post-date" title="2025-04-24 21:56:18">2025/04/24</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/23/%E4%BA%AC%E9%BA%92CTF2025%20%E7%83%AD%E8%BA%AB%E8%B5%9B/"
           data-tag="CTF,RE,WritesUp,iOS,SIMD"
           data-author="" >
            <span class="post-title" title="äº¬éº’CTF2025çƒ­èº«èµ›">äº¬éº’CTF2025çƒ­èº«èµ›</span>
            <span class="post-date" title="2025-04-23 13:33:59">2025/04/23</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/14/TGCTF2025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TGCTF2025 RE">TGCTF2025 RE</span>
            <span class="post-date" title="2025-04-14 18:51:29">2025/04/14</span>
        </a>
        
        
        <a  class="All Angrå…¥é—¨ "
           href="/2025/04/14/Angr%E5%85%A5%E9%97%A8/"
           data-tag="ç¬¦å·æ‰§è¡Œ"
           data-author="" >
            <span class="post-title" title="Angrå…¥é—¨">Angrå…¥é—¨</span>
            <span class="post-date" title="2025-04-14 18:50:44">2025/04/14</span>
        </a>
        
        
        <a  class="All Fridaå…¥é—¨ "
           href="/2025/04/14/Frida%E5%85%A5%E9%97%A8/"
           data-tag="Android,Frida"
           data-author="" >
            <span class="post-title" title="Fridaå…¥é—¨">Fridaå…¥é—¨</span>
            <span class="post-date" title="2025-04-14 18:47:37">2025/04/14</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/04/12/TEXSAWCTF%202025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TEXSAWCTF 2025">TEXSAWCTF 2025</span>
            <span class="post-date" title="2025-04-12 15:32:31">2025/04/12</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/23/NCTF2024/"
           data-tag="CTF,RE,WritesUp,vm,go"
           data-author="" >
            <span class="post-title" title="NCTF2024">NCTF2024</span>
            <span class="post-date" title="2025-03-23 11:58:53">2025/03/23</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/18/CISCN%20x%20CCB%20%E5%8D%8A%E5%86%B3%E8%B5%9B%202025%20ISW(%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94)/"
           data-tag="ISW,åº”æ€¥å“åº”,å–è¯"
           data-author="" >
            <span class="post-title" title="CISCN x CCB åŠå†³èµ› 2025 ISW(åº”æ€¥å“åº”)">CISCN x CCB åŠå†³èµ› 2025 ISW(åº”æ€¥å“åº”)</span>
            <span class="post-date" title="2025-03-18 10:24:23">2025/03/18</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/11/TPCTF%202025/"
           data-tag="CTF,RE,WritesUp"
           data-author="" >
            <span class="post-title" title="TPCTF 2025">TPCTF 2025</span>
            <span class="post-date" title="2025-03-11 21:41:19">2025/03/11</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/06/VishwaCTF2025/"
           data-tag="CTF,RE,WritesUp,Android,Unity"
           data-author="" >
            <span class="post-title" title="VishwaCTF2025">VishwaCTF2025</span>
            <span class="post-date" title="2025-03-06 21:52:51">2025/03/06</span>
        </a>
        
        
        <a  class="All CTF "
           href="/2025/03/03/HGAME%20RE/"
           data-tag="CTF,RE,WritesUp,Android"
           data-author="" >
            <span class="post-title" title="HGAME-RE-WEEK1">HGAME-RE-WEEK1</span>
            <span class="post-date" title="2025-03-03 22:20:33">2025/03/03</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>

    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="Toggle full screen shortcut key s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-å®‰å“åŠ å›ºå­¦ä¹ è®°å½•" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">å®‰å“åŠ å›ºå­¦ä¹ è®°å½•</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="Androidå­¦ä¹ ">Androidå­¦ä¹ </a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color3">Android</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            Created At : <time class="date" title='Updated At: 2025-08-27 11:25:37'>2025-08-19 10:50</time>
        
    </div>
    <div class="article-meta">
        
        <span>Count:20.7k</span>
        
        
        <span id="busuanzi_container_page_pv">
            Views ğŸ‘€ :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="Jump to comment area">
            <a href="#comments">
                Comment:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E5%8D%93%E5%8A%A0%E5%9B%BA%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95"><span class="toc-text">å®‰å“åŠ å›ºå­¦ä¹ è®°å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-text">ä¸€ã€å‰è¨€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%AC%AC%E4%B8%80%E3%80%81%E4%BA%8C%E4%BB%A3%E5%A3%B3-Dex-%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA"><span class="toc-text">äºŒã€ç¬¬ä¸€ã€äºŒä»£å£³ Dex æ•´ä½“åŠ å›º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Dex-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="toc-text">Dex æ–‡ä»¶ç»“æ„</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BB%A3%E5%A3%B3%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">ä¸€ä»£å£³å®ç°åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%BB%A3%E5%A3%B3-%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%EF%BC%88%E8%90%BD%E5%9C%B0%E5%8A%A0%E8%BD%BD%EF%BC%89"><span class="toc-text">ä¸€ä»£å£³-æ•´ä½“åŠ å›ºï¼ˆè½åœ°åŠ è½½ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-text"></span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A8%8B%E5%BA%8F"><span class="toc-text">æºç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#MainActivity-java"><span class="toc-text">MainActivity.java</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#MyApplication-java"><span class="toc-text">MyApplication.java</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#native-lib-cpp"><span class="toc-text">native-lib.cpp</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AndroidManifest-xml"><span class="toc-text">AndroidManifest.xml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#activity-main-xml"><span class="toc-text">activity_main.xml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3%E7%A8%8B%E5%BA%8F"><span class="toc-text">åŠ å£³ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#FirstShell-py"><span class="toc-text">FirstShell.py</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%84%B1%E5%A3%B3%E7%A8%8B%E5%BA%8F"><span class="toc-text">è„±å£³ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#FirstProxyApplication-java"><span class="toc-text">FirstProxyApplication.java</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Reflection-java"><span class="toc-text">Reflection.java</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#AndroidManifest-xml-1"><span class="toc-text">AndroidManifest.xml</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E4%BB%A3%E5%A3%B3-%E6%95%B4%E4%BD%93%E5%8A%A0%E5%9B%BA%EF%BC%88%E4%B8%8D%E8%90%BD%E5%9C%B0%E5%8A%A0%E8%BD%BD%EF%BC%89"><span class="toc-text">äºŒä»£å£³-æ•´ä½“åŠ å›ºï¼ˆä¸è½åœ°åŠ è½½ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-text">åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A8%8B%E5%BA%8F-1"><span class="toc-text">æºç¨‹åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3%E7%A8%8B%E5%BA%8F-1"><span class="toc-text">åŠ å£³ç¨‹åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%84%B1%E5%A3%B3%E7%A8%8B%E5%BA%8F-1"><span class="toc-text">è„±å£³ç¨‹åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%AC%AC%E4%B8%89%E4%BB%A3%E5%A3%B3-%E6%8A%BD%E5%8F%96%E5%8A%A0%E5%9B%BA"><span class="toc-text">ä¸‰ã€ç¬¬ä¸‰ä»£å£³-æŠ½å–åŠ å›º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-text">åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A8%8B%E5%BA%8F3"><span class="toc-text">æºç¨‹åº3</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3%E7%A8%8B%E5%BA%8F-2"><span class="toc-text">åŠ å£³ç¨‹åº</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%84%B1%E5%A3%B3%E7%A8%8B%E5%BA%8F-2"><span class="toc-text">è„±å£³ç¨‹åº</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">ç¯å¢ƒåˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2-ClassLoader"><span class="toc-text">æ›¿æ¢ ClassLoader</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2-application"><span class="toc-text">æ›¿æ¢ application</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#Native-%E5%B1%82"><span class="toc-text">Native å±‚</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#ThirdProxyApplication-java"><span class="toc-text">ThirdProxyApplication.java</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#shell-cpp"><span class="toc-text">shell.cpp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E5%8A%A0%E5%9B%BA%E6%B5%8B%E8%AF%95"><span class="toc-text">å››ã€åŠ å›ºæµ‹è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%8F%82%E8%80%83"><span class="toc-text">äº”ã€å‚è€ƒ</span></a></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="å®‰å“åŠ å›ºå­¦ä¹ è®°å½•"><a href="#å®‰å“åŠ å›ºå­¦ä¹ è®°å½•" class="headerlink" title="å®‰å“åŠ å›ºå­¦ä¹ è®°å½•"></a>å®‰å“åŠ å›ºå­¦ä¹ è®°å½•</h1><h3 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h3><p>â€‹        è¿‘æœŸå¼€å§‹æ¥è§¦å…¬å¸çš„åŠ å›ºä¸šåŠ¡â€”â€”Android App åŠ å›ºï¼Œç”±äºä¹‹å‰åœ¨ CTF ä¸­é‡åˆ°çš„åŠ å›ºä¸€æ˜¯å°‘ï¼ŒäºŒæ˜¯éƒ½ä¸éš¾ï¼Œfrida-dump åŸºæœ¬éƒ½èƒ½ç§’ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰è¾ƒä¸ºç³»ç»Ÿçš„å»å­¦ä¹ äº†è§£å®‰å“åŠ å›ºè¿™ä¸€å—ã€‚æ‰€ä»¥åœ¨çœ‹é›ªä¸Šæ‰¾äº†ä¸€äº›è¾ƒä¸ºè¯¦ç»†çš„æ–‡ç« è¿›è¡Œå­¦ä¹ å¹¶è®°å½•ï¼ŒåŒæ—¶ä¹Ÿä¼šè¡¥å……ä¸€äº›ä¸ªäººçš„ç†è§£æˆ–è€…åœ¨åŸæ–‡ç« ä¸­è®²çš„ä¸é‚£ä¹ˆè¯¦ç»†çš„ç‚¹åŠ ä»¥è¡¥å……ã€‚</p>
<h3 id="äºŒã€ç¬¬ä¸€ã€äºŒä»£å£³-Dex-æ•´ä½“åŠ å›º"><a href="#äºŒã€ç¬¬ä¸€ã€äºŒä»£å£³-Dex-æ•´ä½“åŠ å›º" class="headerlink" title="äºŒã€ç¬¬ä¸€ã€äºŒä»£å£³ Dex æ•´ä½“åŠ å›º"></a>äºŒã€ç¬¬ä¸€ã€äºŒä»£å£³ Dex æ•´ä½“åŠ å›º</h3><p>â€‹        <strong>ç¬¬ä¸€ä»£å£³</strong>ä¸»è¦æ˜¯å¯¹ **dex&#x2F;APK ** æ–‡ä»¶æ•´ä½“è¿›è¡ŒåŠ å¯†ï¼Œç„¶åä½¿ç”¨è‡ªå®šä¹‰åŠ è½½å™¨åŠ¨æ€åŠ è½½ dex&#x2F;APK æ–‡ä»¶å¹¶æ‰§è¡Œã€‚è€Œ <strong>åŠ¨æ€åŠ è½½</strong> åˆåˆ†ä¸º <strong>è½åœ°åŠ è½½</strong> å’Œ <strong>ä¸è½åœ°åŠ è½½</strong>ï¼Œè½åœ°åŠ è½½å°±æ˜¯é€šè¿‡ <strong>DexClassLoader</strong> ä»ç£ç›˜åŠ è½½ dex&#x2F;APK æ–‡ä»¶ï¼Œ<strong>ä¸è½åœ°åŠ è½½</strong> å°±æ˜¯é€šè¿‡ <strong>InMemoryDexClassLoader</strong> ä»å†…å­˜ä¸­åŠ è½½ dex&#x2F;APK æ–‡ä»¶ã€‚</p>
<p>â€‹        è¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸Šé¢æåˆ°çš„ <strong>ç£ç›˜</strong> å’Œ <strong>å†…å­˜</strong> åˆ†åˆ«çš„å«ä¹‰ï¼Œç£ç›˜æŒ‡çš„æ˜¯ <strong>Android æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å­˜å‚¨ç©ºé—´</strong>ï¼Œé€šå¸¸æ˜¯åº”ç”¨çš„ç§æœ‰å­˜å‚¨ç›®å½•ï¼ˆ<code>/data/data/&lt;package&gt;/</code> ä¸‹ï¼‰ï¼Œæˆ–è€…å¤–éƒ¨å­˜å‚¨å¡è·¯å¾„ï¼Œä½¿ç”¨ <strong>DexClassLoader</strong> æ—¶ï¼Œéœ€è¦å…ˆæŠŠ .dex æˆ– .apk æ–‡ä»¶ä»¥çœŸå®æ–‡ä»¶å½¢å¼å­˜æ”¾åœ¨ç£ç›˜ä¸Šï¼Œç„¶å DexClassLoader ä¼šé€šè¿‡æ–‡ä»¶è·¯å¾„å»è¯»å–å’ŒåŠ è½½å­—èŠ‚ç ï¼Œæ•…ç§°ä¹‹ä¸º <strong>è½åœ°</strong>ï¼›<strong>å†…å­˜</strong> æŒ‡çš„æ˜¯ <strong>è¿›ç¨‹çš„å †å†…å­˜ï¼ˆRAMï¼‰</strong>ï¼Œå³ç”± Java ä»£ç ç›´æ¥æŒæœ‰çš„ <strong>ByteBuffer</strong> æˆ– byte[]ï¼Œä½¿ç”¨ <strong>InMemoryDexClassLoader</strong> æ—¶ï¼Œä¸éœ€è¦åœ¨ç£ç›˜ä¸Šç”Ÿæˆ .dex æ–‡ä»¶ï¼Œè€Œæ˜¯å¯ä»¥ç›´æ¥æŠŠå­—èŠ‚ç å­˜æ”¾åœ¨å†…å­˜ï¼ˆé€šå¸¸æ˜¯é€šè¿‡ç½‘ç»œä¸‹è½½çš„å­—èŠ‚æµã€è§£å¯†åçš„å­—èŠ‚æ•°ç»„ã€æˆ– mmap çš„ bufferï¼‰ï¼Œç„¶åç›´æ¥ä¼ ç»™ InMemoryDexClassLoader æ¥åŠ è½½ï¼Œè¿™æ ·ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­ä¸ä¼šåœ¨ç£ç›˜ä¸­äº§ç”ŸæŒä¹…åŒ–çš„ dex æ–‡ä»¶ï¼Œæ•…ç§°ä¹‹ä¸º <strong>ä¸è½åœ°</strong>ã€‚</p>
<h4 id="Dex-æ–‡ä»¶ç»“æ„"><a href="#Dex-æ–‡ä»¶ç»“æ„" class="headerlink" title="Dex æ–‡ä»¶ç»“æ„"></a>Dex æ–‡ä»¶ç»“æ„</h4><p>å€Ÿç”¨æ–‡ç« é‡Œçš„å›¾<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250819103114984.png" alt="image-20250819103114984"></p>
<h4 id="ä¸€ä»£å£³å®ç°åŸç†"><a href="#ä¸€ä»£å£³å®ç°åŸç†" class="headerlink" title="ä¸€ä»£å£³å®ç°åŸç†"></a>ä¸€ä»£å£³å®ç°åŸç†</h4><p><strong>App çš„å¯åŠ¨æµç¨‹</strong><br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250819103443269.png" alt="image-20250819103443269"></p>
<p>â€‹        é€šè¿‡å°†åŸ APK è¿›è¡ŒåŠ å¯†åä¿å­˜åœ¨åŠ å£³ APK çš„ dex æ–‡ä»¶å°¾éƒ¨ï¼Œåœ¨åŠ å£³ APK è¿è¡Œæ—¶å°† dex æ–‡ä»¶å°¾éƒ¨åŠ å¯†çš„åŸ APK æ–‡ä»¶è§£å¯†åè¿›è¡ŒåŠ¨æ€åŠ è½½ã€‚ï¼ˆè¿™é‡Œæåˆ°çš„åŠ å£³ APK ä¹Ÿç¡®å®æ˜¯ä¸€ä¸ªçœŸæ­£çš„ APK æ–‡ä»¶ï¼ŒåŒ…å«å®Œæ•´çš„ APK æ–‡ä»¶ç»“æ„ï¼Œä½†æ˜¯å¹¶æ— ä¸šåŠ¡ä»£ç ï¼Œè€Œæ˜¯ <strong>è´Ÿè´£åŠ è½½ã€è§£å¯†ã€å†è¿è¡ŒçœŸæ­£çš„åŸå§‹ APK</strong>ï¼‰ã€‚</p>
<p>â€‹        å£³ä»£ç éœ€è¦æœ€æ—©å›å»åˆ° åŠ å£³APK çš„æ‰§è¡Œæ—¶æœºï¼Œæ‰€ä»¥ åŠ å£³APK çš„ Application å®ç°äº† <strong>attachContextApplication</strong> å‡½æ•°ï¼Œæ­¤å‡½æ•°åœ¨ <strong>handleBindApplication</strong> å‡½æ•°ä¸­é€šè¿‡è°ƒç”¨ <strong>makeApplication</strong> è¿›è¡Œè°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ª APP è¿›ç¨‹æœ€æ—©çš„æ‰§è¡Œå…¥å£ã€‚ï¼ˆæœ‰å…³ Android åº”ç”¨å¯åŠ¨æµç¨‹å¯ä»¥çœ‹è¿™ç¯‡<a href="https://nshide1.github.io/2025/08/19/Android%20%E5%BA%94%E7%94%A8%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">æ–‡ç« </a>ï¼‰ã€‚</p>
<p>â€‹        åŠ å£³ APK éœ€è¦è¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<ul>
<li><strong>attachContextApplication</strong> è§£å¯†åŸ APK ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼ˆä¸è½åœ°åŠ è½½å¯ä»¥ä¸ä¿å­˜ç£ç›˜æ–‡ä»¶ï¼‰ï¼ŒåŠ¨æ€åŠ è½½è§£å¯†åçš„ APK å¹¶æ›¿æ¢æ‰ <strong>mClassLoader</strong>ã€‚</li>
<li><strong>Application::onCreate</strong> é‡å®šä½ Applicationï¼Œè°ƒç”¨åŸ APK çš„ Application çš„ onCreate å‡½æ•°ã€‚</li>
</ul>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250819112238763.png" alt="image-20250819112238763"></p>
<p>è¿™é‡Œå†è¡¥å……è§£é‡Šä¸€ä¸‹ <strong>mClassLoader</strong> å’Œ <strong>Application::onCreate</strong>ï¼š</p>
<ul>
<li><strong>mClassLoader</strong> æ˜¯ <strong>Android ç³»ç»Ÿå†…éƒ¨  LoadedApk  å¯¹è±¡çš„ä¸€ä¸ªå­—æ®µ</strong>ï¼Œå®ƒè¡¨ç¤ºè¿™ä¸ª APK å¯¹åº”çš„ <strong>ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰</strong>ï¼›åœ¨ Android ä¸­ï¼Œæ¯ä¸ª APK éƒ½æœ‰ä¸€ä¸ª LoadedApk å¯¹è±¡ï¼Œé‡Œé¢åŒ…å«ï¼šAPK çš„è·¯å¾„ã€èµ„æºï¼ˆResourcesï¼‰ã€ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰â€“&gt; mClassLoaderï¼›<strong>åŠŸèƒ½</strong>ï¼šç³»ç»Ÿé€šè¿‡ mClassLoader å»åŠ è½½ APK é‡Œçš„ç±»ï¼ˆJava&#x2F;DEX ç±»ï¼‰ï¼ŒåŒ…æ‹¬ Activityã€Serviceã€Application ç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒmClassLoader æ˜¯ <strong>PathClassLoader</strong>ï¼ŒåŠ è½½ APK è‡ªå¸¦çš„ dex æ–‡ä»¶ã€‚</li>
<li><strong>Application::onCreate()</strong> æ˜¯ <strong>Application ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°</strong>ï¼Œåœ¨ <strong>attach()</strong> åè°ƒç”¨ï¼›<strong>åŠŸèƒ½</strong>ï¼šæ‰§è¡Œå…¨å±€åˆå§‹åŒ–é€»è¾‘ï¼Œä¾‹å¦‚ï¼Œåˆå§‹åŒ– SDKã€è®¾ç½®å…¨å±€å•ä¾‹ã€åŠ è½½é…ç½®ï¼Œè¿™æ˜¯åº”ç”¨åœ¨å¯åŠ¨æ—¶çš„â€œç¬¬ä¸€ä¸ªæ‰§è¡Œç‚¹â€ï¼Œæ¯”ä»»ä½• Activity çš„ <code>onCreate()</code> éƒ½æ—©ã€‚</li>
</ul>
<h4 id="ä¸€ä»£å£³-æ•´ä½“åŠ å›ºï¼ˆè½åœ°åŠ è½½ï¼‰"><a href="#ä¸€ä»£å£³-æ•´ä½“åŠ å›ºï¼ˆè½åœ°åŠ è½½ï¼‰" class="headerlink" title="ä¸€ä»£å£³-æ•´ä½“åŠ å›ºï¼ˆè½åœ°åŠ è½½ï¼‰"></a>ä¸€ä»£å£³-æ•´ä½“åŠ å›ºï¼ˆè½åœ°åŠ è½½ï¼‰</h4><p>â€‹        ä¸€ä»£åŠ å›ºæ˜¯æ‰€æœ‰åŠ å›ºçš„åŸºç¡€ï¼Œäº†è§£ä¸€ä»£åŠ å›ºçš„åŸºæœ¬æ€è·¯æœ‰åŠ©äºç†è§£åç»­åŠ å›ºæŠ€æœ¯çš„æ¼”è¿›ã€‚</p>
<p><strong>åŸç†</strong>ï¼š</p>
<p>ä¸»è¦æ¶‰åŠä¸‰ä¸ªå¯¹è±¡ï¼š</p>
<pre><code>1. å¾…åŠ å›ºçš„æºç¨‹åºAPKï¼›
1. ï¼ˆè„±ï¼‰å£³ç¨‹åºAPK è´Ÿè´£åŠ è½½ï¼Œè§£å¯†å’Œæ‰§è¡Œè¢«ä¿æŠ¤çš„æºç¨‹åºï¼›
1. åŠ å£³ç¨‹åº è´Ÿè´£è§£ææºç¨‹åºå¹¶åˆ©ç”¨å£³ç¨‹åºå¯¹å…¶è¿›è¡ŒåŠ å›ºä¿æŠ¤ï¼Œå°†å£³ç¨‹åºå’Œæºç¨‹åºåˆå¹¶ä¸ºæ–°çš„ç¨‹åºã€‚
</code></pre>
<h4 id=""><a href="#" class="headerlink" title=""></a><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250820151911526.png" alt="image-20250820151911526"></h4><p>åŠ å£³åçš„ å£³ Dex æ–‡ä»¶ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250820152435521.png" alt="image-20250820152435521"></p>
<p>æœ€ç»ˆæ–° APK ä¸­åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code>1. ä¿®æ”¹è¿‡çš„ AndroidManifest.xmlï¼›
1. ç”±å£³ Dex å’Œ æº APK åˆå¹¶è€Œæ¥çš„ class.dexï¼›
1. æº APK çš„æ‰€æœ‰å…¶ä»–èµ„æºæ–‡ä»¶ï¼ˆåŒ…æ‹¬ libã€assetsã€resources ç­‰ï¼‰ã€‚
</code></pre>
<p>ï¼ˆè„±ï¼‰å£³ç¨‹åºï¼š</p>
<pre><code>1. åœ¨å£³ç¨‹åº dex æœ«å°¾è¿½åŠ æºç¨‹åºçš„æ‰€æœ‰ dexï¼›
1. åœ¨å£³ç¨‹åº Application çš„ **attachBaseContext** æ–¹æ³•é‡Šæ”¾æºç¨‹åºæ‰€æœ‰ dex å¹¶æ›¿æ¢ mClassLoaderï¼›
1. åœ¨å£³ç¨‹åº Application çš„ onCreate æ–¹æ³•æ³¨å†Œæºç¨‹åº Application å¹¶å¼€å§‹ç”Ÿå‘½å‘¨æœŸã€‚
</code></pre>
<h5 id="æºç¨‹åº"><a href="#æºç¨‹åº" class="headerlink" title="æºç¨‹åº"></a>æºç¨‹åº</h5><p>â€‹        æºç¨‹åºå³ä¸€èˆ¬çš„ç”¨æˆ·ç¨‹åºï¼Œæˆ‘ä»¬çš„ä¸»è¦ç›®çš„æ˜¯å¯¹æºç¨‹åºè¿›è¡ŒåŠ å›ºä¿æŠ¤ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„æºç¨‹åºå¯èƒ½æ¶‰åŠåˆ°çš„æŠ€æœ¯ç‚¹ï¼š</p>
<ul>
<li>æºç¨‹åºè‡ªå®šä¹‰ Application</li>
</ul>
<p>â€‹        Application.attachBaseContext æ˜¯ APP è¿›ç¨‹çœŸæ­£çš„å…¥å£ç‚¹ã€‚å¦‚æœæºç¨‹åºæ²¡æœ‰ä½¿ç”¨è‡ªå®šä¹‰Applicationï¼Œåˆ™å¯ä»¥ç›´æ¥å¤ç”¨å£³ç¨‹åº Applicationï¼›å¦‚æœæºç¨‹åºæœ‰è‡ªå®šä¹‰Applicationï¼Œåˆ™ä¸€å®šè¦åœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­ ç”±  <application android:name=""> æ ‡ç­¾å£°æ˜æŒ‡å®šï¼Œå¯ä»¥æ›¿æ¢å±æ€§å€¼ä¸º<strong>å£³ application</strong>ï¼ŒåŒæ—¶æ·»åŠ  <strong>meta-data æ ‡ç­¾</strong>ä¿å­˜<strong>æºç¨‹åºapplication</strong>ã€‚</p>
<ul>
<li>Native</li>
</ul>
<p>â€‹        æºç¨‹åºä½¿ç”¨NDKå¼€å‘æ—¶ä¼šç”Ÿæˆlibæ–‡ä»¶å¤¹å’Œå¯¹åº”soæ–‡ä»¶ï¼Œéœ€è¦è¿›è¡Œå¤„ç†ï¼›ä¸»è¦æ˜¯åˆ›å»ºlibåº“çš„é‡Šæ”¾æ–‡ä»¶å¤¹ï¼Œæä¾›ç»™æ–°çš„ ClassLoaderã€‚</p>
<p>æºç¨‹åºä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<pre><code>	1. MainActivity.java
	2. MyApplication.java
	3. native-lib.cpp
	4. AndroidManifest.xml
	5. activity_main.xml
</code></pre>
<p><strong>æ³¨æ„å…³é—­Multidexæ”¯æŒ,ä¿è¯åªç¼–è¯‘å‡ºä¸€ä¸ªDexæ–‡ä»¶</strong></p>
<h6 id="MainActivity-java"><a href="#MainActivity-java" class="headerlink" title="MainActivity.java"></a>MainActivity.java</h6><p>ä¸»è¦åŠŸèƒ½ï¼š</p>
<pre><code>1. Java å±‚ç»„ä»¶ TextView
1. Native å±‚ JNI å‡½æ•°è°ƒç”¨
</code></pre>
<p>æ³¨æ„ç‚¹ï¼š</p>
<pre><code>1. MainActivity ç»§æ‰¿è‡ª **Activity ç±»**è€Œé AppCompatActivityï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ–¹ä¾¿èµ„æºå¤„ç†ï¼›
1. ä½¿ç”¨åˆ°äº† native å‡½æ•°ï¼Œæ‰€ä»¥è¦å¤„ç† lib æ–‡ä»¶å¤¹ï¼›
1. å…³é—­ MultiDex æ”¯æŒï¼Œåªç”Ÿæˆä¸€ä¸ª dex æ–‡ä»¶ä¾¿äºå¤„ç†ã€‚
</code></pre>
<pre><code class="language-java">package com.example.sourcecodeforshell1;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.util.Log;
import android.widget.TextView;

import com.example.sourcecodeforshell1.databinding.ActivityMainBinding;

public class MainActivity extends AppCompatActivity &#123;
    
    static &#123;
        System.loadLibrary(&quot;sourcecodeforshell1&quot;);
    &#125;
    @Override
    protected void onCreate(Bundle savedInstanceState) &#123;
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        String hint = stringFromJNI();
        
        TextView tv = (TextView) findViewById(R.id.sample_text);
        tv.setText(hint);

        Log.d(&quot;NshIdE&quot;, &quot;Run source MainActivity.onCreate &quot; + this);
    &#125;
    
    public native String stringFromJNI();
&#125;
</code></pre>
<h6 id="MyApplication-java"><a href="#MyApplication-java" class="headerlink" title="MyApplication.java"></a>MyApplication.java</h6><p>ä¸»è¦åŠŸèƒ½ï¼šlog è¾“å‡ºä¾¿äºå®šä½æ‰§è¡Œæµç¨‹</p>
<p>æ³¨æ„ï¼š</p>
<pre><code>		1. ç¨‹åºæ‰§è¡Œçš„é¡ºåºä¸º Application.attachBaseContext --&gt; Application.onCreate() --&gt; MainActivity.onCreate()ï¼›
		2. è¯¥ç±»ä¸»è¦ç”¨äºæ¨¡æ‹Ÿå­˜åœ¨è‡ªå®šä¹‰ Application çš„æƒ…å†µã€‚å¦‚æœæºç¨‹åºä¸å­˜åœ¨è‡ªå®šä¹‰ Application 
		3. ä½¿ç”¨é»˜è®¤çš„ Application å³å¯ï¼Œå¦åˆ™éœ€è¦è§£æ Application å¹¶è¿›è¡Œåˆ›å»ºå’Œæ›¿æ¢ã€‚
</code></pre>
<pre><code class="language-Java">package com.example.sourcecodeforshell1;

import android.app.Application;
import android.content.Context;
import android.util.Log;

public class MyApplication extends Application &#123;
    
    @Override
    protected void attachBaseContext(Context base) &#123;
        super.attachBaseContext(base);
        Log.d(&quot;NshIdE&quot;, &quot;Run source MyApplication.attachBaseContext &quot; + this);
    &#125;
    
    @Override
    public void onCreate() &#123;
        super.onCreate();
        Log.d(&quot;NshIdE&quot;, &quot;Run source MyApplication.onCreate &quot; + this);
    &#125;
    
&#125;
</code></pre>
<h6 id="native-lib-cpp"><a href="#native-lib-cpp" class="headerlink" title="native-lib.cpp"></a>native-lib.cpp</h6><p>å®šä¹‰äº†é™æ€æ³¨å†Œçš„æ–¹æ³• stringFromJNI</p>
<pre><code class="language-c++">#include &lt;jni.h&gt;
#include &lt;string&gt;

extern &quot;C&quot; JNIEXPORT jstring JNICALL
Java_com_example_sourcecodeforshell1_MainActivity_stringFromJNI(
        JNIEnv* env,
        jobject /* this */) &#123;
    std::string hello = &quot;Hello from C++&quot;;
    return env-&gt;NewStringUTF(hello.c_str());
&#125;
</code></pre>
<h6 id="AndroidManifest-xml"><a href="#AndroidManifest-xml" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h6><p>ä¸»è¦åŠŸèƒ½ï¼š</p>
<pre><code>	1. æŒ‡å®šæ ¹ activity ä¸º MainActivity
	1. æŒ‡å®š android:name ä¸º MyApplication
</code></pre>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;

    &lt;application
        android:allowBackup=&quot;true&quot;
        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;
        android:fullBackupContent=&quot;@xml/backup_rules&quot;
        android:icon=&quot;@mipmap/ic_launcher&quot;
        android:label=&quot;@string/app_name&quot;
        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;
        android:supportsRtl=&quot;true&quot;
        android:theme=&quot;@style/Theme.SourceCodeForShell1&quot;
        android:name=&quot;.MyApplication&quot;&gt;
        &lt;activity
            android:name=&quot;.MainActivity&quot;
            android:exported=&quot;true&quot;&gt;
            &lt;intent-filter&gt;
                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;

                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;

&lt;/manifest&gt;
</code></pre>
<h6 id="activity-main-xml"><a href="#activity-main-xml" class="headerlink" title="activity_main.xml"></a>activity_main.xml</h6><p>è¿™ä¸ªå°±æ²¡æ”¹åŠ¨äº†ï¼Œå°±æ˜¯ Android studio é»˜è®¤åˆå§‹åŒ–çš„</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    tools:context=&quot;.MainActivity&quot;&gt;

    &lt;TextView
        android:id=&quot;@+id/sample_text&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:text=&quot;Hello World!&quot;
        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;
        app:layout_constraintEnd_toEndOf=&quot;parent&quot;
        app:layout_constraintStart_toStartOf=&quot;parent&quot;
        app:layout_constraintTop_toTopOf=&quot;parent&quot; /&gt;

&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯æºç¨‹åºã€‚</p>
<h5 id="åŠ å£³ç¨‹åº"><a href="#åŠ å£³ç¨‹åº" class="headerlink" title="åŠ å£³ç¨‹åº"></a>åŠ å£³ç¨‹åº</h5><p>åŠ å£³ç¨‹åºä¸»è¦éœ€è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š</p>
<ol>
<li>è§£åŒ… å£³ç¨‹åºå’Œæºç¨‹åºã€‚å¾—åˆ°<strong>å£³ç¨‹åº</strong>çš„ dex ä»¥åŠ<strong>æºç¨‹åº</strong>çš„ AndroidManifest.xml å’Œèµ„æºæ–‡ä»¶ç­‰ï¼›</li>
<li>å¤åˆ¶æºç¨‹åºè§£åŒ…åçš„æ–‡ä»¶åˆ°æ–° APK ä¸´æ—¶ç›®å½•ï¼ˆå¿½ç•¥éƒ¨åˆ†æ–‡ä»¶ï¼‰ï¼›</li>
<li>å¤„ç†æºç¨‹åº AndroidManifest.xml å†™å…¥æ–° APK ä¸´æ—¶ç›®å½•ã€‚åˆ¤æ–­æ˜¯å¦å­˜åœ¨ application æ ‡ç­¾çš„ name å±æ€§æŒ‡å®šäº†<strong>è‡ªå®šä¹‰çš„ Application</strong>ï¼Œè‹¥å­˜åœ¨åˆ™æ·»åŠ  meta-data æ ‡ç­¾ä¿å­˜åŸå§‹ applicationï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨éƒ½è¦æŒ‡å®š name å€¼ä¸ºå£³çš„ Applicationï¼›</li>
<li>åˆå¹¶å£³ dex å’Œæºç¨‹åº APK å†™å…¥æ–° APK ä¸´æ—¶ç›®å½•ï¼›</li>
<li>é‡æ‰“åŒ…æ–°çš„ APKï¼›</li>
<li>å¯¹æ–° APK ç­¾å</li>
<li>åˆ é™¤ä¸´æ—¶ç›®å½•ã€‚</li>
</ol>
<h6 id="FirstShell-py"><a href="#FirstShell-py" class="headerlink" title="FirstShell.py"></a>FirstShell.py</h6><ol>
<li>å°è£… <strong>Path</strong> ç±»ï¼Œä¿å­˜å…¨å±€ä½¿ç”¨åˆ°çš„è·¯å¾„ï¼Œä¸»è¦æ˜¯ APK è·¯å¾„å’Œä¸´æ—¶ç›®å½•ï¼›</li>
<li>å°è£… <strong>Apkktool</strong> ç±»ï¼Œé€šè¿‡ apktool æä¾›çš„ APK è§£åŒ…å’Œæ‰“åŒ…åŠŸèƒ½ï¼Œé€šè¿‡ uber-apk-signer æä¾› apk ç­¾ååŠŸèƒ½ï¼›</li>
<li>å°è£… <strong>ManifestEditor</strong> ç±»ï¼Œæä¾› ManifestEditor è§£æåŠŸèƒ½ï¼Œæ”¯æŒè·å–å’Œä¿®æ”¹æ ‡ç­¾å±æ€§ï¼Œæ·»åŠ æ–°æ ‡ç­¾ï¼›</li>
<li><strong>combineShellDexAndSrcApk</strong> åˆå¹¶å£³ dex å’Œæº APKã€‚å°†åŸ APK åŠ å¯†åå¡«å……åˆ° å£³ dex åæ–¹ï¼Œå¹¶æ·»åŠ  4 å­—èŠ‚æ ‡è¯† APK å¤§å°ã€‚æ•…ï¼Œæ–° dex &#x3D; å£³dex + åŠ å¯†åçš„åŸ APK + åŸ APK å¤§å°ï¼›</li>
<li>handleManifest å¤„ç† AndroidManifest.xmlã€‚åˆ†åˆ«æå–åŸ APK å’Œå£³çš„ AndroidManifest æ–‡ä»¶ï¼Œä»¥æº manifest ä¸ºåŸºå‡†ï¼Œæ ¹æ®åŸ APK æ˜¯å¦æŒ‡å®šè‡ªå®šä¹‰ application ç¡®å®šæ˜¯å¦æ·»åŠ  meta-data æ ‡ç­¾ä¿å­˜ï¼Œæœ€åä¿®æ”¹ application:name ä¸º å£³ applicationï¼›</li>
<li>start å®Œæ•´çš„å¤„ç†å‡½æ•°ã€‚</li>
</ol>
<pre><code class="language-python">from zlib import adler32
from hashlib import sha1
from binascii import unhexlify
from lxml import etree
import subprocess
import shutil
from pathlib import Path
import argparse

#å°è£… path ç±»ï¼Œä¿å­˜å…¨å±€éœ€è¦ç”¨åˆ°çš„è·¯å¾„
class Paths:
    def __init__(self, srcApk:Path, shellApk:Path, outputApk:Path):
        # Apk file paths
        self.srcApkPath = srcApk.resolve()  #è§£æä¸ºç»å¯¹è·¯å¾„
        self.shellApkPath = shellApk.resolve()
        self.newApkPath = outputApk.resolve()

        # ä¸´æ—¶ç›®å½•è·¯å¾„ä¸ºpythonæ–‡ä»¶è·¯å¾„
        self.tmpdir = Path(__file__).parent / &#39;temp&#39;
        self.srcApkTempDir = self.tmpdir / &#39;srcApkTemp&#39;
        self.shellApkTempDir = self.tmpdir / &#39;shellApkTemp&#39;
        self.newApkTempDir = self.tmpdir / &#39;newApkTemp&#39;

# ApkTool ç±» æä¾›è§£åŒ…ï¼Œæ‰“åŒ…ï¼Œç­¾ååŠŸèƒ½
class Apktool:
    def __init__(self):
        self.apktool_path = Path(__file__).parent.parent / &#39;tools/apktool/apktool.bat&#39;
        self.signer_path = Path(__file__).parent / &#39;tools/uber-apk-signer-1.3.0.jar&#39;

    def signApk(self, unsignedApkPath:Path):
        self.runCommand([&#39;java&#39;, &#39;-jar&#39;, self.signer_path, &#39;--apk&#39;, unsignedApkPath])

    # ä½¿ç”¨ aoktool è§£åŒ… apkï¼Œåªè§£åŒ…èµ„æºä¸è§£åŒ… dex
    def extractApk(self, apkPath:Path, outputDir:Path):
        self.runCommand([self.apktool_path, &#39;d&#39;, apkPath, &#39;-s&#39;, &#39;-o&#39;, outputDir])

    # é‡æ‰“åŒ… apk
    def repackApk(self, inputDir:Path, outApk:Path):
        self.runCommand([self.apktool_path, &#39;b&#39;, inputDir, &#39;-o&#39;, outApk])

    def runCommand(self, args):
        #ä»…è°ƒç”¨å·¥å…·,ä¸éœ€è¦è¾“å‡º,é‡å®šå‘stdoutåˆ°os.devnull
        subprocess.run(args, stdout=subprocess.DEVNULL)
        #å‚æ•°åˆ—è¡¨ æ•è·è¾“å‡º è¾“å‡ºè½¬ä¸ºå­—ç¬¦ä¸²
        print(subprocess.run(args, capture_output=True).stdout)

# AndroidManifest.xmlçš„editor ç”¨äºè·å–å’Œä¿®æ”¹æ ‡ç­¾å±æ€§ä»¥åŠæ·»åŠ æ ‡ç­¾
class ManifestEditor:
    def __init__(self, xml_content: bytes):
        self.ns = &#123;&#39;android&#39;: &#39;http://schemas.android.com/apk/res/android&#39;&#125;
        self.tree = etree.fromstring(xml_content)

    #è·å–æŒ‡å®šæ ‡ç­¾çš„androidå±æ€§å€¼ examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;. &#39;name&#39;)
    def getTagAttribute(self, tag_name: str, attr_name: str):
        if tag_name == &#39;manifest&#39;:  #æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.get(f&#39;&#123;attr_name&#125;&#39;)   # å¯»æ‰¾æ ‡ç­¾çš„å±æ€§
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                #æ ¹æ ‡ç­¾ä¹‹å¤–çš„å±æ€§ä½äºAndroidå‘½åç©ºé—´ä¸‹
                return elem.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;)
        return None

    #è®¾ç½®æŒ‡å®šæ ‡ç­¾çš„å±æ€§å€¼
    #example set_attr(&#39;application&#39;, &#39;name&#39;, &#39;com.example.ProxyApplication&#39;)
    def setTagAttribute(self, tag_name: str, attr_name: str, new_value: str):
        if tag_name == &#39;manifest&#39;:   #æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.set(f&#39;&#123;attr_name&#125;&#39;, new_value)  #è®¾ç½®å±æ€§å€¼
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;, new_value)
                return True
        return False

    # åœ¨æŒ‡å®šçˆ¶æ ‡ç­¾ä¸‹æ·»åŠ æ–°å­æ ‡ç­¾
    # example: add_tag(&#39;application&#39;,&quot;meta-data&quot;,&#123;&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;&#125;)
    def addTagWithAttribute(self, parent_tag: str, new_tag: str, attrs: dict):
        if parent_tag == &#39;manifest&#39;:
            parent = self.tree
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items(): #æ”¯æŒä¸€æ¬¡ç»™æ·»åŠ çš„æ ‡ç­¾è®¾ç½®å¤šä¸ªå±æ€§
                    new_elem.set(f&#39;&#123;k&#125;&#39;, v)
                return True
        else:
            parent = self.tree.find(f&#39;.//&#123;parent_tag&#125;&#39;, namespaces=self.ns)
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items():
                    new_elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;k&#125;&#39;, v)
                return True
        return False

    # ä¸ä»¥å£³manifestä¸ºåŸºå‡†æ“ä½œåˆ™ç”¨ä¸åˆ°è¯¥å‡½æ•°,ä»¥æºapkçš„manifestä¸ºåŸºå‡†è‡ªå¸¦,æ— éœ€é¢å¤–è®¾ç½®
    def getMainActivity(self):
        activities = self.tree.findall(&#39;.//activity&#39;, namespaces=self.ns)
        for activity in activities:
            intent_filters = activity.findall(&#39;.//intent-filter&#39;, namespaces=self.ns)
            for intent_filter in intent_filters:
                action = intent_filter.find(&#39;.//action[@android:name=&quot;android.intent.action.MAIN&quot;]&#39;, namespaces=self.ns)
                category = intent_filter.find(&#39;.//category[@android:name=&quot;android.intent.category.LAUNCHER&quot;]&#39;,
                                              namespaces=self.ns)
                if action is not None and category is not None:
                    return activity.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;name&#39;)
        return None

    def getApplication(self):
        return self.getTagAttribute(&#39;application&#39;, &#39;name&#39;)

    def setApplication(self, application: str):
        self.setTagAttribute(&#39;application&#39;, &#39;name&#39;, application)

    def addMetaData(self, name: str, value: str):
        self.addTagWithAttribute(&#39;application&#39;, &#39;meta-data&#39;, &#123;&#39;name&#39;: name, &#39;value&#39;: value&#125;)

    def getManifestData(self):
        &quot;&quot;&quot;è¿”å›XMLå­—ç¬¦ä¸²&quot;&quot;&quot;
        return etree.tostring(self.tree, pretty_print=True, encoding=&#39;utf-8&#39;, xml_declaration=True).decode()

# åˆå¹¶å£³dexå’Œæºapk
def combineShellDexAndSrcApk(sourceApkPath:Path, shellApkTempDir:Path, newApkTempDir:Path):
    def fixCheckSum(dexBytesArray):
        # dexfile[8:12]
        # å°ç«¯å­˜å‚¨
        value = adler32(bytes(dexBytesArray[12:]))
        valueArray = bytearray(value.to_bytes(4, &#39;little&#39;))
        for i in range(len(valueArray)):
            dexBytesArray[8 + i] = valueArray[i]

    def fixSignature(dexBytesArray):
        # dexfile[12:32]
        sha_1 = sha1()
        sha_1.update(bytes(dexBytesArray[32:]))
        value = sha_1.hexdigest()
        valueArray = bytearray(unhexlify(value))
        for i in range(len(valueArray)):
            dexBytesArray[12 + i] = valueArray[i]

    def fixFileSize(dexBytesArray, fileSize):
        # dexfile[32:36]
        # å°ç«¯å­˜å‚¨
        fileSizeArray = bytearray(fileSize.to_bytes(4, &quot;little&quot;))
        for i in range(len(fileSizeArray)):
            dexBytesArray[32 + i] = fileSizeArray[i]

    def encrypto(file):
        for i in range(len(file)):
            file[i] ^= 0xff
        return file

    # è·å–æºapk
    with open(sourceApkPath, &#39;rb&#39;) as f:
        SourceApkArray = bytearray(f.read())
    # è·å–shelldex
    with open(shellApkTempDir / &#39;classes.dex&#39;, &#39;rb&#39;) as f:
        shellDexArray = bytearray(f.read())

    SourceApkLen = len(SourceApkArray)
    shellDexLen = len(shellDexArray)

    # æ–°çš„dexæ–‡ä»¶é•¿åº¦
    newDexLen = shellDexLen + SourceApkLen + 4
    # åŠ å¯†æºæ–‡ä»¶
    enApkArray = encrypto(SourceApkArray)
    # æ–°çš„dexæ–‡ä»¶å†…å®¹ = å£³dex + åŠ å¯†çš„æºapk + å››å­—èŠ‚æ ‡è¯†åŠ å¯†åæºapkå¤§å°é•¿åº¦
    newDexArray = shellDexArray + enApkArray + bytearray(SourceApkLen.to_bytes(4, &#39;little&#39;))

    # ä¿®æ”¹filesize
    fixFileSize(newDexArray, newDexLen)
    # ä¿®æ”¹signature
    fixSignature(newDexArray)
    # ä¿®æ”¹checksum
    fixCheckSum(newDexArray)
    # å¯¼å‡ºæ–‡ä»¶
    with open(newApkTempDir / &#39;classes.dex&#39;, &#39;wb&#39;) as f:
        f.write(newDexArray)


# æå–æºapkçš„Manifestæ–‡ä»¶,ä¿®æ”¹applicationä¸ºå£³application(å¯èƒ½æ·»åŠ meta-dataæ ‡ç­¾),è¾“å‡ºæ–°çš„Manifestæ–‡ä»¶
def handleManifest(srcApkTempDir: Path, shellApkTempDir: Path, newApkTempDir: Path):
    # ä»æºapkæå–AndroidManifest.xml
    with open(srcApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        srcManifestEditor = ManifestEditor(f.read().encode())
    srcApplication = srcManifestEditor.getApplication()

    # ä»å£³apkæå–AndroidManifest.xml
    with open(shellApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        shellManifestEditor = ManifestEditor(f.read().encode())
    print(&#39;ShellApplication:&#39;, shellManifestEditor.getApplication())

    # ä¿®æ”¹æºAndroidManifest.xmlçš„applicationä¸ºå£³çš„ä»£ç†application
    srcManifestEditor.setApplication(shellManifestEditor.getApplication())

    # å†™å…¥meta-dataæ ‡ç­¾ ä¿å­˜æºapkçš„åŸå§‹application
    if srcApplication != None:
        print(&#39;Source application:&#39;, srcApplication)
        srcManifestEditor.addMetaData(&#39;APPLICATION_CLASS_NAME&#39;, srcApplication)

    # è¾“å‡ºæ–°çš„AndroidManifest.xml
    with open(newApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;w&#39;) as f:
        f.write(srcManifestEditor.getManifestData())


def start(paths: Paths):
    apktool = Apktool()
    # 1.åˆ†åˆ«è§£åŒ…æºæ–‡ä»¶å’Œå£³æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
    print(&#39;Extracting source and shell apk...&#39;)
    apktool.extractApk(paths.srcApkPath, paths.srcApkTempDir)
    print(&#39;Extract source apk success!&#39;)

    print(&#39;Extracting shell apk...&#39;)
    apktool.extractApk(paths.shellApkPath, paths.shellApkTempDir)
    print(&#39;Extract shell apk success!&#39;)

    # 2.å¤åˆ¶æºapkæ‰€æœ‰æ–‡ä»¶åˆ°æ–°apkä¸´æ—¶ç›®å½•ä¸­
    print(&#39;Copying source apk files to new apk temp dir...&#39;)
    shutil.copytree(paths.srcApkTempDir, paths.newApkTempDir)
    print(&#39;Copy source apk files success!&#39;)

    # 3.å¤„ç†AndroidManifest.xml
    print(&#39;Handling AndroidManifest.xml...&#39;)
    handleManifest(paths.srcApkTempDir, paths.shellApkTempDir, paths.newApkTempDir)
    print(&#39;Handle AndroidManifest.xml success!&#39;)

    # 4.åˆå¹¶å£³dexå’Œæºapkå¹¶å¯¼å‡ºæ–‡ä»¶
    print(&#39;Combining shell dex and source apk...&#39;)
    combineShellDexAndSrcApk(paths.srcApkPath, paths.shellApkTempDir, paths.newApkTempDir)
    print(&#39;Combine shell dex and source apk success!&#39;)

    # 5.é‡æ‰“åŒ…apk
    print(&#39;Repacking apk...&#39;)
    apktool.repackApk(paths.newApkTempDir, paths.newApkPath)
    print(&#39;Repack apk success!&#39;)

    # 6.ç­¾åapk
    print(&#39;Signing apk...&#39;)
    apktool.signApk(paths.newApkPath)
    print(&#39;Resign apk success!&#39;)

    # 7.åˆ é™¤ä¸´æ—¶ç›®å½•
    print(&#39;Deleting temp directories...&#39;)
    shutil.rmtree(paths.tmpdir)  # åˆ é™¤ä¸´æ—¶ç›®å½•
    print(&#39;Delete temp directories success!&#39;)


def main():
    parser = argparse.ArgumentParser(description=&quot;Android APK Packer&quot;)
    parser.add_argument(&#39;-src&#39;, &#39;--src-apk&#39;, required=True, type=Path, help=&#39;Path to source APK file&#39;)
    parser.add_argument(&#39;-shell&#39;, &#39;--shell-apk&#39;, required=True, type=Path, help=&#39;Path to shell APK file&#39;)
    parser.add_argument(&#39;-o&#39;, &#39;-out&#39;, &#39;--output-apk&#39;, type=Path,
                        help=&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;)
    args = parser.parse_args()
    if args.output_apk == None:
        args.output_apk = Path(&#39;./out&#39;) / (args.src_apk.stem + &#39;_protected.apk&#39;)  # é»˜è®¤æ–°apkåç§°åŠè¾“å‡ºè·¯å¾„
    paths = Paths(args.src_apk, args.shell_apk, args.output_apk)

    print(&#39;Source APK:&#39;, paths.srcApkPath)
    print(&#39;Shell APK:&#39;, paths.shellApkPath)
    print(&#39;Output APK:&#39;, paths.newApkPath)
    start(paths)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<h5 id="è„±å£³ç¨‹åº"><a href="#è„±å£³ç¨‹åº" class="headerlink" title="è„±å£³ç¨‹åº"></a>è„±å£³ç¨‹åº</h5><h6 id="FirstProxyApplication-java"><a href="#FirstProxyApplication-java" class="headerlink" title="FirstProxyApplication.java"></a>FirstProxyApplication.java</h6><p>æ³¨æ„å…³é—­Multidexæ”¯æŒï¼Œä¿è¯åªç”Ÿæˆä¸€ä¸ªDexæ–‡ä»¶ã€‚</p>
<p><strong>attachBaseContext</strong> ä¸­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<pre><code>1. åˆ›å»ºç§æœ‰ç›®å½•ï¼Œç”¨äºä¿å­˜é‡Šæ”¾çš„ dexï¼Œlibï¼Œæº APKï¼›
1. è°ƒç”¨ **readDexFromApk**ï¼Œ ä»å£³ APK ä¸­æå–å£³ dex æ–‡ä»¶ï¼Œä¿å­˜ä¸ºå­—èŠ‚æ•°ç»„ï¼›
1. è°ƒç”¨ **extractSrcApkFromShellDex** ä»å£³ dex æ–‡ä»¶æå–æºç¨‹åº APK æ–‡ä»¶ï¼Œè§£åŒ… lib æ–‡ä»¶åˆ° lib ç§æœ‰ç›®å½•ï¼›
1. è°ƒç”¨ **replaceClassLoader** æ›¿æ¢å£³ç¨‹åºçš„ ClassLoaderï¼›æ–°çš„ ClassLoader æŒ‡å®šäº†åŸ APK dexæ–‡ä»¶ï¼Œlib æ–‡ä»¶ï¼Œodex è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å‰é¢é‡Šæ”¾çš„åŸ APK å’ŒåŸ lib
</code></pre>
<p>onCreate è°ƒç”¨äº† replaceApplication</p>
<ol>
<li>åˆ¤æ–­ manifest æ–‡ä»¶æ˜¯å¦é€šè¿‡ meta-data æ ‡ç­¾ä¿å­˜äº†åŸ APK çš„ applicationï¼Œå¦‚æœåŸ APK æœªæŒ‡å®š applicationï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ applicationï¼ˆå³å£³ applicationï¼‰ï¼›</li>
<li>å¦‚æœåŸ APK æŒ‡å®šäº†è‡ªå®šä¹‰ applicationï¼Œåˆ™åˆ›å»ºå¯¹åº”å®ä¾‹ï¼Œæ›¿æ¢æ‰å£³çš„ applicationï¼Œä¹‹åè°ƒç”¨ onCreate æ–¹æ³•ã€‚</li>
</ol>
<pre><code class="language-Java">package com.example.androidshell1;

import android.app.Application;
import android.app.Instrumentation;
import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.os.Bundle;
import android.util.ArrayMap;
import android.util.Log;

import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.ref.WeakReference;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import dalvik.system.DexClassLoader;

public class FirstProxyApplication extends  Application &#123;
    private static final String TAG = &quot;NshIdE&quot;;
    private String apkPath;
    private String dexPath;
    private String libPath;
    public void log(String message)&#123;Log.d(TAG, message);&#125;
    @Override
    protected void attachBaseContext(Context base) &#123;
        super.attachBaseContext(base);
        log(&quot;FirstProxyApplication.attachBaseContext() running!&quot;);
        try &#123;
            //1.åˆ›å»ºç§æœ‰ç›®å½•,ä¿å­˜dex,libå’Œæºapk å…·ä½“è·¯å¾„ä¸ºdata/user/0/&lt;package_name&gt;/app_tmp_dex
            File dex = getDir(&quot;tmp_dex&quot;, MODE_PRIVATE);
            File lib = getDir(&quot;tmp_lib&quot;, MODE_PRIVATE);
            dexPath = dex.getAbsolutePath();
            libPath = lib.getAbsolutePath();
            apkPath = dex.getAbsolutePath() + File.separator + &quot;Source.apk&quot;;
            log(&quot;dexPath: &quot; + dexPath);
            log(&quot;libPath: &quot; + libPath);
            log(&quot;apkPath: &quot; + apkPath);

            // æ ¹æ®æ–‡ä»¶è·¯å¾„åˆ›å»ºFileå¯¹è±¡
            File apkFile = new File(apkPath);
            // åªæœ‰é¦–æ¬¡è¿è¡Œæ—¶éœ€è¦åˆ›å»ºç›¸å…³æ–‡ä»¶
            if (!apkFile.exists()) &#123;
                // æ ¹æ®è·¯å¾„åˆ›å»ºæ–‡ä»¶
                apkFile.createNewFile();
                //è¯»å–Classes.dexæ–‡ä»¶
                byte[] shellDexData = readDexFromApk();
                //ä»ä¸­åˆ†ç¦»å‡ºæºapkæ–‡ä»¶
                extractSrcApkFromShellDex(shellDexData);
            &#125;
            //é…ç½®åŠ è½½æºç¨‹åºçš„åŠ¨æ€ç¯å¢ƒ,å³æ›¿æ¢mClassLoader
            replaceClassLoader();
        &#125; catch (Exception e) &#123;
            Log.getStackTraceString(e);
        &#125;
    &#125;
    // ä»å½“å‰ç¨‹åºçš„apkè¯»å–dexæ–‡ä»¶å¹¶å­˜å‚¨ä¸ºå­—èŠ‚æ•°ç»„
    private byte[] readDexFromApk() throws IOException &#123;
        //1.è·å–å½“å‰åº”ç”¨ç¨‹åºçš„æºç è·¯å¾„(apk),ä¸€èˆ¬æ˜¯data/appç›®å½•ä¸‹,è¯¥ç›®å½•ç”¨äºå­˜æ”¾ç”¨æˆ·å®‰è£…çš„è½¯ä»¶
        String sourceDir = this.getApplicationInfo().sourceDir;
        log(&quot;this.getApplicationInfo().sourceDir: &quot; +sourceDir);

        //2.åˆ›å»ºç›¸å…³è¾“å…¥æµ
        FileInputStream fileInputStream = new FileInputStream(sourceDir);
        BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
        ZipInputStream zipInputStream = new ZipInputStream(bufferedInputStream); //ç”¨äºè§£æapkæ–‡ä»¶

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); //ç”¨äºå­˜æ”¾dexæ–‡ä»¶

        //3.éå†apkçš„æ‰€æœ‰æ–‡ä»¶å¹¶æå–dexæ–‡ä»¶
        ZipEntry zipEntry;
        while((zipEntry = zipInputStream.getNextEntry()) != null)&#123; //å­˜åœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶
            // å°†classes.dexæ–‡ä»¶å­˜å‚¨åˆ°bytearrayä¸­ å£³dexå’Œæºapkåˆå¹¶ååªä¿ç•™ä¸€ä¸ªdexä¾¿äºå¤„ç†
            if (zipEntry.getName().equals(&quot;classes.dex&quot;))&#123;
                byte[] bytes = new byte[1024];
                int num;
                while((num = zipInputStream.read(bytes))!=-1)&#123;      //æ¯æ¬¡è¯»å–1024byte,è¿”å›è¯»å–åˆ°çš„byteæ•°
                    byteArrayOutputStream.write(bytes,0, num); //å­˜æ”¾åˆ°å¼€è¾Ÿçš„byteArrayOutputStreamä¸­
                &#125;
            &#125;
            zipInputStream.closeEntry(); //å…³é—­å½“å‰æ–‡ä»¶
        &#125;
        zipInputStream.close();

        log(&quot;Read dex from apk succeed!&quot;);
        return byteArrayOutputStream.toByteArray(); //å°†è¯»å–åˆ°çš„dexæ–‡ä»¶ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¿”å›
    &#125;

    // ä»å£³dexæ–‡ä»¶ä¸­æå–æºapkå¹¶è§£æ
    private void extractSrcApkFromShellDex(byte[] shellDexData) throws IOException &#123;
        int shellDexLen = shellDexData.length;
        //å¼€å§‹è§£ædexæ–‡ä»¶
        //1.è¯»å–æºapkçš„å¤§å°
        byte[] srcApkSizeBytes = new byte[4];
        System.arraycopy(shellDexData, shellDexLen - 4, srcApkSizeBytes,0,4);
        int srcApkSize =ByteBuffer.wrap(srcApkSizeBytes).order(ByteOrder.LITTLE_ENDIAN).getInt();//è½¬æˆbytebuffer,æ–¹ä¾¿4 bytesè½¬int å°†bytesè½¬æˆint,åŠ å£³æ—¶,é•¿åº¦æŒ‰å°ç«¯å­˜å‚¨

        //2.è¯»å–æºapk
        byte[] sourceApkData = new byte[srcApkSize];
        System.arraycopy(shellDexData, shellDexLen - srcApkSize - 4, sourceApkData, 0, srcApkSize);//æ³¨æ„å‡4

        //3.è§£å¯†æºapk
        sourceApkData = decrypt(sourceApkData);
        //å†™å…¥æ–°å»ºçš„apkæ–‡ä»¶ä¸­
        File apkfile = new File(apkPath);
        try &#123;
            FileOutputStream apkfileOutputStream = new FileOutputStream(apkfile);
            apkfileOutputStream.write(sourceApkData);
            apkfileOutputStream.close();
        &#125;catch (IOException e)&#123;
            throw new IOException(e);
        &#125;

        //åˆ†ææºapk,å–å‡ºsoæ–‡ä»¶æ”¾å…¥libPathç›®å½•ä¸­
        FileInputStream fileInputStream = new FileInputStream(apkfile);
        BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
        ZipInputStream zipInputStream = new ZipInputStream(bufferedInputStream);
        ZipEntry nextEntry;
        while ((nextEntry=zipInputStream.getNextEntry())!=null)&#123;
            String name = nextEntry.getName();
            if (name.startsWith(&quot;lib/&quot;) &amp;&amp; name.endsWith(&quot;.so&quot;))&#123;
                //è·å–æ–‡ä»¶åå¹¶åˆ›å»ºç›¸åº”æ–‡ä»¶
                String[] nameSplit = name.split(&quot;/&quot;);
                String soFileStorePath = libPath + File.separator + nameSplit[nameSplit.length - 1];
                File storeFile = new File(soFileStorePath);
                storeFile.createNewFile();

                //è¯»æ•°æ®åˆ°ç›¸åº”soæ–‡ä»¶ä¸­
                FileOutputStream fileOutputStream = new FileOutputStream(storeFile);
                byte[] bytes = new byte[1024];
                int num;
                while((num = zipInputStream.read(bytes))!=-1)&#123;
                    fileOutputStream.write(bytes,0,num);
                &#125;
                fileOutputStream.flush();
                fileOutputStream.close();
            &#125;
            zipInputStream.closeEntry();
        &#125;
        zipInputStream.close();
    &#125;

    // è§£å¯†å‡½æ•°
    private byte[] decrypt(byte[] data) &#123;
        for (int i = 0; i &lt; data.length; i++)&#123;
            data[i] ^= (byte) 0xff;
        &#125;
        return data;
    &#125;

    // æ›¿æ¢å£³Appçš„ClassLoaderä¸ºæºAppçš„ClassLoader
    private void replaceClassLoader() &#123;
        //1.è·å–å½“å‰çš„classloader
        ClassLoader classLoader = this.getClassLoader();
        log(&quot;Current ClassLoader: &quot; + classLoader.toString());
        log(&quot;Parent ClassLoader: &quot; + classLoader.getParent().toString());

        //2.åå°„è·å–ActivityThread
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread.sCurrentActivity: &quot; + sCurrentActivityThreadObj.toString());

        //3.åå°„è·å–LoadedApk
        //è·å–å½“å‰ActivityThreadå®ä¾‹çš„mPackageså­—æ®µ ç±»å‹ä¸ºArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, é‡Œé¢å­˜æ”¾äº†å½“å‰åº”ç”¨çš„LoadedApkå¯¹è±¡
        ArrayMap mPackagesObj = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mPackages&quot;);
        log( &quot;mPackagesObj: &quot; + mPackagesObj.toString());

        //è·å–mPackagesä¸­çš„å½“å‰åº”ç”¨åŒ…å
        String currentPackageName = this.getPackageName();
        log(&quot;currentPackageName: &quot; + currentPackageName);

        // è·å–loadedApkå®ä¾‹ä¹Ÿæœ‰å¥½å‡ ç§,mInitialApplication mAllApplications mPackages
        // é€šè¿‡åŒ…åè·å–å½“å‰åº”ç”¨çš„loadedApkå®ä¾‹
        WeakReference weakReference = (WeakReference) mPackagesObj.get(currentPackageName);
        Object loadedApkObj = weakReference.get();
        log( &quot;LoadedApk: &quot; + loadedApkObj.toString());

        //4.æ›¿æ¢ClassLoader
        DexClassLoader dexClassLoader = new DexClassLoader(apkPath,dexPath,libPath, classLoader.getParent()); //åŠ¨æ€åŠ è½½æºç¨‹åºçš„dexæ–‡ä»¶,ä»¥å½“å‰classloaderçš„çˆ¶åŠ è½½å™¨ä½œä¸ºparent
        Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mClassLoader&quot;,loadedApkObj,dexClassLoader); //æ›¿æ¢å½“å‰loadedApkå®ä¾‹ä¸­çš„mClassLoaderå­—æ®µ
        log(&quot;New DexClassLoader: &quot; + dexClassLoader);
    &#125;

    //æ›¿æ¢å£³ç¨‹åºLoadedApkçš„Applicationä¸ºæºç¨‹åºApplication,å¹¶è°ƒç”¨å…¶onCreateæ–¹æ³•
    public boolean replaceApplication()&#123;
        // Applicationå®ä¾‹å­˜åœ¨äº: LoadedApk.mApplication
        // ä»¥åŠActivityThreadçš„mInitialApplicationå’ŒmAllApplicationså’ŒmBoundApplication

        //åˆ¤æ–­æºç¨‹åºæ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰Application è‹¥ä½¿ç”¨åˆ™éœ€è¦è¿›è¡Œæ›¿æ¢,è‹¥æœªä½¿ç”¨åˆ™ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„é»˜è®¤Applicationå³å¯

        String appClassName = null; //æºç¨‹åºçš„Applicationç±»å
        try &#123;
            //è·å–AndroidManifest.xml æ–‡ä»¶ä¸­çš„ &lt;meta-data&gt; å…ƒç´ 
            ApplicationInfo applicationInfo = getPackageManager().getApplicationInfo(this.getPackageName(), PackageManager.GET_META_DATA);
            Bundle metaData = applicationInfo.metaData;
            //è·å–xmlæ–‡ä»¶å£°æ˜çš„Applicationç±»
            if (metaData != null &amp;&amp; metaData.containsKey(&quot;APPLICATION_CLASS_NAME&quot;))&#123;
                appClassName = metaData.getString(&quot;APPLICATION_CLASS_NAME&quot;);
            &#125; else &#123;
                log(&quot;æºç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰Application&quot;);
                return false; //å¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„applicationå³å¯
            &#125;
        &#125; catch (PackageManager.NameNotFoundException e) &#123;
            log(Log.getStackTraceString(e));
        &#125;

        //æºç¨‹åºå­˜åœ¨è‡ªå®šä¹‰applicationç±»,å¼€å§‹æ›¿æ¢
        log(&quot;Try to replace Application&quot;);

        //1.åå°„è·å–ActivityThreadå®ä¾‹
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread: &quot; + sCurrentActivityThreadObj.toString());

        //2.è·å–å¹¶è®¾ç½®LoadedApk
        //è·å–mBoundApplication (AppBindDataå¯¹è±¡)
        Object mBoundApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mBoundApplication&quot;) ;
        log(&quot;mBoundApplication: &quot;+mBoundApplicationObj.toString());
        //è·å–mBoundApplication.info (å³LoadedApk)
        Object infoObj = Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;info&quot;);
        log( &quot;LoadedApk: &quot; + infoObj.toString());
        //æŠŠLoadedApkçš„mApplicationè®¾ç½®ä¸ºnull,è¿™æ ·åç»­æ‰èƒ½è°ƒç”¨makeApplication() å¦åˆ™ç”±äºå·²å­˜åœ¨Application,æ— æ³•è¿›è¡Œæ›¿æ¢
        Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mApplication&quot;,infoObj,null);

        //3.è·å–ActivityThread.mInitialApplication å³æ‹¿åˆ°æ—§çš„Application(å¯¹äºè¦åŠ è½½çš„Applicationæ¥è®²)
        Object mInitialApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mInitialApplication&quot;);
        log(&quot;mInitialApplicationObj: &quot; + mInitialApplicationObj.toString());

        //4.è·å–ActivityThread.mAllApplicationså¹¶åˆ é™¤æ—§çš„application
        ArrayList&lt;Application&gt; mAllApplicationsObj = (ArrayList&lt;Application&gt;) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mAllApplications&quot;);
        mAllApplicationsObj.remove(mInitialApplicationObj);
        log(&quot;mInitialApplication ä» mAllApplications ä¸­ç§»é™¤æˆåŠŸ&quot;);

        //5.é‡ç½®ç›¸å…³ç±»çš„Applicationç±»å ä¾¿äºåç»­åˆ›å»ºApplication
        //è·å–LoadedApk.mApplicationInfo
        ApplicationInfo applicationInfo = (ApplicationInfo) Reflection.getField(&quot;android.app.LoadedApk&quot;,infoObj,&quot;mApplicationInfo&quot;);
        log( &quot;LoadedApk.mApplicationInfo: &quot; + applicationInfo.toString());
        //è·å–mBoundApplication.appInfo
        ApplicationInfo appinfoInAppBindData = (ApplicationInfo) Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;appInfo&quot;);
        log(&quot;ActivityThread.mBoundApplication.appInfo: &quot; + appinfoInAppBindData.toString());
        //æ­¤å¤„é€šè¿‡å¼•ç”¨ä¿®æ”¹å€¼,è™½ç„¶åç»­æ²¡æœ‰ä½¿ç”¨,ä½†æ˜¯å®é™…ä¸Šæ˜¯ä¿®æ”¹å…¶æŒ‡å‘çš„LoadedApkç›¸å…³å­—æ®µçš„å€¼
        //è®¾ç½®ä¸¤ä¸ªappinfoçš„classnameä¸ºæºç¨‹åºçš„applicationç±»å,ä»¥ä¾¿åç»­è°ƒç”¨makeApplication()åˆ›å»ºæºç¨‹åºçš„application
        applicationInfo.className = appClassName;
        appinfoInAppBindData.className = appClassName;
        log(&quot;Source Application name: &quot; + appClassName);


        //6.åå°„è°ƒç”¨makeApplicationæ–¹æ³•åˆ›å»ºæºç¨‹åºçš„application
        Application application = (Application) Reflection.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;false,null&#125;); //ä½¿ç”¨æºç¨‹åºä¸­çš„application
        //Application app = (Application)ReflectionMethods.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;true,null&#125;); //ä½¿ç”¨è‡ªå®šä¹‰çš„application å¼ºåˆ¶ä¸ºç³»ç»Ÿé»˜è®¤
        log(&quot;Create source Application succeed: &quot;+application);

        //7.é‡ç½®ActivityThread.mInitialApplicationä¸ºæ–°çš„Application
        Reflection.setField(&quot;android.app.ActivityThread&quot;,&quot;mInitialApplication&quot;,sCurrentActivityThreadObj,application);
        log(&quot;Reset ActivityThread.mInitialApplication by new Application succeed!&quot;);

        //8.ContentProviderä¼šæŒæœ‰ä»£ç†çš„Application,éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹
        ArrayMap mProviderMap = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mProviderMap&quot;);
        log(&quot;ActivityThread.mProviderMap: &quot; + mProviderMap);

        //è·å–æ‰€æœ‰provider,è£…è¿›è¿­ä»£å™¨ä¸­éå†
        Iterator iterator = mProviderMap.values().iterator();
        while(iterator.hasNext())&#123;
            Object providerClientRecord = iterator.next();
            //è·å–ProviderClientRecord.mLocalProvider,å¯èƒ½ä¸ºç©º
            Object mLocalProvider = Reflection.getField(&quot;android.app.ActivityThread$ProviderClientRecord&quot;,providerClientRecord,&quot;mLocalProvider&quot;) ;
            if(mLocalProvider != null)&#123;
                log(&quot;ProviderClientRecord.mLocalProvider: &quot; + mLocalProvider);
                //è·å–ContentProviderä¸­çš„mContextå­—æ®µ,è®¾ç½®ä¸ºæ–°çš„Application
                Reflection.setField(&quot;android.content.ContentProvider&quot;,&quot;mContext&quot;,mLocalProvider,application);
            &#125;
        &#125;

        log( &quot;Run Application.onCreate&quot; );
        application.onCreate(); //æºç¨‹åº,å¯åŠ¨!
        return true;
    &#125;
    @Override
    public void onCreate() &#123;
        super.onCreate();
        log(&quot;ProxyApplication.onCreate() is running!&quot;);
        if(replaceApplication())
            log(&quot;Replace application succeed!&quot;);
    &#125;
&#125;
</code></pre>
<h6 id="Reflection-java"><a href="#Reflection-java" class="headerlink" title="Reflection.java"></a>Reflection.java</h6><pre><code class="language-Java">package com.example.androidshell1;

import android.util.Log;

import java.lang.reflect.Field;
import java.lang.reflect.Method;

public class Reflection &#123;
    private static final String TAG = &quot;NshIdE&quot;;
    public static Object invokeStaticMethod(String class_name,String method_name,Class&lt;?&gt;[] parameterTypes,Object[] parameterValues)&#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name); //åå°„è·å–Classç±»å¯¹è±¡
            Method method = clazz.getMethod(method_name,parameterTypes);//åå°„è·å–æ–¹æ³•
            method.setAccessible(true);//çªç ´æƒé™è®¿é—®æ§åˆ¶
            return method.invoke(null,parameterValues);//åå°„è°ƒç”¨,é™æ€æ–¹æ³•æ— éœ€æŒ‡å®šæ‰€å±å®ä¾‹,ç›´æ¥ä¼ å‚å³å¯
        &#125;catch (Exception e)&#123;
            Log.d(TAG, e.toString());
            return null;
        &#125;
    &#125;

    public static Object invokeMethod(String class_name,String method_name,Object obj,Class&lt;?&gt;[] parameterTypes,Object[] parameterValues)
    &#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name);
            Method method = clazz.getMethod(method_name,parameterTypes);
            method.setAccessible(true);//çªç ´æƒé™è®¿é—®æ§åˆ¶
            return method.invoke(obj,parameterValues);// åå°„è°ƒç”¨,åŠ¨æ€æ–¹æ³•éœ€è¦æŒ‡å®šæ‰€å±å®ä¾‹
        &#125;catch (Exception e)
        &#123;
            Log.d(TAG, e.toString());
            return null;
        &#125;
    &#125;

    public static Object getField(String class_name,Object obj,String field_name)
    &#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name);
            Field field = clazz.getDeclaredField(field_name);
            field.setAccessible(true);
            return field.get(obj);  //è·å–å®ä¾‹å­—æ®µ,éœ€è¦æŒ‡å®šå®ä¾‹å¯¹è±¡
        &#125;catch(Exception e)
        &#123;
            Log.d(TAG, e.toString());
            return null;
        &#125;
    &#125;

    public static Object getStaticField(String class_name,String field_name)
    &#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name);
            Field field = clazz.getDeclaredField(field_name);
            field.setAccessible(true);
            return field.get(null);
        &#125;catch (Exception e)
        &#123;
            Log.d(TAG, e.toString());
            return null;
        &#125;
    &#125;

    public static void setField(String class_name,String field_name,Object obj,Object value)
    &#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name);
            Field field = clazz.getDeclaredField(field_name);
            field.setAccessible(true);
            field.set(obj,value);
        &#125;catch (Exception e)
        &#123;
            Log.d(TAG, e.toString());
        &#125;
    &#125;

    public static void setStaticField(String class_name,String field_name,Object value)
    &#123;
        try &#123;
            Class&lt;?&gt; clazz = Class.forName(class_name);
            Field field = clazz.getDeclaredField(field_name);
            field.setAccessible(true);
            field.set(null,value);
        &#125;catch (Exception e)&#123;
            Log.d(TAG, e.toString());
        &#125;
    &#125;
&#125;
</code></pre>
<h6 id="AndroidManifest-xml-1"><a href="#AndroidManifest-xml-1" class="headerlink" title="AndroidManifest.xml"></a>AndroidManifest.xml</h6><pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;

    &lt;application
        android:allowBackup=&quot;true&quot;
        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;
        android:fullBackupContent=&quot;@xml/backup_rules&quot;
        android:icon=&quot;@mipmap/ic_launcher&quot;
        android:label=&quot;@string/app_name&quot;
        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;
        android:supportsRtl=&quot;true&quot;
        android:theme=&quot;@style/Theme.AndroidShell1&quot;
        android:name=&quot;com.example.androidshell1.FirstProxyApplication&quot;&gt;
    &lt;/application&gt;

&lt;/manifest&gt;
</code></pre>
<p>â€‹        ä½†æ˜¯è¿™é‡Œè„šæœ¬ç•¥æœ‰é—®é¢˜ï¼Œå°±æ˜¯åœ¨åŠ è½½åŸ APK çš„ so çš„æ—¶å€™ï¼Œä¼šå­˜åœ¨è¦†ç›–çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡æ‰“åŒ…åŠ å£³ç”Ÿæˆçš„ APKï¼Œåªæ”¯æŒä¸€ç§ ABIï¼Œå°½ç®¡è¯¥ APK çš„ lib ç›®å½•ä¸‹æœ‰å››ç§ ABI å¯¹åº”çš„ soï¼Œä½†æ˜¯åœ¨è¿è¡ŒåŠ¨æ€åŠ è½½çš„æ—¶å€™ ä¼šå‡ºé—®é¢˜ã€‚</p>
<h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>â€‹        æ•´ä½“åŠ å›ºâ€”â€”è½åœ°åŠ è½½çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯å°†æºç¨‹åº APK å’Œ å£³ dex è¿›è¡Œåˆå¹¶ï¼Œè¿è¡Œæ—¶åŠ¨æ€è§£å¯†å¹¶æ‰§è¡Œç›¸å…³ç¯å¢ƒå¤„ç†æ“ä½œï¼Œé‡æ–°æ‰§è¡ŒåŸ APK çš„ä»£ç ã€‚</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šæ˜“äºå®ç°ï¼›</p>
</li>
<li><p>ç¼ºç‚¹ï¼šç”±äºæ–‡ä»¶è½åœ°åŠ è½½ï¼Œæ‰€ä»¥éå¸¸å®¹æ˜“åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­è·å–åˆ°æºç¨‹åº APKï¼›ä¸¤æ¬¡åŠ è½½åŸç¨‹åº APK åˆ°å†…å­˜ï¼Œæ•ˆç‡ä½ã€‚</p>
</li>
</ul>
<h4 id="äºŒä»£å£³-æ•´ä½“åŠ å›ºï¼ˆä¸è½åœ°åŠ è½½ï¼‰"><a href="#äºŒä»£å£³-æ•´ä½“åŠ å›ºï¼ˆä¸è½åœ°åŠ è½½ï¼‰" class="headerlink" title="äºŒä»£å£³-æ•´ä½“åŠ å›ºï¼ˆä¸è½åœ°åŠ è½½ï¼‰"></a>äºŒä»£å£³-æ•´ä½“åŠ å›ºï¼ˆä¸è½åœ°åŠ è½½ï¼‰</h4><h5 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h5><p>â€‹        é’ˆå¯¹è½åœ°åŠ è½½çš„éƒ¨åˆ†é—®é¢˜ï¼Œå¼•ç”³å‡ºäº†ä¸è½åœ°åŠ è½½çš„æ€è·¯ï¼š å³ç›´æ¥åŠ è½½å†…å­˜ä¸­çš„dexå­—èŠ‚ç ï¼Œé¿å…é‡Šæ”¾æ–‡ä»¶ã€‚</p>
<p>â€‹        å¦‚ä½•åœ¨å†…å­˜ä¸­åŠ è½½dexï¼Ÿ<strong>Android 8</strong> åŠä»¥ä¸Šç³»ç»Ÿä¸­,å¯ä»¥ä½¿ç”¨ç³»ç»Ÿæä¾›çš„ <strong>InMemoryDexClassLoader</strong> å®ç°å†…å­˜åŠ è½½ï¼ŒAndroid7åŠä»¥ä¸‹åˆ™éœ€è¦æ‰‹åŠ¨å®ç°ã€‚</p>
<p>â€‹        å¦å¤–éœ€è¦é’ˆå¯¹ç¬¬ä¸€ä»£åŠ å›ºä¸æ”¯æŒMultidexè¿›è¡Œä¼˜åŒ–ï¼šæºapkæ¯ä¸ª dex æ–‡ä»¶å‰æ·»åŠ  <strong>4 å­—èŠ‚</strong>æ ‡è¯†å…¶å¤§å°ï¼Œä¹‹åå…¨éƒ¨åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶å†åˆå¹¶åˆ°å£³ dexï¼Œæœ€åæ·»åŠ  4 å­—èŠ‚æ ‡è¯†æ–‡ä»¶æ€»å¤§å°ã€‚</p>
<p>ç»“æ„å¦‚ä¸‹ï¼š<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821103600951.png" alt="image-20250821103600951"></p>
<h5 id="æºç¨‹åº-1"><a href="#æºç¨‹åº-1" class="headerlink" title="æºç¨‹åº"></a>æºç¨‹åº</h5><p>åŒä¸€ä»£åŠ å›ºï¼Œå¯å¼€å¯Multidexæ”¯æŒï¼Œå…¶ä»–éƒ¨åˆ†ä¸å˜ã€‚</p>
<h5 id="åŠ å£³ç¨‹åº-1"><a href="#åŠ å£³ç¨‹åº-1" class="headerlink" title="åŠ å£³ç¨‹åº"></a>åŠ å£³ç¨‹åº</h5><p>ä¸»è¦æ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>è°ƒç”¨ <strong>combineShellAndSourceDexs</strong> åˆå¹¶å£³ dex å’Œæºdexã€‚å†…éƒ¨è°ƒç”¨ <strong>readAndCombineDexs</strong> è¯»å–å¹¶åˆå¹¶æº apk çš„<strong>å¤šä¸ª dex</strong> ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚</p>
</li>
<li><p>å¤åˆ¶åŸ APK æ–‡ä»¶æ—¶å¿½ç•¥ Manifest å’Œ dex æ–‡ä»¶ã€‚</p>
<pre><code class="language-Java">shutil.copytree(paths.srcApkTempDir,paths.newApkTempDir,ignore=shutil.ignore_patterns(&#39;AndroidManifest.xml&#39;,&#39;classes*.dex&#39;))
</code></pre>
</li>
<li><p>ManifeseEditorã€‚æ·»åŠ  <strong>getEtractNativeLibs</strong>ï¼Œè·å–application æ ‡ç­¾çš„ <strong>android:extractNativeLibs</strong> å±æ€§å€¼</p>
<p>æ·»åŠ  <strong>resetExtractNativeLibs</strong>ï¼Œ<strong>é‡ç½®extractNativeLibs&#x3D;true</strong> å¼ºåˆ¶é‡Šæ”¾ lib æ–‡ä»¶ã€‚</p>
</li>
<li><p>handleManifestã€‚åˆ¤æ–­æºç¨‹åº Manifest æ˜¯å¦è®¾ç½®äº†android:extractNativeLibs&#x3D;â€trueâ€ï¼Œè‹¥ä¸º false(é»˜è®¤)åˆ™æ”¹ä¸ºtrueã€‚</p>
</li>
</ol>
<pre><code class="language-python">from zlib import adler32
from hashlib import sha1
from binascii import unhexlify
from lxml import etree
import subprocess
import shutil
from pathlib import Path
import argparse


# å°è£…pathç±»,ä¿å­˜å…¨å±€ç”¨åˆ°çš„è·¯å¾„
class Paths:
    def __init__(self, srcApk: Path, shellApk: Path, outputApk: Path):
        # Apk file paths
        self.srcApkPath = srcApk.resolve()  # è§£æä¸ºç»å¯¹è·¯å¾„
        self.shellApkPath = shellApk.resolve()
        self.newApkPath = outputApk.resolve()

        # Temp directories default python file path
        self.tmpdir = Path(__file__).parent / &#39;temp&#39;
        self.srcApkTempDir = self.tmpdir / &#39;srcApkTemp&#39;
        self.shellApkTempDir = self.tmpdir / &#39;shellApkTemp&#39;
        self.newApkTempDir = self.tmpdir / &#39;newApkTemp&#39;


# Apktoolç±» æä¾›è§£åŒ…,æ‰“åŒ…,ç­¾ååŠŸèƒ½
class Apktool:
    def __init__(self):
        self.apktool_path = Path(__file__).parent.parent / &#39;tools/apktool/apktool.bat&#39;
        self.signer_path = Path(__file__).parent / &#39;tools/uber-apk-signer-1.3.0.jar&#39;

    def signApk(self, unsignedApkPath: Path):
        self.runCommand([&#39;java&#39;, &#39;-jar&#39;, self.signer_path, &#39;--apk&#39;, unsignedApkPath])

    # ä½¿ç”¨apktoolè§£åŒ…apk åªè§£åŒ…èµ„æºä¸è§£åŒ…dex
    def extractApk(self, apkPath: Path, outputDir: Path):
        self.runCommand([self.apktool_path, &#39;d&#39;, apkPath, &#39;-s&#39;, &#39;-o&#39;, outputDir])

    # é‡æ‰“åŒ…apk
    def repackApk(self, inputDir: Path, outApk: Path):
        self.runCommand([self.apktool_path, &#39;b&#39;, inputDir, &#39;-o&#39;, outApk])

    def runCommand(self, args):
        subprocess.run(args, stdout=subprocess.DEVNULL)  # ä»…è°ƒç”¨å·¥å…·,ä¸éœ€è¦è¾“å‡º,é‡å®šå‘stdoutåˆ°os.devnull
        # å‚æ•°åˆ—è¡¨ æ•è·è¾“å‡º è¾“å‡ºè½¬ä¸ºå­—ç¬¦ä¸²
        # print(subprocess.run(args,  capture_output=True,text=True).stdout)


# AndroidManifest.xmlçš„editor ç”¨äºè·å–å’Œä¿®æ”¹æ ‡ç­¾å±æ€§,ä»¥åŠæ·»åŠ æ ‡ç­¾
class ManifestEditor:
    def __init__(self, xml_content: bytes):
        self.ns = &#123;&#39;android&#39;: &#39;http://schemas.android.com/apk/res/android&#39;&#125;
        self.tree = etree.fromstring(xml_content)

    # è·å–æŒ‡å®šæ ‡ç­¾çš„androidå±æ€§å€¼ examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;, &#39;name&#39;)
    def getTagAttribute(self, tag_name: str, attr_name: str):
        if tag_name == &#39;manifest&#39;:  # æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.get(f&#39;&#123;attr_name&#125;&#39;)  # å¯»æ‰¾æ ‡ç­¾çš„å±æ€§
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                return elem.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;)  # æ ¹æ ‡ç­¾ä¹‹å¤–çš„å±æ€§ä½äºandroidå‘½åç©ºé—´ä¸‹
        return None

    # è®¾ç½®æŒ‡å®šæ ‡ç­¾çš„å±æ€§å€¼ example:set_attr(&#39;application&#39;,&#39;name&#39;,&quot;com.example.ProxyApplication&quot;)
    def setTagAttribute(self, tag_name: str, attr_name: str, new_value: str):
        if tag_name == &#39;manifest&#39;:  # æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.set(f&#39;&#123;attr_name&#125;&#39;, new_value)  # è®¾ç½®å±æ€§å€¼
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;, new_value)
                return True
        return False

    # åœ¨æŒ‡å®šçˆ¶æ ‡ç­¾ä¸‹æ·»åŠ æ–°å­æ ‡ç­¾ example: add_tag(&#39;application&#39;,&quot;meta-data&quot;,&#123;&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;&#125;)
    def addTagWithAttributes(self, parent_tag: str, new_tag: str, attrs: dict):
        if parent_tag == &#39;manifest&#39;:
            parent = self.tree
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items():  # æ”¯æŒä¸€æ¬¡ç»™æ·»åŠ çš„æ ‡ç­¾è®¾ç½®å¤šä¸ªå±æ€§
                    new_elem.set(f&#39;&#123;k&#125;&#39;, v)
                return True
        else:
            parent = self.tree.find(f&#39;.//&#123;parent_tag&#125;&#39;, namespaces=self.ns)
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items():
                    new_elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;k&#125;&#39;, v)
                return True
        return False

    # ä¸ä»¥å£³manifestä¸ºåŸºå‡†æ“ä½œåˆ™ç”¨ä¸åˆ°è¯¥å‡½æ•°,ä»¥æºapkçš„manifestä¸ºåŸºå‡†è‡ªå¸¦,æ— éœ€é¢å¤–è®¾ç½®
    def getMainActivity(self):
        activities = self.tree.findall(&#39;.//activity&#39;, namespaces=self.ns)
        for activity in activities:
            intent_filters = activity.findall(&#39;.//intent-filter&#39;, namespaces=self.ns)
            for intent_filter in intent_filters:
                action = intent_filter.find(&#39;.//action[@android:name=&quot;android.intent.action.MAIN&quot;]&#39;, namespaces=self.ns)
                category = intent_filter.find(&#39;.//category[@android:name=&quot;android.intent.category.LAUNCHER&quot;]&#39;,
                                              namespaces=self.ns)
                if action is not None and category is not None:
                    return activity.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;name&#39;)
        return None

    def getApplication(self):
        return self.getTagAttribute(&#39;application&#39;, &#39;name&#39;)

    def setApplication(self, application: str):
        self.setTagAttribute(&#39;application&#39;, &#39;name&#39;, application)

    def addMetaData(self, name: str, value: str):
        self.addTagWithAttributes(&#39;application&#39;, &#39;meta-data&#39;, &#123;&#39;name&#39;: name, &#39;value&#39;: value&#125;)

    def getManifestData(self):
        &quot;&quot;&quot;è¿”å›XMLå­—ç¬¦ä¸²&quot;&quot;&quot;
        return etree.tostring(self.tree, pretty_print=True, encoding=&#39;utf-8&#39;, xml_declaration=True).decode()

    def getEtractNativeLibs(self):
        &quot;&quot;&quot;è¿”å›æ˜¯å¦é‡Šæ”¾soæ–‡ä»¶&quot;&quot;&quot;
        return self.getTagAttribute(&#39;application&#39;, &#39;extractNativeLibs&#39;)

    def resetExtractNativeLibs(self):
        &quot;&quot;&quot;é‡ç½®etractNativeLibså±æ€§ä¸ºtrue&quot;&quot;&quot;
        self.setTagAttribute(&#39;application&#39;, &#39;extractNativeLibs&#39;, &#39;true&#39;)


# åˆå¹¶å£³dexå’Œæºapkçš„dex
def combineShellAndSourceDexs(shellApkTempDir: Path, srcApkTempDir: Path, newApkTempDir: Path):
    def fixCheckSum(dexBytesArray):
        # dexfile[8:12]
        # å°ç«¯å­˜å‚¨
        value = adler32(bytes(dexBytesArray[12:]))
        valueArray = bytearray(value.to_bytes(4, &#39;little&#39;))
        for i in range(len(valueArray)):
            dexBytesArray[8 + i] = valueArray[i]

    def fixSignature(dexBytesArray):
        # dexfile[12:32]
        sha_1 = sha1()
        sha_1.update(bytes(dexBytesArray[32:]))
        value = sha_1.hexdigest()
        valueArray = bytearray(unhexlify(value))
        for i in range(len(valueArray)):
            dexBytesArray[12 + i] = valueArray[i]

    def fixFileSize(dexBytesArray, fileSize):
        # dexfile[32:36]
        # å°ç«¯å­˜å‚¨
        fileSizeArray = bytearray(fileSize.to_bytes(4, &quot;little&quot;))
        for i in range(len(fileSizeArray)):
            dexBytesArray[32 + i] = fileSizeArray[i]

    def encrypto(file):
        for i in range(len(file)):
            file[i] ^= 0xff
        return file

    def readAndCombineDexs(unpackedApkDir: Path):
        # è¯»å–è§£åŒ…åçš„apkçš„æ‰€æœ‰dexæ–‡ä»¶,å¹¶åˆå¹¶ä¸ºä¸€ä¸ªdexæ–‡ä»¶
        combinedDex = bytearray()
        # globæ–¹æ³•è¿”å›åŒ…å«æ‰€æœ‰åŒ¹é…æ–‡ä»¶çš„ç”Ÿæˆå™¨
        for dex in unpackedApkDir.glob(&#39;classes*.dex&#39;):
            print(&#39;Source Apk Dex file:&#39;, dex)
            with open(dex, &#39;rb&#39;) as f:
                data = bytearray(f.read())
                combinedDex += bytearray(len(data).to_bytes(4, &#39;little&#39;))  # dexæ–‡ä»¶çš„é•¿åº¦,å°ç«¯åº
                combinedDex += data  # dexæ–‡ä»¶å†…å®¹
        return combinedDex

    # è·å–shelldex
    with open(shellApkTempDir / &#39;classes.dex&#39;, &#39;rb&#39;) as f:
        shellDexArray = bytearray(f.read())

    # è·å–æºapkçš„dexæ–‡ä»¶
    srcDexArray = readAndCombineDexs(srcApkTempDir)
    # æ–°çš„dexæ–‡ä»¶é•¿åº¦
    newDexLen = len(srcDexArray) + len(shellDexArray) + 4
    # åŠ å¯†æºæ–‡ä»¶
    encSrcDexArray = encrypto(srcDexArray)
    # æ–°çš„dexæ–‡ä»¶å†…å®¹ = å£³dex + åŠ å¯†çš„æºdex + å››å­—èŠ‚æ ‡è¯†åŠ å¯†åæºdexå¤§å°é•¿åº¦
    newDexArray = shellDexArray + encSrcDexArray + bytearray(len(encSrcDexArray).to_bytes(4, &#39;little&#39;))

    # ä¿®æ”¹filesize
    fixFileSize(newDexArray, newDexLen)
    # ä¿®æ”¹signature
    fixSignature(newDexArray)
    # ä¿®æ”¹checksum
    fixCheckSum(newDexArray)
    # å¯¼å‡ºæ–‡ä»¶
    with open(newApkTempDir / &#39;classes.dex&#39;, &#39;wb&#39;) as f:
        f.write(newDexArray)


# æå–æºapkçš„Manifestæ–‡ä»¶,ä¿®æ”¹applicationä¸ºå£³application(å¯èƒ½æ·»åŠ meta-dataæ ‡ç­¾),è¾“å‡ºæ–°çš„Manifestæ–‡ä»¶
def handleManifest(srcApkTempDir: Path, shellApkTempDir: Path, newApkTempDir: Path):
    # ä»æºapkæå–AndroidManifest.xml
    with open(srcApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        srcManifestEditor = ManifestEditor(f.read().encode())
    srcApplication = srcManifestEditor.getApplication()
    srcExtractNativeLibs = srcManifestEditor.getEtractNativeLibs()
    print(&#39;SourceApplication:&#39;, srcApplication)
    print(&#39;SourceExtractNativeLibs:&#39;, srcExtractNativeLibs)

    # ä»å£³apkæå–AndroidManifest.xml
    with open(shellApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        shellManifestEditor = ManifestEditor(f.read().encode())
    print(&#39;ShellApplication:&#39;, shellManifestEditor.getApplication())

    # ä¿®æ”¹æºAndroidManifest.xmlçš„applicationä¸ºå£³çš„ä»£ç†application
    srcManifestEditor.setApplication(shellManifestEditor.getApplication())

    # å†™å…¥meta-dataæ ‡ç­¾ ä¿å­˜æºapkçš„åŸå§‹application
    if srcApplication != None:
        print(&#39;Source application:&#39;, srcApplication)
        srcManifestEditor.addMetaData(&#39;APPLICATION_CLASS_NAME&#39;, srcApplication)

    # å¦‚æœæºapkçš„manifestä¸­é»˜è®¤è®¾ç½®etractNativeLibs=false,åˆ™é‡ç½®ä¸ºtrue,ç¡®ä¿é‡Šæ”¾libæ–‡ä»¶
    if srcExtractNativeLibs == &#39;false&#39;:
        srcManifestEditor.resetExtractNativeLibs()

    # è¾“å‡ºæ–°çš„AndroidManifest.xml
    with open(newApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;w&#39;) as f:
        f.write(srcManifestEditor.getManifestData())


def start(paths: Paths):
    apktool = Apktool()
    # 1.åˆ†åˆ«è§£åŒ…æºæ–‡ä»¶å’Œå£³æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
    print(&#39;Extracting source and shell apk...&#39;)
    apktool.extractApk(paths.srcApkPath, paths.srcApkTempDir)
    print(&#39;Extract source apk success!&#39;)

    print(&#39;Extracting shell apk...&#39;)
    apktool.extractApk(paths.shellApkPath, paths.shellApkTempDir)
    print(&#39;Extract shell apk success!&#39;)

    # 2.å¤åˆ¶æºapkæ‰€æœ‰æ–‡ä»¶åˆ°æ–°apkä¸´æ—¶ç›®å½•ä¸­,å¿½ç•¥æºdexå’Œmanifestæ–‡ä»¶
    print(&#39;Copying source apk files to new apk temp dir...&#39;)
    shutil.copytree(paths.srcApkTempDir, paths.newApkTempDir,
                    ignore=shutil.ignore_patterns(&#39;AndroidManifest.xml&#39;, &#39;classes*.dex&#39;))
    print(&#39;Copy source apk files success!&#39;)

    # 3.å¤„ç†AndroidManifest.xml
    print(&#39;Handling AndroidManifest.xml...&#39;)
    handleManifest(paths.srcApkTempDir, paths.shellApkTempDir, paths.newApkTempDir)
    print(&#39;Handle AndroidManifest.xml success!&#39;)

    # 4.åˆå¹¶å£³dexå’Œæºapkå¹¶å¯¼å‡ºæ–‡ä»¶
    print(&#39;Combining shell dex and source dexs...&#39;)
    combineShellAndSourceDexs(paths.shellApkTempDir, paths.srcApkTempDir, paths.newApkTempDir)
    print(&#39;Combine shell dex and source dexs success!&#39;)

    # 5.é‡æ‰“åŒ…apk
    print(&#39;Repacking apk...&#39;)
    apktool.repackApk(paths.newApkTempDir, paths.newApkPath)
    print(&#39;Repack apk success!&#39;)

    # 6.ç­¾åapk
    print(&#39;Signing apk...&#39;)
    apktool.signApk(paths.newApkPath)
    print(&#39;Resign apk success!&#39;)

    # 7.åˆ é™¤ä¸´æ—¶ç›®å½•
    print(&#39;Deleting temp directories...&#39;)
    shutil.rmtree(paths.tmpdir)  # åˆ é™¤ä¸´æ—¶ç›®å½•
    print(&#39;Delete temp directories success!&#39;)


def main():
    parser = argparse.ArgumentParser(description=&quot;Android APK Packer&quot;)
    parser.add_argument(&#39;-src&#39;, &#39;--src-apk&#39;, required=True, type=Path, help=&#39;Path to source APK file&#39;)
    parser.add_argument(&#39;-shell&#39;, &#39;--shell-apk&#39;, required=True, type=Path, help=&#39;Path to shell APK file&#39;)
    parser.add_argument(&#39;-o&#39;, &#39;-out&#39;, &#39;--output-apk&#39;, type=Path,
                        help=&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;)
    args = parser.parse_args()
    if args.output_apk == None:
        args.output_apk = Path(&#39;./out&#39;) / (args.src_apk.stem + &#39;_protected.apk&#39;)  # é»˜è®¤æ–°apkåç§°åŠè¾“å‡ºè·¯å¾„
    paths = Paths(args.src_apk, args.shell_apk, args.output_apk)

    print(&#39;Source APK:&#39;, paths.srcApkPath)
    print(&#39;Shell APK:&#39;, paths.shellApkPath)
    print(&#39;Output APK:&#39;, paths.newApkPath)
    start(paths)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<h5 id="è„±å£³ç¨‹åº-1"><a href="#è„±å£³ç¨‹åº-1" class="headerlink" title="è„±å£³ç¨‹åº"></a>è„±å£³ç¨‹åº</h5><p>SecondProxyApplication.java ç›¸æ¯” FirstProxyApplication.javaæ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>attachBaseContextã€‚è¯»å–å£³ dex æ–‡ä»¶åï¼Œæå–æºç¨‹åº dex æ–‡ä»¶,ä¹‹åæ›¿æ¢ ClassLoaderï¼Œæ²¡æœ‰è®¾ç½®ç§æœ‰ç›®å½•å’Œé‡Šæ”¾æ–‡ä»¶ç­‰æ“ä½œã€‚</li>
<li>extractDexFilesFromShellDexã€‚æ›¿ä»£<strong>splitSourceApkFromShellDex</strong>ï¼Œä»å£³ dex æå–æºç¨‹åºdex æ–‡ä»¶å¹¶å­˜å‚¨ä¸º ByteBuffer[]ã€‚</li>
<li>replaceClassLoaderã€‚ä¸€ä»£åŠ å›ºä½¿ç”¨ DexClassLoader ä»æ–‡ä»¶åŠ è½½ï¼ŒäºŒä»£åŠ å›ºä½¿ç”¨ InMemoryDexClassLoaderã€‚</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>åœ¨ Android 8.0 ä»¥ä¸‹ä¸æ”¯æŒ InMemoryDexClassLoaderï¼Œéœ€è¦æ‰‹åŠ¨å®ç°ï¼›</li>
<li>åœ¨ Android 10.0 ä»¥ä¸‹ä¸æ”¯æŒ InMemoryDexClassLoader æŒ‡å®š lib ç›®å½•çš„é‡è½½ï¼›é»˜è®¤æœç´¢è·¯å¾„ä¸º<strong>nativeLibraryDirectories&#x3D;[&#x2F;system&#x2F;lib64, &#x2F;product&#x2F;lib64]]]</strong>ã€‚</li>
</ul>
<p>â€‹        å¯å‚è€ƒä»¥ä¸‹æ–‡ç« ä¿®å¤ lib ç›®å½•çš„é—®é¢˜ï¼š<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/q610098308/article/details/105246355">https://blog.csdn.net/q610098308/article/details/105246355</a></p>
<p><a target="_blank" rel="noopener" href="http://www.yxhuang.com/2020/03/28/android-so-load/">http://www.yxhuang.com/2020/03/28/android-so-load/</a></p>
<ul>
<li>è‹¥æºç¨‹åºè®¾ç½®äº† android:extractNativeLibs&#x3D;â€falseâ€ï¼Œåˆ™ä¸ä¼šé‡Šæ”¾ lib æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ç›´æ¥æ˜ å°„ APK æ–‡ä»¶çš„ lib æ•°æ®ã€‚å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µåˆ™éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œæ¨¡æ‹Ÿæ˜ å°„åŠ è½½ so çš„æ“ä½œï¼ŒèƒŒåçš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸”éœ€è¦è€ƒè™‘å…¼å®¹æ€§ã€‚ä¸ºäº†ç®€åŒ–å¤„ç†å¯ä»¥å°†åŠ å£³å APK çš„ <strong>android:extractNativeLibs</strong> å±æ€§æ”¹ä¸º trueï¼Œå¼ºè¡ŒæŒ‡å®šé‡Šæ”¾ libã€‚</li>
</ul>
<pre><code class="language-Java">package com.example.androidshell2;

import android.app.Application;
import android.app.Instrumentation;
import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.os.Build;
import android.os.Bundle;
import android.util.ArrayMap;
import android.util.Log;

import java.io.BufferedInputStream;
import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.IOException;
import java.lang.ref.WeakReference;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import dalvik.system.InMemoryDexClassLoader;

public class SecondProxyApplication extends Application &#123;
    private final String TAG=&quot;NshIdE&quot;;
    public void log(String message)&#123;Log.d(TAG,message);&#125;
    @Override
    protected void attachBaseContext(Context base) &#123;
        super.attachBaseContext(base);
        log(&quot;SecondProxyApplication.attachBaseContext is running!&quot;);
        try &#123;
            byte[] shellDexData = readDexFromApk();
            log(&quot;æˆåŠŸä»æºAPKä¸­è¯»å–classes.dex&quot;);
            //ä»ä¸­åˆ†ç†å‡ºæºdexæ–‡ä»¶
            ByteBuffer[] byteBuffers = extractDexFilesFromShellDex(shellDexData);
            log(&quot;æˆåŠŸåˆ†ç¦»å‡ºæºdexé›†åˆ&quot;);
            //é…ç½®åŠ è½½æºç¨‹åºçš„åŠ¨æ€ç¯å¢ƒ,å³æ›¿æ¢mClassLoader
            replaceClassLoader(byteBuffers);
        &#125; catch (Exception e) &#123;
            log( Log.getStackTraceString(e));
        &#125;
    &#125;
    @Override
    public void onCreate() &#123;
        super.onCreate();
        log(&quot;SecondProxyApplication.onCreate is running!&quot;);
        if(replaceApplication())
            log(&quot;æ›¿æ¢ApplicationæˆåŠŸ&quot;);
    &#125;
    // ä»å£³dexæ–‡ä»¶ä¸­æå–æºapkçš„dexå¹¶å°è£…ä¸ºByteBuffer
    private ByteBuffer[] extractDexFilesFromShellDex(byte[] shellDexData) throws IOException &#123;
        int shellDexlength = shellDexData.length;
        //å¼€å§‹è§£ædexæ–‡ä»¶
        byte[] sourceDexsSizeByte = new byte[4];
        //è¯»å–æºdexsçš„å¤§å°
        System.arraycopy(shellDexData,shellDexlength - 4, sourceDexsSizeByte,0,4);
        //è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int
        ByteBuffer wrap = ByteBuffer.wrap(sourceDexsSizeByte);
        //å°†byteè½¬æˆint, åŠ å£³æ—¶,é•¿åº¦æŒ‰å°ç«¯å­˜å‚¨
        int sourceDexsSizeInt = wrap.order(ByteOrder.LITTLE_ENDIAN).getInt();
        Log.d(TAG, &quot;æºdexé›†åˆçš„å¤§å°: &quot; + sourceDexsSizeInt);
        //è¯»å–æºdexs
        byte[] sourceDexsData = new byte[sourceDexsSizeInt];
        System.arraycopy(shellDexData,shellDexlength - sourceDexsSizeInt - 4, sourceDexsData, 0, sourceDexsSizeInt);
        //è§£å¯†æºdexs
        sourceDexsData = decrypt(sourceDexsData);

        //æ›´æ–°éƒ¨åˆ†
        //ä»æºdexsä¸­åˆ†ç¦»dex
        ArrayList&lt;byte[]&gt; sourceDexList = new ArrayList&lt;&gt;();
        int pos = 0;
        while(pos &lt; sourceDexsSizeInt)&#123;
            //å…ˆæå–å››ä¸ªå­—èŠ‚,æè¿°å½“å‰dexçš„å¤§å°
            //å¼€å§‹è§£ædexæ–‡ä»¶
            byte[] singleDexSizeByte = new byte[4];
            //è¯»å–æºdexsçš„å¤§å°
            System.arraycopy(sourceDexsData, pos, singleDexSizeByte,0,4);
            //è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int
            ByteBuffer singleDexwrap = ByteBuffer.wrap(singleDexSizeByte);
            int singleDexSizeInt = singleDexwrap.order(ByteOrder.LITTLE_ENDIAN).getInt();
            Log.d(TAG, &quot;å½“å‰singleDexçš„å¤§å°: &quot; + singleDexSizeInt);
            //è¯»å–å•ç‹¬dex
            byte[] singleDexData = new byte[singleDexSizeInt];
            System.arraycopy(sourceDexsData,pos + 4, singleDexData, 0, singleDexSizeInt);
            //åŠ å…¥åˆ°dexlistä¸­
            sourceDexList.add(singleDexData);
            //æ›´æ–°pos
            pos += 4 + singleDexSizeInt;
        &#125;

        //å°†dexliståŒ…è£…æˆByteBuffer
        int dexNum = sourceDexList.size();
        Log.d(TAG, &quot;æºdexçš„æ•°é‡: &quot; + dexNum);
        ByteBuffer[] dexBuffers = new ByteBuffer[dexNum];
        for (int i = 0; i &lt; dexNum; i++)&#123;
            dexBuffers[i] = ByteBuffer.wrap(sourceDexList.get(i));
        &#125;

        return dexBuffers;

    &#125;
    // ä»apkè¯»å–dexæ–‡ä»¶å¹¶è¿”å›dexå¯¹åº”å­—èŠ‚æ•°ç»„
    // ä»å½“å‰ç¨‹åºçš„apkè¯»å–dexæ–‡ä»¶å¹¶å­˜å‚¨ä¸ºå­—èŠ‚æ•°ç»„
    private byte[] readDexFromApk() throws IOException &#123;
        //1.è·å–å½“å‰åº”ç”¨ç¨‹åºçš„æºç è·¯å¾„(apk),ä¸€èˆ¬æ˜¯data/appç›®å½•ä¸‹,è¯¥ç›®å½•ç”¨äºå­˜æ”¾ç”¨æˆ·å®‰è£…çš„è½¯ä»¶
        String sourceDir = this.getApplicationInfo().sourceDir;
        log(&quot;this.getApplicationInfo().sourceDir: &quot; +sourceDir);

        //2.åˆ›å»ºç›¸å…³è¾“å…¥æµ
        FileInputStream fileInputStream = new FileInputStream(sourceDir);
        BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
        ZipInputStream zipInputStream = new ZipInputStream(bufferedInputStream); //ç”¨äºè§£æapkæ–‡ä»¶

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); //ç”¨äºå­˜æ”¾dexæ–‡ä»¶

        //3.éå†apkçš„æ‰€æœ‰æ–‡ä»¶å¹¶æå–dexæ–‡ä»¶
        ZipEntry zipEntry;
        while((zipEntry = zipInputStream.getNextEntry()) != null)&#123; //å­˜åœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶
            // å°†classes.dexæ–‡ä»¶å­˜å‚¨åˆ°bytearrayä¸­ å£³dexå’Œæºapkåˆå¹¶ååªä¿ç•™ä¸€ä¸ªdexä¾¿äºå¤„ç†
            if (zipEntry.getName().equals(&quot;classes.dex&quot;))&#123;
                byte[] bytes = new byte[1024];
                int num;
                while((num = zipInputStream.read(bytes))!=-1)&#123;      //æ¯æ¬¡è¯»å–1024byte,è¿”å›è¯»å–åˆ°çš„byteæ•°
                    byteArrayOutputStream.write(bytes,0, num); //å­˜æ”¾åˆ°å¼€è¾Ÿçš„byteArrayOutputStreamä¸­
                &#125;
            &#125;
            zipInputStream.closeEntry(); //å…³é—­å½“å‰æ–‡ä»¶
        &#125;
        zipInputStream.close();

        log(&quot;Read dex from apk succeed!&quot;);
        return byteArrayOutputStream.toByteArray(); //å°†è¯»å–åˆ°çš„dexæ–‡ä»¶ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¿”å›
    &#125;
    private byte[] decrypt(byte[] sourceApkdata) &#123;
        for (int i = 0; i &lt; sourceApkdata.length; i++)&#123;
            sourceApkdata[i] ^= (byte) 0xff;
        &#125;
        return sourceApkdata;

    &#125;
    //æ›¿æ¢å£³ç¨‹åºLoadedApkçš„Applicationä¸ºæºç¨‹åºApplication,å¹¶è°ƒç”¨å…¶onCreateæ–¹æ³•
    public boolean replaceApplication()&#123;
        // Applicationå®ä¾‹å­˜åœ¨äº: LoadedApk.mApplication
        // ä»¥åŠActivityThreadçš„mInitialApplicationå’ŒmAllApplicationså’ŒmBoundApplication

        //åˆ¤æ–­æºç¨‹åºæ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰Application è‹¥ä½¿ç”¨åˆ™éœ€è¦è¿›è¡Œæ›¿æ¢,è‹¥æœªä½¿ç”¨åˆ™ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„é»˜è®¤Applicationå³å¯

        String appClassName = null; //æºç¨‹åºçš„Applicationç±»å
        try &#123;
            //è·å–AndroidManifest.xml æ–‡ä»¶ä¸­çš„ &lt;meta-data&gt; å…ƒç´ 
            ApplicationInfo applicationInfo = getPackageManager().getApplicationInfo(this.getPackageName(), PackageManager.GET_META_DATA);
            Bundle metaData = applicationInfo.metaData;
            //è·å–xmlæ–‡ä»¶å£°æ˜çš„Applicationç±»
            if (metaData != null &amp;&amp; metaData.containsKey(&quot;APPLICATION_CLASS_NAME&quot;))&#123;
                appClassName = metaData.getString(&quot;APPLICATION_CLASS_NAME&quot;);
            &#125; else &#123;
                log(&quot;æºç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰Application&quot;);
                return false; //å¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„applicationå³å¯
            &#125;
        &#125; catch (PackageManager.NameNotFoundException e) &#123;
            log(Log.getStackTraceString(e));
        &#125;

        //æºç¨‹åºå­˜åœ¨è‡ªå®šä¹‰applicationç±»,å¼€å§‹æ›¿æ¢
        log(&quot;Try to replace Application&quot;);

        //1.åå°„è·å–ActivityThreadå®ä¾‹
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread: &quot; + sCurrentActivityThreadObj.toString());

        //2.è·å–å¹¶è®¾ç½®LoadedApk
        //è·å–mBoundApplication (AppBindDataå¯¹è±¡)
        Object mBoundApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mBoundApplication&quot;) ;
        log(&quot;mBoundApplication: &quot;+mBoundApplicationObj.toString());
        //è·å–mBoundApplication.info (å³LoadedApk)
        Object infoObj = Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;info&quot;);
        log( &quot;LoadedApk: &quot; + infoObj.toString());
        //æŠŠLoadedApkçš„mApplicationè®¾ç½®ä¸ºnull,è¿™æ ·åç»­æ‰èƒ½è°ƒç”¨makeApplication() å¦åˆ™ç”±äºå·²å­˜åœ¨Application,æ— æ³•è¿›è¡Œæ›¿æ¢
        Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mApplication&quot;,infoObj,null);

        //3.è·å–ActivityThread.mInitialApplication å³æ‹¿åˆ°æ—§çš„Application(å¯¹äºè¦åŠ è½½çš„Applicationæ¥è®²)
        Object mInitialApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mInitialApplication&quot;);
        log(&quot;mInitialApplicationObj: &quot; + mInitialApplicationObj.toString());

        //4.è·å–ActivityThread.mAllApplicationså¹¶åˆ é™¤æ—§çš„application
        ArrayList&lt;Application&gt; mAllApplicationsObj = (ArrayList&lt;Application&gt;) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mAllApplications&quot;);
        mAllApplicationsObj.remove(mInitialApplicationObj);
        log(&quot;mInitialApplication ä» mAllApplications ä¸­ç§»é™¤æˆåŠŸ&quot;);

        //5.é‡ç½®ç›¸å…³ç±»çš„Applicationç±»å ä¾¿äºåç»­åˆ›å»ºApplication
        //è·å–LoadedApk.mApplicationInfo
        ApplicationInfo applicationInfo = (ApplicationInfo) Reflection.getField(&quot;android.app.LoadedApk&quot;,infoObj,&quot;mApplicationInfo&quot;);
        log( &quot;LoadedApk.mApplicationInfo: &quot; + applicationInfo.toString());
        //è·å–mBoundApplication.appInfo
        ApplicationInfo appinfoInAppBindData = (ApplicationInfo) Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;appInfo&quot;);
        log(&quot;ActivityThread.mBoundApplication.appInfo: &quot; + appinfoInAppBindData.toString());
        //æ­¤å¤„é€šè¿‡å¼•ç”¨ä¿®æ”¹å€¼,è™½ç„¶åç»­æ²¡æœ‰ä½¿ç”¨,ä½†æ˜¯å®é™…ä¸Šæ˜¯ä¿®æ”¹å…¶æŒ‡å‘çš„LoadedApkç›¸å…³å­—æ®µçš„å€¼
        //è®¾ç½®ä¸¤ä¸ªappinfoçš„classnameä¸ºæºç¨‹åºçš„applicationç±»å,ä»¥ä¾¿åç»­è°ƒç”¨makeApplication()åˆ›å»ºæºç¨‹åºçš„application
        applicationInfo.className = appClassName;
        appinfoInAppBindData.className = appClassName;
        log(&quot;Source Application name: &quot; + appClassName);


        //6.åå°„è°ƒç”¨makeApplicationæ–¹æ³•åˆ›å»ºæºç¨‹åºçš„application
        Application application = (Application) Reflection.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;false,null&#125;); //ä½¿ç”¨æºç¨‹åºä¸­çš„application
        //Application app = (Application)ReflectionMethods.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;true,null&#125;); //ä½¿ç”¨è‡ªå®šä¹‰çš„application å¼ºåˆ¶ä¸ºç³»ç»Ÿé»˜è®¤
        log(&quot;Create source Application succeed: &quot;+application);

        //7.é‡ç½®ActivityThread.mInitialApplicationä¸ºæ–°çš„Application
        Reflection.setField(&quot;android.app.ActivityThread&quot;,&quot;mInitialApplication&quot;,sCurrentActivityThreadObj,application);
        log(&quot;Reset ActivityThread.mInitialApplication by new Application succeed!&quot;);

        //8.ContentProviderä¼šæŒæœ‰ä»£ç†çš„Application,éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹
        ArrayMap mProviderMap = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mProviderMap&quot;);
        log(&quot;ActivityThread.mProviderMap: &quot; + mProviderMap);

        //è·å–æ‰€æœ‰provider,è£…è¿›è¿­ä»£å™¨ä¸­éå†
        Iterator iterator = mProviderMap.values().iterator();
        while(iterator.hasNext())&#123;
            Object providerClientRecord = iterator.next();
            //è·å–ProviderClientRecord.mLocalProvider,å¯èƒ½ä¸ºç©º
            Object mLocalProvider = Reflection.getField(&quot;android.app.ActivityThread$ProviderClientRecord&quot;,providerClientRecord,&quot;mLocalProvider&quot;) ;
            if(mLocalProvider != null)&#123;
                log(&quot;ProviderClientRecord.mLocalProvider: &quot; + mLocalProvider);
                //è·å–ContentProviderä¸­çš„mContextå­—æ®µ,è®¾ç½®ä¸ºæ–°çš„Application
                Reflection.setField(&quot;android.content.ContentProvider&quot;,&quot;mContext&quot;,mLocalProvider,application);
            &#125;
        &#125;

        log( &quot;Run Application.onCreate&quot; );
        application.onCreate(); //æºç¨‹åº,å¯åŠ¨!
        return true;
    &#125;
    // æ›¿æ¢å£³Appçš„ClassLoaderä¸ºæºAppçš„ClassLoader
    private void replaceClassLoader(ByteBuffer[] byteBuffers) throws Exception&#123;
        //1.è·å–å½“å‰çš„classloader
        ClassLoader classLoader = this.getClassLoader();
        log(&quot;Current ClassLoader: &quot; + classLoader.toString());
        log(&quot;Parent ClassLoader: &quot; + classLoader.getParent().toString());

        //2.åå°„è·å–ActivityThread
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread.sCurrentActivity: &quot; + sCurrentActivityThreadObj.toString());

        //3.åå°„è·å–LoadedApk
        //è·å–å½“å‰ActivityThreadå®ä¾‹çš„mPackageså­—æ®µ ç±»å‹ä¸ºArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, é‡Œé¢å­˜æ”¾äº†å½“å‰åº”ç”¨çš„LoadedApkå¯¹è±¡
        ArrayMap mPackagesObj = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mPackages&quot;);
        log( &quot;mPackagesObj: &quot; + mPackagesObj.toString());

        //è·å–mPackagesä¸­çš„å½“å‰åº”ç”¨åŒ…å
        String currentPackageName = this.getPackageName();
        log(&quot;currentPackageName: &quot; + currentPackageName);

        // è·å–loadedApkå®ä¾‹ä¹Ÿæœ‰å¥½å‡ ç§,mInitialApplication mAllApplications mPackages
        // é€šè¿‡åŒ…åè·å–å½“å‰åº”ç”¨çš„loadedApkå®ä¾‹
        WeakReference weakReference = (WeakReference) mPackagesObj.get(currentPackageName);
        Object loadedApkObj = weakReference.get();
        log( &quot;LoadedApk: &quot; + loadedApkObj.toString());

        //åŠ¨æ€åŠ è½½æºç¨‹åºçš„dexæ–‡ä»¶
        if(Build.VERSION.SDK_INT&gt;=29)&#123;
            Log.d(TAG,&quot;Library path:&quot;+this.getApplicationInfo().nativeLibraryDir);
            InMemoryDexClassLoader dexClassLoader=new InMemoryDexClassLoader(byteBuffers,this.getApplicationInfo().nativeLibraryDir,classLoader.getParent());
            Log.d(TAG, &quot;New InMemoryDexClassLoader: &quot; + dexClassLoader);
            //æ›¿æ¢å½“å‰loadedApkå®ä¾‹ä¸­çš„mClassLoaderå­—æ®µ
            Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mClassLoader&quot;,loadedApkObj,dexClassLoader);
        &#125;
        else&#123;

            Log.d(TAG,&quot;ä¸æ”¯æŒAndroid 8.0ä»¥ä¸‹ç‰ˆæœ¬&quot;);
        &#125;
    &#125;
&#125;
</code></pre>
<h5 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>â€‹        äºŒä»£åŠ å›ºä½¿ç”¨ä¸è½åœ°åŠ è½½æŠ€æœ¯ï¼Œå¯åœ¨å†…å­˜ä¸­ç›´æ¥åŠ è½½dexï¼Œå®é™…ä¸Šæ˜¯å¯¹è½åœ°åŠ è½½çš„æ›´æ–°ã€‚</p>
<p>â€‹        ç¬¬ä¸€ä»£å’Œç¬¬äºŒä»£åŠ å›ºç»Ÿç§°ä¸ºæ•´ä½“åŠ å›ºï¼Œåœ¨éƒ¨åˆ†èµ„æ–™ä¸­å°†ä»–ä»¬åˆç§°ä¸ºä¸€ä»£åŠ å›ºï¼Œå°†ä»£ç æŠ½å–åŠ å›ºç§°ä¸ºäºŒä»£åŠ å›ºã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šç›¸å¯¹ä¸€ä»£åŠ å›ºæ›´åŠ é«˜æ•ˆï¼Œä¸å®¹æ˜“ä»æ–‡ä»¶ç³»ç»Ÿè·å– dex æ–‡ä»¶ä»è€Œå¾—åˆ°å…³é”®ä»£ç ï¼›</li>
<li>ç¼ºç‚¹ï¼šå…¼å®¹æ€§é—®é¢˜: æºç¨‹åºçš„libsoå¤„ç†èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼›ä½ç‰ˆæœ¬éœ€è¦æ‰‹åŠ¨å®ç°InMemoryDexClassLoaderã€‚</li>
</ul>
<p>â€‹        å½“ç„¶ï¼Œæ€»çš„æ¥è¯´ï¼Œæ•´ä½“åŠ å›ºç°åœ¨éƒ½èƒ½ä¸€æŠŠæ¢­ï¼Œç”¨ frida-dexdumpã€‚</p>
<h3 id="ä¸‰ã€ç¬¬ä¸‰ä»£å£³-æŠ½å–åŠ å›º"><a href="#ä¸‰ã€ç¬¬ä¸‰ä»£å£³-æŠ½å–åŠ å›º" class="headerlink" title="ä¸‰ã€ç¬¬ä¸‰ä»£å£³-æŠ½å–åŠ å›º"></a>ä¸‰ã€ç¬¬ä¸‰ä»£å£³-æŠ½å–åŠ å›º</h3><p>â€‹        åŸºäºæ•´ä½“åŠ å›ºé‡åˆ°çš„éƒ¨åˆ†é—®é¢˜ï¼Œå¼•ç”³å‡ºäº†ç¬¬ä¸‰ä»£åŠ å›ºâ€”â€”ä»£ç æŠ½å–åŠ å›ºã€‚</p>
<p>â€‹        æ€è·¯ï¼šå°†å…³é”®æ–¹æ³•çš„æŒ‡ä»¤æŠ½ç©ºï¼Œæ›¿æ¢ä¸º nop æŒ‡ä»¤ï¼Œè¿è¡Œæ—¶åŠ¨æ€å›å¡«æŒ‡ä»¤æ‰§è¡Œï¼Œå›å¡«çš„æ ¸å¿ƒæ˜¯å¯¹ Android ç³»ç»Ÿæ ¸å¿ƒå‡½æ•°è¿›è¡Œ hookã€‚</p>
<ol>
<li>Hook ç‚¹<ul>
<li>å¸¸ç”¨çš„ Hook ç‚¹æœ‰ <strong>ClassLinker::LoadMethod</strong> å’Œ <strong>ClassLinker:DefineClass</strong>ï¼ŒäºŒè€…éƒ½å¯ä»¥è·å– DexFile å¯¹è±¡ï¼›</li>
<li>LoadMethodï¼šå¯è·å– Method å¯¹è±¡ï¼Œä»è€Œè·å– codeOffï¼Œæ–¹ä¾¿å›å¡«å¤„ç†ï¼Œä½†å…¼å®¹æ€§å·®ï¼›</li>
<li>DefineClassï¼šå¯è·å– ClassDef å¯¹è±¡ï¼Œéœ€è¦è§£æå¾—åˆ° codeOffï¼Œæ›´å¤æ‚ä½†å…¼å®¹æ€§æ›´å¥½ï¼Œå˜åŒ–ä¸å¤§ã€‚</li>
</ul>
</li>
<li>å¦‚ä½•æŠ½å–ä»£ç ï¼ˆå¯å‚è€ƒè¿™ç¯‡<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-284995.htm">æ–‡ç« </a>ä¸­çš„ Dex æ–‡ä»¶ç»“æ„å’Œä»£ç æŠ½å–éƒ¨åˆ†ï¼‰<ul>
<li>Dex æ–‡ä»¶ç»“æ„ä¸­çš„ <strong>DexClassDef</strong> ç»“æ„å®šä¹‰äº†å„ä¸ªç±»çš„ä¿¡æ¯ï¼Œå…¶ä¸­çš„ <strong>DexClassData</strong> ç»“æ„è®°å½•äº†ç±»çš„ <strong>å­—æ®µ</strong> å’Œ <strong>æ–¹æ³•æ•°æ®</strong>ï¼›</li>
<li>æ–¹æ³•ç”± <strong>DexMethod</strong> ç»“æ„ä¿å­˜ï¼Œå…¶ codeOff æˆå‘˜ä¿å­˜äº†æ–¹æ³•çš„å­—èŠ‚ç æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„åç§»ï¼Œæ ¹æ®è¯¥åç§»å¯ä»¥è¿›è¡ŒæŠ½å–ã€‚</li>
</ul>
</li>
</ol>
<p><strong>LoadMethod</strong> å£°æ˜å¦‚ä¸‹</p>
<pre><code class="language-c++">//Android 7åŠä»¥å‰
  void LoadMethod(Thread* self,
                  const DexFile&amp; dex_file,
                  const ClassDataItemIterator&amp; it,
                  Handle&lt;mirror::Class&gt; klass, ArtMethod* dst)
//Android 8-9
  void LoadMethod(const DexFile&amp; dex_file,
                  const ClassDataItemIterator&amp; it,
                  Handle&lt;mirror::Class&gt; klass, ArtMethod* dst)
//Android 10-14
    void LoadMethod(const DexFile&amp; dex_file,
                  const ClassAccessor::Method&amp; method,
                  Handle&lt;mirror::Class&gt; klass,
                  ArtMethod* dst)
     
//Android 15
  void LoadMethod(const DexFile&amp; dex_file,
                  const ClassAccessor::Method&amp; method,
                  ObjPtr&lt;mirror::Class&gt; klass,
                  /*inout*/ MethodAnnotationsIterator* mai,
                  /*out*/ ArtMethod* dst)
</code></pre>
<p><strong>DefineClass</strong> å£°æ˜å¦‚ä¸‹</p>
<pre><code class="language-c++">// Android 5.0 Level 21 åŠä¹‹å‰ä½¿ç”¨è¯¥å£°æ˜
static void* (*g_originDefineClassV21)(void* thiz,
                                       const char* descriptor,
                                       void* class_loader,
                                       const void* dex_file,
                                       const void* dex_class_def);
/*
//åŸå§‹å£°æ˜
mirror::Class* DefineClass(const char* descriptor,
                            Handle&lt;mirror::ClassLoader&gt; class_loader,
                            const DexFile&amp; dex_file,
                            const DexFile::ClassDef&amp; dex_class_def)
*/
 
// Android 5.1-14 Level22-34ä½¿ç”¨è¯¥å£°æ˜
static void* (*g_originDefineClassV22)(void* thiz,
                                       void* self,
                                       const char* descriptor,
                                       size_t hash,
                                       void* class_loader,
                                       const void* dex_file,
                                       const void* dex_class_def);
/*
//åŸå§‹å£°æ˜
ObjPtr&lt;mirror::Class&gt; DefineClass(Thread* self,
                                  const char* descriptor,
                                  size_t hash,
                                  Handle&lt;mirror::ClassLoader&gt; class_loader,
                                  const DexFile&amp; dex_file,
                                  const dex::ClassDef&amp; dex_class_def)
*/
 
//Android 15 Level 35 ä»¥åä½¿ç”¨è¯¥å£°æ˜
static void* (*g_originDefineClassV35)(void* thiz,
                                       void* self,
                                       const char* descriptor,
                                       size_t descriptor_length,
                                       size_t hash,
                                       void* class_loader,
                                       const void* dex_file,
                                       const void* dex_class_def);
//åŸå§‹å£°æ˜
/*
ObjPtr&lt;mirror::Class&gt; DefineClass(Thread* self,
                                  const char* descriptor,
                                  size_t descriptor_length,
                                  size_t hash,
                                  Handle&lt;mirror::ClassLoader&gt; class_loader,
                                  const DexFile&amp; dex_file,
                                  const dex::ClassDef&amp; dex_class_def)
*/
</code></pre>
<h4 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h4><h5 id="æºç¨‹åº3"><a href="#æºç¨‹åº3" class="headerlink" title="æºç¨‹åº3"></a>æºç¨‹åº3</h5><p>ä¸»è¦åŒ…æ‹¬ 3 ä¸ªæŠ€æœ¯ç‚¹ï¼ˆåŒä¸Šï¼‰ï¼š</p>
<ol>
<li>Native å±‚ NDK å¼€å‘ï¼›</li>
<li>Multidex</li>
<li>è‡ªå®šä¹‰ Application</li>
</ol>
<hr>
<h5 id="åŠ å£³ç¨‹åº-2"><a href="#åŠ å£³ç¨‹åº-2" class="headerlink" title="åŠ å£³ç¨‹åº"></a>åŠ å£³ç¨‹åº</h5><p>åŠ å£³ç¨‹åºä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ¨¡å—</p>
<ol>
<li>APK å¤„ç†æ¨¡å—ï¼šæä¾›è§£åŒ… APKã€æ‰“åŒ… APKã€ç­¾å APK çš„åŠŸèƒ½ï¼›</li>
<li>XML å¤„ç†æ¨¡å—ï¼šæä¾›è¯»å–æ ‡ç­¾ã€ä¿®æ”¹æ ‡ç­¾ã€æ·»åŠ æ ‡ç­¾çš„åŠŸèƒ½ï¼›</li>
<li>DEX å¤„ç†æ¨¡å—ï¼šæä¾›åˆå¹¶å¤š Dexï¼ŒåŠ å¯† Dexï¼Œä»£ç æŠ½å–ã€æ–‡ä»¶ä¿®å¤çš„åŠŸèƒ½ã€‚</li>
</ol>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821160930725.png" alt="image-20250821160930725"></p>
<p>åŠ å£³ç¨‹åºå·¥ä½œåŸºæœ¬æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821161000396.png" alt="image-20250821161000396"></p>
<p>åŠ å£³ç¨‹åºå·¥ä½œæµç¨‹æ€»è§ˆå›¾å¦‚ä¸‹ï¼š<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821161209038.png" alt="image-20250821161209038"></p>
<p>ç›¸å¯¹äº SecondShell.py çš„æ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>start<ul>
<li>è§£åŒ…åŸ APK å è°ƒç”¨ extractAllDexFiles æŠ½å–å‡ºæ‰€æœ‰ dex æ–‡ä»¶çš„ä»£ç ï¼›</li>
<li>å¦å¤–å¤åˆ¶äº†å£³ APK çš„ lib åº“åˆ°æ–° APK çš„ä¸´æ—¶ç›®å½•ï¼ˆhook å’Œä»£ç å›å¡«é€»è¾‘åœ¨ native å±‚ï¼‰ï¼›</li>
</ul>
</li>
<li>extractAllDexFiles<ul>
<li>éå†æŒ‡å®šç›®å½•çš„æ‰€æœ‰ dex æ–‡ä»¶ï¼Œè°ƒç”¨ ReadDex æŠ½å–ä»£ç ï¼Œå¾—åˆ°å¯¹åº”çš„ .patched å’Œ .codes æ–‡ä»¶ï¼›</li>
<li>ä¿®å¤ patch åçš„ dex æ–‡ä»¶å¹¶è¦†å†™åŸ dex æ–‡ä»¶ï¼Œå°† codes ç§»åŠ¨åˆ° assets ç›®å½•ä¸‹ã€‚</li>
</ul>
</li>
</ol>
<pre><code class="language-python">from zlib import adler32
from hashlib import sha1
from binascii import unhexlify
from lxml import etree
import subprocess
import shutil
from pathlib import Path
import argparse


# Pathsç±»,ç®¡ç†å…¨å±€ç”¨åˆ°çš„è·¯å¾„
class Paths:
    def __init__(self, srcApk: Path, shellApk: Path, outputApk: Path):
        # ç›¸å…³APKæ–‡ä»¶è·¯å¾„
        self.srcApkPath = srcApk.resolve()  # è§£æä¸ºç»å¯¹è·¯å¾„
        self.shellApkPath = shellApk.resolve()
        self.newApkPath = outputApk.resolve()

        # ä¸´æ—¶ç›®å½• ä»¥è¯¥è„šæœ¬æ–‡ä»¶çˆ¶ç›®å½•ä¸ºæ ¹ç›®å½•
        self.tmpdir = Path(__file__).parent / &#39;temp&#39;
        self.srcApkTempDir = self.tmpdir / &#39;srcApkTemp&#39;
        self.shellApkTempDir = self.tmpdir / &#39;shellApkTemp&#39;
        self.newApkTempDir = self.tmpdir / &#39;newApkTemp&#39;


# Apktoolç±»,é€šè¿‡subprocessè°ƒç”¨å…¶ä»–å·¥å…· æä¾›è§£åŒ…,æ‰“åŒ…,ç­¾å,æŠ½å–ä»£ç åŠŸèƒ½
class Apktool:
    def __init__(self):
        self.apktool_path = Path(__file__).parent.parent / &#39;tools/apktool/apktool.bat&#39;
        self.signer_path = Path(__file__).parent / &#39;tools/uber-apk-signer-1.3.0.jar&#39;
        self.readDex_path = Path(__file__).parent / &#39;tools/ReadDex.exe&#39;

    # ä¸ºapkç­¾å
    def signApk(self, unsignedApkPath: Path):
        self.runCommand([&#39;java&#39;, &#39;-jar&#39;, self.signer_path, &#39;--apk&#39;, unsignedApkPath])

    # ä½¿ç”¨apktoolè§£åŒ…apk åªè§£åŒ…èµ„æºå¾—åˆ°AndroidManifest.xml ä¸éœ€è¦è§£åŒ…dexæ–‡ä»¶å¾—åˆ°smali
    def unpackApk(self, apkPath: Path, outputDir: Path):
        self.runCommand([self.apktool_path, &#39;d&#39;, apkPath, &#39;-s&#39;, &#39;-o&#39;, outputDir])

    # é‡æ‰“åŒ…apk
    def repackApk(self, inputDir: Path, outApk: Path):
        self.runCommand([self.apktool_path, &#39;b&#39;, inputDir, &#39;-o&#39;, outApk])

    # æŠ½å–æŒ‡å®šdexæ–‡ä»¶çš„ä»£ç 
    def extractDexCodes(self, dexPath: Path):
        # è°ƒç”¨ReadDex.exeæŠ½å–dexæ–‡ä»¶ä»£ç ,è¾“å‡ºåˆ°åŒçº§ç›®å½• ä¾‹å¦‚classes.dexæŠ½å–åç”Ÿæˆclasses.dex.patchedå’Œclasses.dex.codes
        self.runCommand([self.readDex_path, &#39;-file&#39;, dexPath, &#39;-extractCodes&#39;])

    # æ‰§è¡Œå‘½ä»¤
    def runCommand(self, args):
        # subprocess.run(args)
        subprocess.run(args, stdout=subprocess.DEVNULL)  # ä»…è°ƒç”¨å·¥å…·,ä¸éœ€è¦é¢å¤–è¾“å‡º,é‡å®šå‘stdoutåˆ°os.devnull
        # å‚æ•°åˆ—è¡¨ æ•è·è¾“å‡º è¾“å‡ºè½¬ä¸ºå­—ç¬¦ä¸²
        # print(subprocess.run(args,  capture_output=True,text=True).stdout)


# AndroidManifest.xmlçš„editor ç”¨äºè·å–å’Œä¿®æ”¹æ ‡ç­¾å±æ€§,ä»¥åŠæ·»åŠ æ ‡ç­¾
class ManifestEditor:
    def __init__(self, xml_content: bytes):
        self.ns = &#123;&#39;android&#39;: &#39;http://schemas.android.com/apk/res/android&#39;&#125;
        self.tree = etree.fromstring(xml_content)

    # è·å–æŒ‡å®šæ ‡ç­¾çš„androidå±æ€§å€¼ examples: get_attr(&#39;application&#39;, &#39;name&#39;) get_attr(&#39;activity&#39;, &#39;name&#39;)
    def getTagAttribute(self, tag_name: str, attr_name: str):
        if tag_name == &#39;manifest&#39;:  # æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.get(f&#39;&#123;attr_name&#125;&#39;)  # å¯»æ‰¾æ ‡ç­¾çš„å±æ€§
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                return elem.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;)  # æ ¹æ ‡ç­¾ä¹‹å¤–çš„å±æ€§ä½äºandroidå‘½åç©ºé—´ä¸‹
        return None

    # è®¾ç½®æŒ‡å®šæ ‡ç­¾çš„å±æ€§å€¼ example:s et_attr(&#39;application&#39;,&#39;name&#39;,&quot;com.example.ProxyApplication&quot;)
    def setTagAttribute(self, tag_name: str, attr_name: str, new_value: str):
        if tag_name == &#39;manifest&#39;:  # æ ¹æ ‡ç­¾ç‰¹æ®Šå¤„ç†
            elem = self.tree
            if elem is not None:
                return elem.set(f&#39;&#123;attr_name&#125;&#39;, new_value)  # è®¾ç½®å±æ€§å€¼
        else:
            elem = self.tree.find(f&#39;.//&#123;tag_name&#125;&#39;, namespaces=self.ns)
            if elem is not None:
                elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;attr_name&#125;&#39;, new_value)
                return True
        return False

    # åœ¨æŒ‡å®šçˆ¶æ ‡ç­¾ä¸‹æ·»åŠ æ–°å­æ ‡ç­¾ example: add_tag(&#39;application&#39;,&quot;meta-data&quot;,&#123;&#39;name&#39;: &#39;android.permission.CAMERA&#39;,&#39;value&#39;:&#39;hello&#39;&#125;)
    def addTagWithAttributes(self, parent_tag: str, new_tag: str, attrs: dict):
        if parent_tag == &#39;manifest&#39;:
            parent = self.tree
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items():  # æ”¯æŒä¸€æ¬¡ç»™æ·»åŠ çš„æ ‡ç­¾è®¾ç½®å¤šä¸ªå±æ€§
                    new_elem.set(f&#39;&#123;k&#125;&#39;, v)
                return True
        else:
            parent = self.tree.find(f&#39;.//&#123;parent_tag&#125;&#39;, namespaces=self.ns)
            if parent is not None:
                new_elem = etree.SubElement(parent, new_tag)
                for k, v in attrs.items():
                    new_elem.set(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;&#123;k&#125;&#39;, v)
                return True
        return False

    # ä¸ä»¥å£³manifestä¸ºåŸºå‡†æ“ä½œåˆ™ç”¨ä¸åˆ°è¯¥å‡½æ•°,ä»¥æºapkçš„manifestä¸ºåŸºå‡†è‡ªå¸¦,æ— éœ€é¢å¤–è®¾ç½®
    def getMainActivity(self):
        activities = self.tree.findall(&#39;.//activity&#39;, namespaces=self.ns)
        for activity in activities:
            intent_filters = activity.findall(&#39;.//intent-filter&#39;, namespaces=self.ns)
            for intent_filter in intent_filters:
                action = intent_filter.find(&#39;.//action[@android:name=&quot;android.intent.action.MAIN&quot;]&#39;, namespaces=self.ns)
                category = intent_filter.find(&#39;.//category[@android:name=&quot;android.intent.category.LAUNCHER&quot;]&#39;,
                                              namespaces=self.ns)
                if action is not None and category is not None:
                    return activity.get(f&#39;&#123;&#123;&#123;self.ns["android"]&#125;&#125;&#125;name&#39;)
        return None

    # è·å–applicationæ ‡ç­¾çš„nameå±æ€§å€¼
    def getApplicationName(self):
        return self.getTagAttribute(&#39;application&#39;, &#39;name&#39;)

    # è®¾ç½®applicationæ ‡ç­¾çš„nameå±æ€§å€¼
    def setApplicationName(self, application: str):
        self.setTagAttribute(&#39;application&#39;, &#39;name&#39;, application)

    # æ·»åŠ meta-dataæ ‡ç­¾,å¹¶è®¾ç½®nameå’Œvalueå±æ€§å€¼
    def addMetaData(self, name: str, value: str):
        self.addTagWithAttributes(&#39;application&#39;, &#39;meta-data&#39;, &#123;&#39;name&#39;: name, &#39;value&#39;: value&#125;)

    # è·å–AndroidManifest.xmlçš„å­—ç¬¦ä¸²
    def getManifestData(self):
        &quot;&quot;&quot;è¿”å›XMLå­—ç¬¦ä¸²&quot;&quot;&quot;
        return etree.tostring(self.tree, pretty_print=True, encoding=&#39;utf-8&#39;, xml_declaration=True).decode()

    # è·å–applicationæ ‡ç­¾çš„extractNativeLibså±æ€§å€¼
    def getEtractNativeLibs(self):
        return self.getTagAttribute(&#39;application&#39;, &#39;extractNativeLibs&#39;)

    # è®¾ç½®applicationæ ‡ç­¾çš„extractNativeLibså±æ€§å€¼ä¸ºtrue
    def resetExtractNativeLibs(self):
        self.setTagAttribute(&#39;application&#39;, &#39;extractNativeLibs&#39;, &#39;true&#39;)


# å·¥å…·å‡½æ•°,æ³¨æ„ä¿®å¤æ—¶é¡ºåºä¸º: fileSize-&gt;signature-&gt;checksum
# ä¿®å¤dexæ–‡ä»¶çš„checksum
def fixCheckSum(dexBytes: bytearray):
    # dexfile[8:12] å°ç«¯åº4å­—èŠ‚
    value = adler32(bytes(dexBytes[12:]))
    valueArray = bytearray(value.to_bytes(4, &#39;little&#39;))
    for i in range(len(valueArray)):
        dexBytes[8 + i] = valueArray[i]


# ä¿®å¤dexæ–‡ä»¶çš„signature
def fixSignature(dexBytes: bytearray):
    # dexfile[12:32] å°ç«¯åº20å­—èŠ‚
    sha_1 = sha1()
    sha_1.update(bytes(dexBytes[32:]))
    value = sha_1.hexdigest()
    valueArray = bytearray(unhexlify(value))
    for i in range(len(valueArray)):
        dexBytes[12 + i] = valueArray[i]


# ä¿®å¤dexæ–‡ä»¶çš„filesize
def fixFileSize(dexBytes: bytearray, fileSize):
    # dexfile[32:36] å°ç«¯å­˜å‚¨
    fileSizeArray = bytearray(fileSize.to_bytes(4, &quot;little&quot;))
    for i in range(len(fileSizeArray)):
        dexBytes[32 + i] = fileSizeArray[i]


# åŠ å¯†å‡½æ•°,ä½¿ç”¨å¼‚æˆ–
def encrypt(data: bytearray):
    # todo:ä½¿ç”¨aes/sm4ç­‰åŠ å¯†ç®—æ³•æ›¿ä»£
    for i in range(len(data)):
        data[i] ^= 0xff
    return data


# æŠ½å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰dexæ–‡ä»¶çš„ä»£ç  patchæ‰€æœ‰dexæ–‡ä»¶å¹¶ä¿®å¤,å°†codesæ–‡ä»¶ç§»åŠ¨åˆ°assetsç›®å½•ä¸‹
def extractAllDexFiles(directory: Path):
    apktool = Apktool()
    # 1.éå†ç›®å½•ä¸‹çš„æ‰€æœ‰dexæ–‡ä»¶,å¹¶æŠ½å–å¯¹åº”ä»£ç 
    for dex in directory.glob(&#39;classes*.dex&#39;):
        apktool.extractDexCodes(dex)  # æŠ½å–dexæ–‡ä»¶ä»£ç  å¾—åˆ°classes*.dex.patchedå’Œclasses*.dex.codes

    # 2.ä¿®å¤æŠ½å–åçš„æ–‡ä»¶å¹¶è¦†å†™åŸdexæ–‡ä»¶
    for patchedDex in directory.glob(&#39;classes*.dex.patched&#39;):
        newDexName = str(patchedDex).replace(&#39;.patched&#39;, &#39;&#39;)  # é‡å‘½å
        # è¯»å–æ–‡ä»¶å†…å®¹
        with open(patchedDex, &#39;rb&#39;) as f:
            data = bytearray(f.read())
            # ä¿®å¤signatureå’Œchecksum,æ³¨æ„å…ˆåé¡ºåº
            fixSignature(data)
            fixCheckSum(data)
            # ä¿®å¤åçš„æ–‡ä»¶è¦†å†™åŸdexæ–‡ä»¶
            with open(newDexName, &#39;wb&#39;) as newf:
                newf.write(data)

    # 3.åˆ é™¤patchedæ–‡ä»¶
    for patchedDex in directory.glob(&#39;classes*.dex.patched&#39;):
        patchedDex.unlink()

    # 4.ç§»åŠ¨.codesæ–‡ä»¶åˆ°assetsç›®å½•ä¸‹
    # å¦‚æœæ²¡æœ‰assetsç›®å½•åˆ™åˆ›å»º
    if not (directory / &#39;assets&#39;).exists():
        (directory / &#39;assets&#39;).mkdir(parents=True)

    for codes in directory.glob(&#39;classes*.dex.codes&#39;):
        shutil.move(codes, directory / &#39;assets&#39; / codes.name)  # ç§»åŠ¨åˆ°assetsç›®å½•ä¸‹


# åˆå¹¶å£³dexå’Œæºapkçš„dex,æ”¯æŒå¤šdexæ–‡ä»¶,åˆå¹¶ä¸ºä¸€ä¸ªdex
def combineShellAndSourceDexs(shellApkTempDir: Path, srcApkTempDir: Path, newApkTempDir: Path):
    # è¯»å–è§£åŒ…åçš„apkçš„æ‰€æœ‰dexæ–‡ä»¶,å¹¶åˆå¹¶ä¸ºä¸€ä¸ªdexæ–‡ä»¶
    def readAndCombineDexs(unpackedApkDir: Path):
        combinedDex = bytearray()
        # globæ–¹æ³•è¿”å›åŒ…å«æ‰€æœ‰åŒ¹é…æ–‡ä»¶çš„ç”Ÿæˆå™¨
        for dex in unpackedApkDir.glob(&#39;classes*.dex&#39;):
            print(&#39;Source Apk Dex file:&#39;, dex)
            with open(dex, &#39;rb&#39;) as f:
                data = bytearray(f.read())
                combinedDex += bytearray(len(data).to_bytes(4, &#39;little&#39;))  # dexæ–‡ä»¶çš„é•¿åº¦,å°ç«¯åº
                combinedDex += data  # dexæ–‡ä»¶å†…å®¹
        return combinedDex

    # è·å–shelldex
    with open(shellApkTempDir / &#39;classes.dex&#39;, &#39;rb&#39;) as f:
        shellDexArray = bytearray(f.read())

    # è·å–æºapkçš„dexæ–‡ä»¶
    srcDexArray = readAndCombineDexs(srcApkTempDir)
    # æ–°çš„dexæ–‡ä»¶é•¿åº¦
    newDexLen = len(srcDexArray) + len(shellDexArray) + 4
    # åŠ å¯†æºæ–‡ä»¶
    encSrcDexArray = encrypt(srcDexArray)
    # æ–°çš„dexæ–‡ä»¶å†…å®¹ = å£³dex + åŠ å¯†çš„æºdex + å››å­—èŠ‚æ ‡è¯†åŠ å¯†åæºdexå¤§å°é•¿åº¦
    newDexArray = shellDexArray + encSrcDexArray + bytearray(len(encSrcDexArray).to_bytes(4, &#39;little&#39;))

    # ä¿®æ”¹filesize
    fixFileSize(newDexArray, newDexLen)
    # ä¿®æ”¹signature
    fixSignature(newDexArray)
    # ä¿®æ”¹checksum
    fixCheckSum(newDexArray)  # æ³¨æ„å…ˆåé¡ºåº,å…ˆä¿®æ”¹signature,å†ä¿®æ”¹checksum

    # å¯¼å‡ºæ–‡ä»¶
    with open(newApkTempDir / &#39;classes.dex&#39;, &#39;wb&#39;) as f:
        f.write(newDexArray)


# æå–æºapkçš„Manifestæ–‡ä»¶,ä¿®æ”¹applicationä¸ºå£³application(å¯èƒ½æ·»åŠ meta-dataæ ‡ç­¾),è¾“å‡ºæ–°çš„Manifestæ–‡ä»¶
def handleManifest(srcApkTempDir: Path, shellApkTempDir: Path, newApkTempDir: Path):
    # ä»æºapkæå–AndroidManifest.xml
    with open(srcApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        srcManifestEditor = ManifestEditor(f.read().encode())
    srcApplication = srcManifestEditor.getApplicationName()  # è·å–application:name,ç¡®å®šæ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰Applicationç±»
    srcExtractNativeLibs = srcManifestEditor.getEtractNativeLibs()  # è·å–application:extractNativeLibs,åˆ¤æ–­æ˜¯å¦é‡Šæ”¾libæ–‡ä»¶
    print(&#39;SourceApplication:&#39;, srcApplication)
    print(&#39;SourceExtractNativeLibs:&#39;, srcExtractNativeLibs)

    # ä»å£³apkæå–AndroidManifest.xml
    with open(shellApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;r&#39;) as f:
        shellManifestEditor = ManifestEditor(f.read().encode())
    print(&#39;ShellApplication:&#39;, shellManifestEditor.getApplicationName())

    # ä¿®æ”¹æºAndroidManifest.xmlçš„applicationä¸ºå£³çš„ä»£ç†application
    srcManifestEditor.setApplicationName(shellManifestEditor.getApplicationName())

    # å†™å…¥meta-dataæ ‡ç­¾ ä¿å­˜æºapkçš„åŸå§‹application
    if srcApplication != None:
        print(&#39;Source application:&#39;, srcApplication)
        srcManifestEditor.addMetaData(&#39;APPLICATION_CLASS_NAME&#39;, srcApplication)

    # å¦‚æœæºapkçš„manifestä¸­é»˜è®¤è®¾ç½®etractNativeLibs=false,åˆ™é‡ç½®ä¸ºtrue,ç¡®ä¿é‡Šæ”¾libæ–‡ä»¶
    if srcExtractNativeLibs == &#39;false&#39;:
        srcManifestEditor.resetExtractNativeLibs()

    # è¾“å‡ºæ–°çš„AndroidManifest.xml
    with open(newApkTempDir / &#39;AndroidManifest.xml&#39;, &#39;w&#39;) as f:
        f.write(srcManifestEditor.getManifestData())


# æ‰§è¡ŒåŠ å›ºæµç¨‹
def start(paths: Paths):
    apktool = Apktool()
    # 1.åˆ†åˆ«è§£åŒ…æºæ–‡ä»¶å’Œå£³æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
    print(&#39;Extracting source and shell apk...&#39;)
    apktool.unpackApk(paths.srcApkPath, paths.srcApkTempDir)
    print(&#39;Extract source apk success!&#39;)

    print(&#39;Extracting shell apk...&#39;)
    apktool.unpackApk(paths.shellApkPath, paths.shellApkTempDir)
    print(&#39;Extract shell apk success!&#39;)

    # 2.æŠ½å–æºdexæ–‡ä»¶ä»£ç 
    print(&#39;Exrtracting dex files codes...&#39;)
    extractAllDexFiles(paths.srcApkTempDir)
    print(&#39;Extract dex files codes success!&#39;)

    # 3.å¤åˆ¶æºapkæ‰€æœ‰æ–‡ä»¶åˆ°æ–°apkä¸´æ—¶ç›®å½•ä¸­ å¿½ç•¥æºdexå’Œmanifestæ–‡ä»¶
    print(&#39;Copying source apk files to new apk temp dir...&#39;)
    shutil.copytree(paths.srcApkTempDir, paths.newApkTempDir,
                    ignore=shutil.ignore_patterns(&#39;AndroidManifest.xml&#39;, &#39;classes*.dex&#39;))
    print(&#39;Copy source apk files success!&#39;)

    # 4.å¤åˆ¶å£³apkçš„libåº“æ–‡ä»¶åˆ°æ–°apkä¸´æ—¶ç›®å½•ä¸­ ï¼ˆå£³çš„ä»£ç å›å¡«é€»è¾‘åœ¨libä¸­å®ç°ï¼‰
    print(&#39;Copying shell apk lib files to new apk temp dir...&#39;)
    shutil.copytree(paths.shellApkTempDir / &#39;lib&#39;, paths.newApkTempDir / &#39;lib&#39;,
                    dirs_exist_ok=True)  # dirs_exist_ok=True å¦‚æœç›®æ ‡ç›®å½•å·²å­˜åœ¨,åˆ™è¦†ç›–
    print(&#39;Copy shell apk lib files success!&#39;)

    # 5.å¤„ç†AndroidManifest.xml
    print(&#39;Handling AndroidManifest.xml...&#39;)
    handleManifest(paths.srcApkTempDir, paths.shellApkTempDir, paths.newApkTempDir)
    print(&#39;Handle AndroidManifest.xml success!&#39;)

    # 6.åˆå¹¶å£³dexå’Œæºapkçš„dexå¹¶å¯¼å‡ºæ–‡ä»¶
    print(&#39;Combining shell dex and source dexs...&#39;)
    combineShellAndSourceDexs(paths.shellApkTempDir, paths.srcApkTempDir, paths.newApkTempDir)
    print(&#39;Combine shell dex and source dexs success!&#39;)

    # 7.é‡æ‰“åŒ…apk
    print(&#39;Repacking apk...&#39;)
    apktool.repackApk(paths.newApkTempDir, paths.newApkPath)
    print(&#39;Repack apk success!&#39;)

    # 8.ç­¾åapk
    print(&#39;Signing apk...&#39;)
    apktool.signApk(paths.newApkPath)
    print(&#39;Resign apk success!&#39;)

    # 9.åˆ é™¤ä¸´æ—¶ç›®å½•
    print(&#39;Deleting temp directories...&#39;)
    shutil.rmtree(paths.tmpdir)
    print(&#39;Delete temp directories success!&#39;)


def main():
    parser = argparse.ArgumentParser(description=&quot;Android APK Packer&quot;)
    parser.add_argument(&#39;-src&#39;, &#39;--src-apk&#39;, required=True, type=Path, help=&#39;Path to source APK file&#39;)
    parser.add_argument(&#39;-shell&#39;, &#39;--shell-apk&#39;, required=True, type=Path, help=&#39;Path to shell APK file&#39;)
    parser.add_argument(&#39;-o&#39;, &#39;-out&#39;, &#39;--output-apk&#39;, type=Path,
                        help=&#39;Output path for packed APK (Default: ./out/&lt;src-apk&gt;_protected.apk)&#39;)
    args = parser.parse_args()
    if args.output_apk == None:
        args.output_apk = Path(&#39;./out&#39;) / (args.src_apk.stem + &#39;_protected.apk&#39;)  # é»˜è®¤æ–°apkåç§°åŠè¾“å‡ºè·¯å¾„
    paths = Paths(args.src_apk, args.shell_apk, args.output_apk)

    print(&#39;Source APK:&#39;, paths.srcApkPath)
    print(&#39;Shell APK:&#39;, paths.shellApkPath)
    print(&#39;Output APK:&#39;, paths.newApkPath)
    start(paths)


if __name__ == &quot;__main__&quot;:
    main()
</code></pre>
<hr>
<h5 id="è„±å£³ç¨‹åº-2"><a href="#è„±å£³ç¨‹åº-2" class="headerlink" title="è„±å£³ç¨‹åº"></a>è„±å£³ç¨‹åº</h5><p>è„±å£³ç¨‹åºä¸»è¦åˆ†ä¸º 2 ä¸ªæ¨¡å—ï¼š</p>
<ol>
<li>Java å±‚ï¼šæä¾›ç¯å¢ƒåˆå§‹åŒ–ã€æ›¿æ¢ <strong>ClassLoader</strong>ã€æ›¿æ¢ <strong>Application</strong> çš„åŠŸèƒ½ï¼›</li>
<li>Native å±‚ï¼šæä¾›ç¦ç”¨ <strong>Dex2Oat</strong>ã€è®¾ç½® Dex æ–‡ä»¶å¯å†™ã€ä»£ç å›å¡«ã€ä»£ç æ–‡ä»¶è§£æçš„åŠŸèƒ½ã€‚</li>
</ol>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821163913301.png" alt="image-20250821163913301"></p>
<p>â€‹        ç»è¿‡å‰æ–‡åŠ å£³ç¨‹åºçš„å¤„ç†åï¼Œæºç¨‹åº <strong>AndroidManifest.xml</strong> æ–‡ä»¶çš„ <strong>application</strong> æ ‡ç­¾çš„ name å±æ€§æŒ‡å®šå£³çš„ applicationï¼Œç”±äº application æ˜¯ Android åº”ç”¨ç¨‹åºçœŸæ­£çš„å…¥å£ç±»ï¼Œæ‰€ä»¥å¯åŠ¨åŠ å£³åçš„ç¨‹åºæ—¶æ§åˆ¶æƒåœ¨å£³çš„ä»£ç† application ä¸­ã€‚</p>
<p>â€‹        åœ¨å£³çš„ä»£ç† application ä¸­ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>åˆå§‹åŒ–æ“ä½œ<ul>
<li>è®¾ç½®ç›¸å…³æ–‡ä»¶è·¯å¾„ï¼Œè§£æç›¸å…³æ–‡ä»¶ç”¨äºåç»­å¤„ç†</li>
</ul>
</li>
<li>æ›¿æ¢ ClassLoader<ul>
<li>æ›¿æ¢å£³ç¨‹åºçš„ ClassLoader ä¸ºè¢«ä¿æŠ¤ç¨‹åºçš„ ClassLoader</li>
</ul>
</li>
<li>æ›¿æ¢ application<ul>
<li>è‹¥è¢«ä¿æŠ¤ç¨‹åºå­˜åœ¨è‡ªå®šä¹‰ applicationï¼Œåˆ™åˆ›å»ºå®ä¾‹å¹¶æ›¿æ¢</li>
</ul>
</li>
<li>åŠ è½½å£³ so<ul>
<li>è°ƒç”¨ System.loadLiabray() ä¸»åŠ¨åŠ è½½å³å¯ï¼Œåç»­åœ¨ Native å±‚æ‰§è¡Œä»£ç å›å¡«</li>
</ul>
</li>
</ol>
<p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821164406781.png" alt="image-20250821164406781"></p>
<hr>
<h6 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h6><p>ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>è®¾ç½®ç›¸å…³ç§æœ‰ç›®å½•ï¼Œä¾›åç»­é‡Šæ”¾æ–‡ä»¶ä»¥åŠè®¾ç½® <strong>DexClassLoader</strong>ï¼›</li>
<li>ä»å£³ APK æ–‡ä»¶æå–å¹¶è§£æè¢«ä¿æŠ¤çš„ dex æ–‡ä»¶ï¼Œå†™å…¥ç§æœ‰ç›®å½•<ul>
<li>è°ƒç”¨ <strong>readDexFromApk</strong> ä»å½“å‰ APK æ–‡ä»¶ä¸­æå– classs.dexï¼Œå†è°ƒç”¨ <strong>extractDexFilesFromShellDex</strong> ä»ä¸­æå–å¹¶åˆ†ç¦»æºç¨‹åº Dex æ–‡ä»¶ï¼Œæœ€åè°ƒç”¨ <strong>writeByteBuffersToDirectory</strong> å°†å¤šä¸ª Dex æ–‡ä»¶ä¾æ¬¡å†™å…¥ç§æœ‰ç›®å½•ï¼›</li>
</ul>
</li>
<li>ä» assets ç›®å½•æå– codes æ–‡ä»¶å†™å…¥ç§æœ‰ç›®å½•<ul>
<li>è°ƒç”¨ <strong>copyClassesCodesFiles</strong> æ‰§è¡Œè¯¥æ“ä½œï¼›</li>
</ul>
</li>
<li>æ‹¼æ¥æºç¨‹åºæ‰€æœ‰çš„ dex æ–‡ä»¶çš„è·¯å¾„<ul>
<li>ç”¨ â€œ:â€ åˆ†éš”ï¼Œæ‹¼æ¥æºç¨‹åºæ‰€æœ‰ dex æ–‡ä»¶è·¯å¾„ï¼Œä¾›åç»­ <strong>DexClassLoader</strong> åŠ è½½ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ol>
<p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821164948347.png" alt="image-20250821164948347"></p>
<hr>
<h6 id="æ›¿æ¢-ClassLoader"><a href="#æ›¿æ¢-ClassLoader" class="headerlink" title="æ›¿æ¢ ClassLoader"></a>æ›¿æ¢ ClassLoader</h6><p>ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>è·å–å½“å‰ ClassLoader<ul>
<li>è°ƒç”¨ this.getClassLoader() è·å–ï¼›</li>
</ul>
</li>
<li>åå°„è·å– ActivityThread å®ä¾‹<ul>
<li>é€šè¿‡åå°„ç›´æ¥è·å– ActivityThread.sCurrentActivityThread å­—æ®µï¼Œå³å½“å‰ç¨‹åºå¯¹åº”çš„ ActivityThread å®ä¾‹ï¼›</li>
</ul>
</li>
<li>åå°„è·å– LoadedApk å®ä¾‹<ul>
<li>é¦–å…ˆåå°„è·å–ActivityThread.mPackages å­—æ®µ</li>
<li>å†æ ¹æ®å½“å‰ç¨‹åºçš„åŒ…åï¼Œä»ä¸­æŸ¥æ‰¾è·å–å¯¹åº”çš„ LoadedApk å®ä¾‹ï¼›</li>
</ul>
</li>
<li>åˆ›å»ºå¹¶æ›¿æ¢ ClassLoader<ul>
<li>å°†ç¯å¢ƒåˆå§‹åŒ–å·¥ä½œä¸­åˆ›å»ºçš„ lib å’Œ dex æ–‡ä»¶çš„ç§æœ‰ç›®å½•è·¯å¾„ä»¥åŠå½“å‰ ClassLoader ä½œä¸ºå‚æ•°ï¼Œæ–°å»º DexClassLoaderï¼Œè¯¥ ClassLoader å¯ç”¨äºåŠ è½½ä¹‹å‰é‡Šæ”¾çš„æºç¨‹åº Dex æ–‡ä»¶å’Œ libso æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>æœ€åé€šè¿‡åå°„ä¿®æ”¹ <strong>LoadedApk.mClassLoader</strong> å®ä¾‹å®Œæ•´ä¿®æ”¹ã€‚</li>
</ol>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821170928572.png" alt="image-20250821170928572"></p>
<hr>
<h6 id="æ›¿æ¢-application"><a href="#æ›¿æ¢-application" class="headerlink" title="æ›¿æ¢ application"></a>æ›¿æ¢ application</h6><p>ä¸»è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>è·å–è‡ªå®šä¹‰ application å®Œæ•´ç±»å<ul>
<li>åŒä¸Šæ–‡ï¼ŒåŠ å£³ç¨‹åºä¸º AndroidManifest.xml æ·»åŠ  meta-data æ ‡ç­¾ï¼Œå…¶ä¸­ä¿å­˜äº†æºç¨‹åºè‡ªå®šä¹‰çš„ Applicationç±»åï¼›</li>
</ul>
</li>
<li>åå°„è·å– ActivityThread å®ä¾‹ï¼ŒåŒä¸Šï¼›</li>
<li>åå°„è·å– LoadedApk å®ä¾‹ï¼Œå¹¶è®¾ç½® mApplication ä¸ºç©ºï¼›<ul>
<li>è·å– LoadedApk å®ä¾‹ä¹ŸåŒä¸Šï¼Œè®¾ç½® mApplication ä¸ºç©ºçš„åŸå› æ˜¯è°ƒç”¨ <strong>LoadedApk.makeApplication</strong> æ—¶ï¼Œå¦‚æœ mApplication ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰çš„ Applicationå®ä¾‹ï¼Œæ‰€ä»¥æƒ³è¦æ›¿æ¢ Applicationå¿…é¡»å…ˆç½®ç©ºå†åˆ›å»ºï¼›</li>
</ul>
</li>
<li>è·å– <strong>ActivityThread.mInitialApplication</strong> å¹¶åˆ é™¤å£³ Applicationï¼›</li>
<li>åå°„è°ƒç”¨ <strong>LoadedApk.makeApplication</strong> åˆ›å»ºæº Applicationï¼›</li>
<li>é‡ç½® <strong>ActivityThread.mInitialApplication</strong> ä¸ºæº Applicationï¼›</li>
<li>å¤„ç† <strong>ContentProvider</strong> æŒæœ‰çš„ä»£ç† Applicationï¼›</li>
<li><strong>è°ƒç”¨ Application.onCreate()</strong>ï¼Œæºç¨‹åºï¼Œå¯åŠ¨ï¼</li>
</ol>
<p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821172208017.png" alt="image-20250821172208017"></p>
<hr>
<h6 id="Native-å±‚"><a href="#Native-å±‚" class="headerlink" title="Native å±‚"></a>Native å±‚</h6><p>â€‹        è°ƒç”¨ System.loadLibrary ä¸»åŠ¨åŠ è½½äº†å£³çš„ so æ–‡ä»¶ï¼Œé¦–å…ˆè°ƒç”¨ <strong>init</strong> å‡½æ•°ï¼Œå…¶ä¸­ä¾æ¬¡æ‰§è¡Œä»¥ä¸‹ Hook æ“ä½œï¼ˆåŠ«æŒå¯¹åº”å‡½æ•°ï¼‰ï¼š</p>
<ol>
<li>Hook execve<ul>
<li>åœ¨ Hook åæ·»åŠ åˆ¤æ–­é€»è¾‘ï¼ŒåŒ¹é…åˆ°è°ƒç”¨ dex2oat ç³»ç»Ÿè°ƒç”¨æ—¶ç›´æ¥è¿”å›ï¼ˆdex2oat æ˜¯ ART å°†æ‰€æœ‰ Dex æ–‡ä»¶ä¼˜åŒ–ä¸ºä¸€ä¸ª OAT æ–‡ä»¶(æœ¬è´¨ä¸º ELF æ–‡ä»¶)æ“ä½œï¼Œç›®çš„æ˜¯åŠ å¿«æŒ‡ä»¤æ‰§è¡Œé€Ÿåº¦ï¼Œä½†è¿™ä¼šå½±å“åŠ å›ºå·¥å…·æ‰§è¡ŒæŒ‡ä»¤å›å¡«ï¼‰ï¼›</li>
</ul>
</li>
<li>Hook mmap<ul>
<li>åœ¨ mmap æ˜ å°„å†…å­˜æ—¶æ·»åŠ å†™æƒé™ï¼Œä¿è¯å¯ä»¥ä¿®æ”¹ DexFile è¿›è¡ŒæŒ‡ä»¤å›å¡«ï¼›</li>
</ul>
</li>
<li>Hook LoadMethod<ul>
<li>LoadMethod æœ‰ä¸¤ä¸ªå…³é”®å‚æ•°ï¼š<code>DexFile* dexFile</code> å’Œ <code>Method* method1</code>ï¼›</li>
<li>é€šè¿‡ <strong>dexFile</strong> è·å–æ–¹æ³•æ‰€åœ¨çš„ Dex æ–‡ä»¶è·¯å¾„ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦ä¸ºæºç¨‹åºè¢«æŠ½å–äº†ä»£ç çš„ Dex æ–‡ä»¶ï¼Œå¦‚æœæ˜¯åˆ™åˆ¤æ–­æ˜¯å¦è¿›è¡Œè¿‡æ–‡ä»¶è§£æï¼›</li>
<li>è‹¥æ²¡æœ‰è§£æè¿‡åˆ™è°ƒç”¨ parseExtractedCodeFiles å‡½æ•°è§£æ Dex æ–‡ä»¶å¯¹åº”çš„ codes æ–‡ä»¶ï¼Œè¿™æ ·ä¾¿æˆåŠŸåˆ›å»ºäº†ä¸€ç»„ CodeMapï¼ˆä¿å­˜ codeOff å’Œ CodeItem æ˜ å°„ï¼‰ï¼›</li>
<li>ä¹‹åè°ƒç”¨ç›®æ ‡æ–¹æ³•æ—¶ï¼Œæ ¹æ® Method.codeOff ä» CodeMap ä¸­æå–å¯¹åº”çš„ CodeItem å¹¶æ‰§è¡ŒæŒ‡ä»¤å›å¡«ï¼Œ<strong>dexFile.begin + Method.codeOff</strong> å³ä¸º <strong>insns[]</strong> æŒ‡ä»¤å­—èŠ‚æ•°ç»„çš„ä½ç½®ã€‚</li>
</ul>
</li>
</ol>
<p>å…¶ä¸­ Hook ä¸»è¦ä½¿ç”¨ <strong>BHook</strong> å’Œ <strong>Dobby</strong></p>
<ol>
<li><p>Dobby</p>
<ul>
<li><p>å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/luoyesiqiu/dpt-shell/blob/main/shell/src/main/cpp/CMakeLists.txt">https://github.com/luoyesiqiu/dpt-shell/blob/main/shell/src/main/cpp/CMakeLists.txt</a> å’Œ <a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1779984-1-1.html">https://www.52pojie.cn/thread-1779984-1-1.html</a></p>
</li>
<li><p>æºç ç¼–è¯‘ä¼¼ä¹æœ‰ç‚¹éº»çƒ¦ï¼Œé™æ€å¯¼å…¥ <strong>Dobby</strong><br>ä¸‹é¢æ˜¯å®Œæ•´çš„ CMakeLists.txt</p>
<pre><code class="language-ASN.1">cmake_minimum_required(VERSION 3.22.1)

project(&quot;androidshell3&quot;)

find_package(bytehook REQUIRED CONFIG)
include_directories(dobby)
add_library(local_dobby STATIC IMPORTED)
set_target_properties(local_dobby PROPERTIES
        IMPORTED_LOCATION $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/../../../libs/$&#123;ANDROID_ABI&#125;/libdobby.a)


add_library($&#123;CMAKE_PROJECT_NAME&#125; SHARED
        # List C/C++ source files with relative paths to this CMakeLists.txt.
        dex/DexFile.cpp
        dex/DexFile.h
        dex/CodeItem.h
        dex/class_accessor.h
        shell.cpp)

target_link_libraries($&#123;CMAKE_PROJECT_NAME&#125;
        # List libraries link to the target library
        android
        log
        local_dobby
        bytehook::bytehook)
</code></pre>
<p>ä½†æ˜¯å½“æˆ‘å» GitHub ä¸Šæ‰¾å·²ç¼–è¯‘å¥½çš„ Dobby æ—¶ï¼Œå‘ç°Android ç‰ˆæœ¬çš„ release å·²ç»æ²¡äº†ï¼Œä¸è¿‡å¥½åœ¨ä¹‹å‰å› ä¸ºå…¬å¸çš„ä¸€ä¸ªé¡¹ç›®ï¼Œç»„é•¿å‘è¿‡ä¸€ä»½ç»™æˆ‘ï¼Œå°±ç›´æ¥ç”¨äº†ã€‚</p>
</li>
</ul>
</li>
<li><p>Bhook</p>
<ul>
<li><p>å‚è€ƒ </p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/bytedance/bhook/blob/main/README.zh-CN.md">https://github.com/bytedance/bhook/blob/main/README.zh-CN.md</a> æ·»åŠ  Bhook ä¾èµ–</p>
<pre><code class="language-ASN.1">android &#123;
    buildFeatures &#123;
        prefab true
    &#125;
&#125;
 
dependencies &#123;
    implementation &#39;com.bytedance:bytehook:1.1.1&#39;
&#125;
</code></pre>
</li>
</ul>
</li>
</ol>
<p>Hook åçš„ LoadMethod ä¸»è¦å·¥ä½œå¦‚ä¸‹ï¼š</p>
<p><img src="https://nshide.oss-cn-hangzhou.aliyuncs.com/img_temp/image-20250821175351659.png" alt="image-20250821175351659"></p>
<hr>
<h6 id="ThirdProxyApplication-java"><a href="#ThirdProxyApplication-java" class="headerlink" title="ThirdProxyApplication.java"></a>ThirdProxyApplication.java</h6><p>ç›¸å¯¹ FirstProxyApplication.java çš„æ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>System.loadLibrary(â€œandroidshell3â€)<ul>
<li>ä¸»åŠ¨åŠ è½½å£³ç¨‹åºçš„ soï¼Œè®¾ç½® hookï¼›</li>
</ul>
</li>
<li>writeByteBuffersToDirectory<ul>
<li>ç”¨äºå°†å£³ dex ä¸­æå–çš„æº dex å­—èŠ‚æ•°ç»„å†™ä¸ºæ–‡ä»¶ï¼›</li>
</ul>
</li>
<li>copyClassesCodesFiles<ul>
<li>ç”¨äºå°† dex  æ–‡ä»¶å¯¹åº”çš„ codes æ–‡ä»¶å¤åˆ¶åˆ°å’Œ dex ç›¸åŒçš„ç§æœ‰ç›®å½•ã€‚</li>
</ul>
</li>
</ol>
<pre><code class="language-Java">package com.example.androidshell3;

import android.app.Application;
import android.app.Instrumentation;
import android.content.Context;
import android.content.pm.ApplicationInfo;
import android.content.pm.PackageManager;
import android.content.res.AssetManager;
import android.os.Bundle;
import android.util.ArrayMap;
import android.util.Log;

import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.lang.ref.WeakReference;
import java.nio.ByteBuffer;
import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

import dalvik.system.DexClassLoader;

public class ThirdProxyApplication extends Application &#123;
    private final String TAG=&quot;NshIdE&quot;;
    private String dexPath;
    private String odexPath;
    private String libPath;
    public void log(String message)&#123;Log.d(TAG,message);&#125;

    @Override
    protected void attachBaseContext(Context base) &#123;
        super.attachBaseContext(base);
        log(&quot;ThirdProxyApplication.attachBaseContext is running!&quot;);
        System.loadLibrary(&quot;androidshell&quot;);     //ä¸»åŠ¨åŠ è½½so,è®¾ç½®hook,è¿›è¡ŒæŒ‡ä»¤å›å¡«
        log(&quot;Load libandroidshell.so succeed!&quot;);
        try &#123;
            //åˆå§‹åŒ–ç›¸å…³ç¯å¢ƒ
            initEnvironments();
            //é…ç½®åŠ è½½æºç¨‹åºçš„åŠ¨æ€ç¯å¢ƒ,å³æ›¿æ¢mClassLoader
            replaceClassLoader();
        &#125; catch (Exception e) &#123;
            log( Log.getStackTraceString(e));
        &#125;
    &#125;
    @Override
    public void onCreate() &#123;
        super.onCreate();
        log(&quot;ThirdProxyApplication.onCreate is running!&quot;);
        if(replaceApplication())
            log(&quot;Replace Application succeed!&quot;);
    &#125;

    private void initEnvironments() throws IOException &#123;
        //1.è®¾ç½®ç›¸å…³ç›®å½•å’Œè·¯å¾„
        File dex = getDir(&quot;tmp_dex&quot;, MODE_PRIVATE);     // ç§æœ‰ç›®å½•,å­˜æ”¾dexæ–‡ä»¶
        //File lib = getDir(&quot;tmp_lib&quot;, MODE_PRIVATE);       // libå¯ä½¿ç”¨é»˜è®¤ç›®å½•
        //libPath = lib.getAbsolutePath();
        odexPath = dex.getAbsolutePath();
        libPath=this.getApplicationInfo().nativeLibraryDir; //é»˜è®¤libè·¯å¾„
        dexPath =this.getApplicationInfo().sourceDir;   //å½“å‰base.apkè·¯å¾„
        //2.ä»å½“å‰base.apkè¯»å–classes.dexå¹¶è¯»å–ä¸ºå­—èŠ‚æ•°ç»„
        byte[] shellDexData = readDexFromApk();
        log(&quot;Get classes.dex from base.apk succeed!&quot;);
        //3.ä»å£³dexæ–‡ä»¶ä¸­åˆ†ç¦»å‡ºæºdexæ–‡ä»¶
        ByteBuffer[] byteBuffers = extractDexFilesFromShellDex(shellDexData);
        //4.å°†æºdexæ–‡ä»¶ä¾æ¬¡å†™å…¥ç§æœ‰ç›®å½•
        writeByteBuffersToDirectory(byteBuffers, odexPath);
        //5.å°†codesæ–‡ä»¶ä¾æ¬¡å†™å…¥ç§æœ‰ç›®å½•
        copyClassesCodesFiles(this, odexPath);
        //6.æ‹¼æ¥dexç›®å½•å­—ç¬¦ä¸²,è®¾ç½®dexæ–‡ä»¶è·¯å¾„ DexClassLoaderæ”¯æŒä¼ é€’å¤šä¸ªdexæ–‡ä»¶è·¯å¾„ä»¥åŠ è½½å¤šä¸ªdexæ–‡ä»¶,é€šè¿‡&#39;:&#39;åˆ†éš”è·¯å¾„
        StringBuffer dexFiles=new StringBuffer();
        for(File file:dex.listFiles())&#123;
            if(file.getName().contains(&quot;.codes&quot;))
                continue;
            dexFiles.append(file.getAbsolutePath());
            dexFiles.append(&quot;:&quot;);
        &#125;
        dexPath=dexFiles.toString();
    &#125;
    private void writeByteBuffersToDirectory(ByteBuffer[] byteBuffers, String directoryPath) throws IOException &#123;
        // åˆ›å»ºç›®å½•å¯¹è±¡
        File directory = new File(directoryPath);
        // æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨,ä¸å­˜åœ¨åˆ™åˆ›å»º
        if (!directory.exists()) &#123;
            if (!directory.mkdirs()) &#123;
                throw new IOException(&quot;æ— æ³•åˆ›å»ºç›®å½•: &quot; + directoryPath);
            &#125;
        &#125;

        // éå† ByteBuffer æ•°ç»„
        for (int i = 0; i &lt; byteBuffers.length; i++) &#123;
            // ç”Ÿæˆæ–‡ä»¶å
            String fileName;
            if (i == 0) &#123;
                fileName = &quot;classes.dex&quot;;
            &#125; else &#123;
                fileName = &quot;classes&quot; + (i + 1) + &quot;.dex&quot;;
            &#125;
            // æ„å»ºæ–‡ä»¶å¯¹è±¡
            File file = new File(directory, fileName);
            // åˆ›å»ºæ–‡ä»¶è¾“å‡ºæµ
            try (FileOutputStream fos = new FileOutputStream(file)) &#123;
                // è·å– ByteBuffer ä¸­çš„å­—èŠ‚æ•°ç»„
                ByteBuffer buffer = byteBuffers[i];
                byte[] bytes = new byte[buffer.remaining()];
                buffer.get(bytes);
                // å°†å­—èŠ‚æ•°ç»„å†™å…¥æ–‡ä»¶
                fos.write(bytes);
            &#125;
        &#125;
    &#125;
    private void copyClassesCodesFiles(Context context, String targetDirectoryPath) &#123;
        AssetManager assetManager = context.getAssets();
        try &#123;
            // è·å– assets ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
            String[] files = assetManager.list(&quot;&quot;);
            if (files != null) &#123;
                // åˆ›å»ºç›®æ ‡ç›®å½•
                File targetDirectory = new File(targetDirectoryPath);
                if (!targetDirectory.exists()) &#123;
                    if (!targetDirectory.mkdirs()) &#123;
                        throw new IOException(&quot;æ— æ³•åˆ›å»ºç›®æ ‡ç›®å½•: &quot; + targetDirectoryPath);
                    &#125;
                &#125;
                for (String fileName : files) &#123;
                    // ç­›é€‰ä»¥ classes å¼€å¤´ä¸”ä»¥ .codes ç»“å°¾çš„æ–‡ä»¶
                    if (fileName.startsWith(&quot;classes&quot;) &amp;&amp; fileName.endsWith(&quot;.codes&quot;)) &#123;
                        try (InputStream inputStream = assetManager.open(fileName);
                             BufferedInputStream bis = new BufferedInputStream(inputStream);
                             FileOutputStream fos = new FileOutputStream(new File(targetDirectory, fileName));
                             BufferedOutputStream bos = new BufferedOutputStream(fos)) &#123;

                            byte[] buffer = new byte[1024];
                            int bytesRead;
                            while ((bytesRead = bis.read(buffer)) != -1) &#123;
                                bos.write(buffer, 0, bytesRead);
                            &#125;
                        &#125; catch (IOException e) &#123;
                            e.printStackTrace();
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;

    // ä»å£³dexæ–‡ä»¶ä¸­æå–æºapkçš„dexå¹¶å°è£…ä¸ºByteBuffer
    private ByteBuffer[] extractDexFilesFromShellDex(byte[] shellDexData) &#123;
        int shellDexlength = shellDexData.length;
        //å¼€å§‹è§£ædexæ–‡ä»¶
        byte[] sourceDexsSizeByte = new byte[4];
        //è¯»å–æºdexsçš„å¤§å°
        System.arraycopy(shellDexData,shellDexlength - 4, sourceDexsSizeByte,0,4);
        //è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int
        ByteBuffer wrap = ByteBuffer.wrap(sourceDexsSizeByte);
        //å°†byteè½¬æˆint, åŠ å£³æ—¶,é•¿åº¦æŒ‰å°ç«¯å­˜å‚¨
        int sourceDexsSizeInt = wrap.order(ByteOrder.LITTLE_ENDIAN).getInt();
        Log.d(TAG, &quot;æºdexé›†åˆçš„å¤§å°: &quot; + sourceDexsSizeInt);
        //è¯»å–æºdexs
        byte[] sourceDexsData = new byte[sourceDexsSizeInt];
        System.arraycopy(shellDexData,shellDexlength - sourceDexsSizeInt - 4, sourceDexsData, 0, sourceDexsSizeInt);
        //è§£å¯†æºdexs
        sourceDexsData = decrypt(sourceDexsData);

        //æ›´æ–°éƒ¨åˆ†
        //ä»æºdexsä¸­åˆ†ç¦»dex
        ArrayList&lt;byte[]&gt; sourceDexList = new ArrayList&lt;&gt;();
        int pos = 0;
        while(pos &lt; sourceDexsSizeInt)&#123;
            //å…ˆæå–å››ä¸ªå­—èŠ‚,æè¿°å½“å‰dexçš„å¤§å°
            //å¼€å§‹è§£ædexæ–‡ä»¶
            byte[] singleDexSizeByte = new byte[4];
            //è¯»å–æºdexsçš„å¤§å°
            System.arraycopy(sourceDexsData, pos, singleDexSizeByte,0,4);
            //è½¬æˆbytebuffer,æ–¹ä¾¿4byteè½¬int
            ByteBuffer singleDexwrap = ByteBuffer.wrap(singleDexSizeByte);
            int singleDexSizeInt = singleDexwrap.order(ByteOrder.LITTLE_ENDIAN).getInt();
            Log.d(TAG, &quot;å½“å‰Dexçš„å¤§å°: &quot; + singleDexSizeInt);
            //è¯»å–å•ç‹¬dex
            byte[] singleDexData = new byte[singleDexSizeInt];
            System.arraycopy(sourceDexsData,pos + 4, singleDexData, 0, singleDexSizeInt);
            //åŠ å…¥åˆ°dexlistä¸­
            sourceDexList.add(singleDexData);
            //æ›´æ–°pos
            pos += 4 + singleDexSizeInt;
        &#125;

        //å°†dexliståŒ…è£…æˆByteBuffer
        int dexNum = sourceDexList.size();
        Log.d(TAG, &quot;æºdexçš„æ•°é‡: &quot; + dexNum);
        ByteBuffer[] dexBuffers = new ByteBuffer[dexNum];
        for (int i = 0; i &lt; dexNum; i++)&#123;
            dexBuffers[i] = ByteBuffer.wrap(sourceDexList.get(i));
        &#125;

        return dexBuffers;

    &#125;
    // ä»å½“å‰ç¨‹åºçš„apkè¯»å–dexæ–‡ä»¶å¹¶å­˜å‚¨ä¸ºå­—èŠ‚æ•°ç»„
    private byte[] readDexFromApk() throws IOException &#123;
        //1.è·å–å½“å‰åº”ç”¨ç¨‹åºçš„æºç è·¯å¾„(apk),ä¸€èˆ¬æ˜¯data/appç›®å½•ä¸‹,è¯¥ç›®å½•ç”¨äºå­˜æ”¾ç”¨æˆ·å®‰è£…çš„è½¯ä»¶
        String sourceDir = this.getApplicationInfo().sourceDir;
        log(&quot;this.getApplicationInfo().sourceDir: &quot; +sourceDir);

        //2.åˆ›å»ºç›¸å…³è¾“å…¥æµ
        FileInputStream fileInputStream = new FileInputStream(sourceDir);
        BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
        ZipInputStream zipInputStream = new ZipInputStream(bufferedInputStream); //ç”¨äºè§£æapkæ–‡ä»¶

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); //ç”¨äºå­˜æ”¾dexæ–‡ä»¶

        //3.éå†apkçš„æ‰€æœ‰æ–‡ä»¶å¹¶æå–dexæ–‡ä»¶
        ZipEntry zipEntry;
        while((zipEntry = zipInputStream.getNextEntry()) != null)&#123; //å­˜åœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶
            // å°†classes.dexæ–‡ä»¶å­˜å‚¨åˆ°bytearrayä¸­ å£³dexå’Œæºapkåˆå¹¶ååªä¿ç•™ä¸€ä¸ªdexä¾¿äºå¤„ç†
            if (zipEntry.getName().equals(&quot;classes.dex&quot;))&#123;
                byte[] bytes = new byte[1024];
                int num;
                while((num = zipInputStream.read(bytes))!=-1)&#123;      //æ¯æ¬¡è¯»å–1024byte,è¿”å›è¯»å–åˆ°çš„byteæ•°
                    byteArrayOutputStream.write(bytes,0, num); //å­˜æ”¾åˆ°å¼€è¾Ÿçš„byteArrayOutputStreamä¸­
                &#125;
            &#125;
            zipInputStream.closeEntry(); //å…³é—­å½“å‰æ–‡ä»¶
        &#125;
        zipInputStream.close();

        log(&quot;Read dex from apk succeed!&quot;);
        return byteArrayOutputStream.toByteArray(); //å°†è¯»å–åˆ°çš„dexæ–‡ä»¶ä»¥å­—èŠ‚æ•°ç»„å½¢å¼è¿”å›
    &#125;
    // è§£å¯†
    private byte[] decrypt(byte[] data) &#123;
        for (int i = 0; i &lt; data.length; i++)&#123;
            data[i] ^= (byte) 0xff;
        &#125;
        return data;

    &#125;
    //æ›¿æ¢å£³ç¨‹åºLoadedApkçš„Applicationä¸ºæºç¨‹åºApplication,å¹¶è°ƒç”¨å…¶onCreateæ–¹æ³•
    private boolean replaceApplication()&#123;
        // Applicationå®ä¾‹å­˜åœ¨äº: LoadedApk.mApplication
        // ä»¥åŠActivityThreadçš„mInitialApplicationå’ŒmAllApplicationså’ŒmBoundApplication

        //åˆ¤æ–­æºç¨‹åºæ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰Application è‹¥ä½¿ç”¨åˆ™éœ€è¦è¿›è¡Œæ›¿æ¢,è‹¥æœªä½¿ç”¨åˆ™ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„é»˜è®¤Applicationå³å¯

        String appClassName = null; //æºç¨‹åºçš„Applicationç±»å
        try &#123;
            //è·å–AndroidManifest.xml æ–‡ä»¶ä¸­çš„ &lt;meta-data&gt; å…ƒç´ 
            ApplicationInfo applicationInfo = getPackageManager().getApplicationInfo(this.getPackageName(), PackageManager.GET_META_DATA);
            Bundle metaData = applicationInfo.metaData;
            //è·å–xmlæ–‡ä»¶å£°æ˜çš„Applicationç±»
            if (metaData != null &amp;&amp; metaData.containsKey(&quot;APPLICATION_CLASS_NAME&quot;))&#123;
                appClassName = metaData.getString(&quot;APPLICATION_CLASS_NAME&quot;);
            &#125; else &#123;
                log(&quot;æºç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰Application&quot;);
                return false; //å¦‚æœä¸å­˜åœ¨ç›´æ¥è¿”å›,ä½¿ç”¨å£³çš„applicationå³å¯
            &#125;
        &#125; catch (PackageManager.NameNotFoundException e) &#123;
            log(Log.getStackTraceString(e));
        &#125;

        //æºç¨‹åºå­˜åœ¨è‡ªå®šä¹‰applicationç±»,å¼€å§‹æ›¿æ¢
        log(&quot;Try to replace Application&quot;);

        //1.åå°„è·å–ActivityThreadå®ä¾‹
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread: &quot; + sCurrentActivityThreadObj.toString());

        //2.è·å–å¹¶è®¾ç½®LoadedApk
        //è·å–mBoundApplication (AppBindDataå¯¹è±¡)
        Object mBoundApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mBoundApplication&quot;) ;
        log(&quot;mBoundApplication: &quot;+mBoundApplicationObj.toString());
        //è·å–mBoundApplication.info (å³LoadedApk)
        Object infoObj = Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;info&quot;);
        log( &quot;LoadedApk: &quot; + infoObj.toString());
        //æŠŠLoadedApkçš„mApplicationè®¾ç½®ä¸ºnull,è¿™æ ·åç»­æ‰èƒ½è°ƒç”¨makeApplication() å¦åˆ™ç”±äºå·²å­˜åœ¨Application,æ— æ³•è¿›è¡Œæ›¿æ¢
        Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mApplication&quot;,infoObj,null);

        //3.è·å–ActivityThread.mInitialApplication å³æ‹¿åˆ°æ—§çš„Application(å¯¹äºè¦åŠ è½½çš„Applicationæ¥è®²)
        Object mInitialApplicationObj = Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mInitialApplication&quot;);
        log(&quot;mInitialApplicationObj: &quot; + mInitialApplicationObj.toString());

        //4.è·å–ActivityThread.mAllApplicationså¹¶åˆ é™¤æ—§çš„application
        ArrayList&lt;Application&gt; mAllApplicationsObj = (ArrayList&lt;Application&gt;) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mAllApplications&quot;);
        mAllApplicationsObj.remove(mInitialApplicationObj);
        log(&quot;mInitialApplication ä» mAllApplications ä¸­ç§»é™¤æˆåŠŸ&quot;);

        //5.é‡ç½®ç›¸å…³ç±»çš„Applicationç±»å ä¾¿äºåç»­åˆ›å»ºApplication
        //è·å–LoadedApk.mApplicationInfo
        ApplicationInfo applicationInfo = (ApplicationInfo) Reflection.getField(&quot;android.app.LoadedApk&quot;,infoObj,&quot;mApplicationInfo&quot;);
        log( &quot;LoadedApk.mApplicationInfo: &quot; + applicationInfo.toString());
        //è·å–mBoundApplication.appInfo
        ApplicationInfo appinfoInAppBindData = (ApplicationInfo) Reflection.getField(&quot;android.app.ActivityThread$AppBindData&quot;,mBoundApplicationObj,&quot;appInfo&quot;);
        log(&quot;ActivityThread.mBoundApplication.appInfo: &quot; + appinfoInAppBindData.toString());
        //æ­¤å¤„é€šè¿‡å¼•ç”¨ä¿®æ”¹å€¼,è™½ç„¶åç»­æ²¡æœ‰ä½¿ç”¨,ä½†æ˜¯å®é™…ä¸Šæ˜¯ä¿®æ”¹å…¶æŒ‡å‘çš„LoadedApkç›¸å…³å­—æ®µçš„å€¼
        //è®¾ç½®ä¸¤ä¸ªappinfoçš„classnameä¸ºæºç¨‹åºçš„applicationç±»å,ä»¥ä¾¿åç»­è°ƒç”¨makeApplication()åˆ›å»ºæºç¨‹åºçš„application
        applicationInfo.className = appClassName;
        appinfoInAppBindData.className = appClassName;
        log(&quot;Source Application name: &quot; + appClassName);

        //6.åå°„è°ƒç”¨makeApplicationæ–¹æ³•åˆ›å»ºæºç¨‹åºçš„application
        Application application = (Application) Reflection.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;false,null&#125;); //ä½¿ç”¨æºç¨‹åºä¸­çš„application
        //Application app = (Application)ReflectionMethods.invokeMethod(&quot;android.app.LoadedApk&quot;,&quot;makeApplication&quot;,infoObj,new Class[]&#123;boolean.class, Instrumentation.class&#125;,new Object[]&#123;true,null&#125;); //ä½¿ç”¨è‡ªå®šä¹‰çš„application å¼ºåˆ¶ä¸ºç³»ç»Ÿé»˜è®¤
        log(&quot;Create source Application succeed: &quot;+application);

        //7.é‡ç½®ActivityThread.mInitialApplicationä¸ºæ–°çš„Application
        Reflection.setField(&quot;android.app.ActivityThread&quot;,&quot;mInitialApplication&quot;,sCurrentActivityThreadObj,application);
        log(&quot;Reset ActivityThread.mInitialApplication by new Application succeed!&quot;);

        //8.ContentProviderä¼šæŒæœ‰ä»£ç†çš„Application,éœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹
        ArrayMap mProviderMap = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mProviderMap&quot;);
        log(&quot;ActivityThread.mProviderMap: &quot; + mProviderMap);

        //è·å–æ‰€æœ‰provider,è£…è¿›è¿­ä»£å™¨ä¸­éå†
        Iterator iterator = mProviderMap.values().iterator();
        while(iterator.hasNext())&#123;
            Object providerClientRecord = iterator.next();
            //è·å–ProviderClientRecord.mLocalProvider,å¯èƒ½ä¸ºç©º
            Object mLocalProvider = Reflection.getField(&quot;android.app.ActivityThread$ProviderClientRecord&quot;,providerClientRecord,&quot;mLocalProvider&quot;) ;
            if(mLocalProvider != null)&#123;
                log(&quot;ProviderClientRecord.mLocalProvider: &quot; + mLocalProvider);
                //è·å–ContentProviderä¸­çš„mContextå­—æ®µ,è®¾ç½®ä¸ºæ–°çš„Application
                Reflection.setField(&quot;android.content.ContentProvider&quot;,&quot;mContext&quot;,mLocalProvider,application);
            &#125;
        &#125;

        log( &quot;Run Application.onCreate&quot; );
        application.onCreate(); //æºç¨‹åº,å¯åŠ¨!
        return true;
    &#125;
    // æ›¿æ¢å£³Appçš„ClassLoaderä¸ºæºAppçš„ClassLoader
    private void replaceClassLoader() &#123;
        //1.è·å–å½“å‰çš„classloader
        ClassLoader classLoader = this.getClassLoader();
        log(&quot;Current ClassLoader: &quot; + classLoader.toString());
        log(&quot;Parent ClassLoader: &quot; + classLoader.getParent().toString());

        //2.åå°„è·å–ActivityThread
        Object sCurrentActivityThreadObj = Reflection.getStaticField(&quot;android.app.ActivityThread&quot;,&quot;sCurrentActivityThread&quot;);
        log(&quot;ActivityThread.sCurrentActivityThread: &quot; + sCurrentActivityThreadObj.toString());

        //3.åå°„è·å–LoadedApk
        //è·å–å½“å‰ActivityThreadå®ä¾‹çš„mPackageså­—æ®µ ç±»å‹ä¸ºArrayMap&lt;String, WeakReference&lt;LoadedApk&gt;&gt;, é‡Œé¢å­˜æ”¾äº†å½“å‰åº”ç”¨çš„LoadedApkå¯¹è±¡
        ArrayMap mPackagesObj = (ArrayMap) Reflection.getField(&quot;android.app.ActivityThread&quot;,sCurrentActivityThreadObj,&quot;mPackages&quot;);
        log( &quot;mPackagesObj: &quot; + mPackagesObj.toString());

        //è·å–mPackagesä¸­çš„å½“å‰åº”ç”¨åŒ…å
        String currentPackageName = this.getPackageName();
        log(&quot;currentPackageName: &quot; + currentPackageName);

        // è·å–loadedApkå®ä¾‹ä¹Ÿæœ‰å¥½å‡ ç§,mInitialApplication mAllApplications mPackages
        // é€šè¿‡åŒ…åè·å–å½“å‰åº”ç”¨çš„loadedApkå®ä¾‹
        WeakReference weakReference = (WeakReference) mPackagesObj.get(currentPackageName);
        Object loadedApkObj = weakReference.get();
        log( &quot;LoadedApk: &quot; + loadedApkObj.toString());

        //4.æ›¿æ¢ClassLoader
        DexClassLoader dexClassLoader = new DexClassLoader(dexPath, odexPath,libPath, classLoader.getParent()); //åŠ¨æ€åŠ è½½æºç¨‹åºçš„dexæ–‡ä»¶,ä»¥å½“å‰classloaderçš„çˆ¶åŠ è½½å™¨ä½œä¸ºparent
        Reflection.setField(&quot;android.app.LoadedApk&quot;,&quot;mClassLoader&quot;,loadedApkObj,dexClassLoader); //æ›¿æ¢å½“å‰loadedApkå®ä¾‹ä¸­çš„mClassLoaderå­—æ®µ
        log(&quot;New DexClassLoader: &quot; + dexClassLoader);
    &#125;
&#125;
</code></pre>
<hr>
<h6 id="shell-cpp"><a href="#shell-cpp" class="headerlink" title="shell.cpp"></a>shell.cpp</h6><p>ä¸»è¦æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ol>
<li><p>hook execve</p>
<ul>
<li>ä¸»è¦ç›®çš„æ˜¯ç¦æ­¢ dex2oatï¼Œé˜²æ­¢ dex æ–‡ä»¶è¢«ä¼˜åŒ–ï¼›</li>
</ul>
</li>
<li><p>hook mmap</p>
<ul>
<li>ä½¿ dex æ–‡ä»¶å¯å†™,ç”¨äºåç»­æŒ‡ä»¤å›å¡«ï¼›</li>
</ul>
</li>
<li><p>hook LoadMethod</p>
<ul>
<li>loadmethod ç”¨äºåŠ è½½ dex æ–‡ä»¶çš„æ–¹æ³•ï¼Œå¯è·å– dex æ–‡ä»¶å¼•ç”¨å’Œ codeoffï¼›</li>
<li>hookåŠ«æŒåæ‰§è¡Œcodesæ–‡ä»¶è§£æå’ŒæŒ‡ä»¤å›å¡«ã€‚</li>
</ul>
<pre><code class="language-c++">#include &lt;jni.h&gt;
#include &lt;string&gt;
#include &lt;unistd.h&gt;
#include &lt;map&gt;
#include &lt;fstream&gt;
#include &lt;stdlib.h&gt;
#include &lt;elf.h&gt;
#include &lt;dlfcn.h&gt;
#include &quot;android/log.h&quot;
#include &quot;sys/mman.h&quot;
#include &quot;bytehook.h&quot;
#include &quot;dobby/dobby.h&quot;
#include &quot;dex/DexFile.h&quot;
#include &quot;dex/CodeItem.h&quot;
#include &quot;dex/class_accessor.h&quot;
#define TAG &quot;NshIdE&quot;
#define logd(...) __android_log_print(ANDROID_LOG_DEBUG, TAG, __VA_ARGS__);
#define logi(...) __android_log_print(ANDROID_LOG_INFO , TAG, __VA_ARGS__);
#define loge(...) __android_log_print(ANDROID_LOG_ERROR, TAG, __VA_ARGS__);

// sdkç‰ˆæœ¬,ç”¨äºå…¼å®¹é€‚é…
int APILevel;
// å‡½æ•°å£°æ˜
void hook();
void hookExecve();
void hookMmap();
void hook_LoadMethod();

// æŠ½å–ä»£ç æ–‡ä»¶,ä¸æº.dexåœ¨åŒä¸€ç§æœ‰ç›®å½•
std::string codeFilePostfix = &quot;.codes&quot;;

//dexæ–‡ä»¶å-&gt;codeOff-&gt;CodeItem æ¯ä¸ªdexæ–‡ä»¶å¯¹åº”ä¸€ä¸ªmap,æ¯ä¸ªmapå†…çš„codeoffå¯¹åº”ä¸€ä¸ªCodeItem
std::map&lt;std::string,std::map&lt;uint32_t, CodeItem&gt;&gt; codeMapList;

//art/runtime/class_linker.h
// å‡½æ•°å£°æ˜
static void (*g_originLoadMethod)(void* thiz,
                                  const DexFile* dex_file,
                                  ClassAccessor::Method* method,
                                  void* klass,
                                  void* dst);
/*//Android 10-14 åŸå‹å¦‚ä¸‹
void LoadMethod(const DexFile&amp; dex_file,
                const ClassAccessor::Method&amp; method,
                Handle&lt;mirror::Class&gt; klass,
                ArtMethod* dst);
*/


// Tool functions

// ä»¥äºŒè¿›åˆ¶å½¢å¼è¯»å–æ•´ä¸ªæ–‡ä»¶,è¿”å›å­—èŠ‚æ•°ç»„å¹¶è¿”å›æ–‡ä»¶é•¿åº¦
uint8_t* readFileToBytes(const std::string fileName,size_t* readSize) &#123;
    FILE *file = fopen(fileName.c_str(), &quot;rb&quot;);
    if (file == NULL) &#123;
        logd(&quot;Error opening file&quot;);
        fclose(file);
        return NULL;
    &#125;
    fseek(file, 0,SEEK_END);
    size_t fileSize = ftell(file);
    fseek(file, 0,SEEK_SET);
    uint8_t *buffer = (uint8_t *) malloc(fileSize);
    if (buffer == NULL) &#123;
        logd(&quot;Error allocating memory\n&quot;);
        fclose(file);
        return NULL;
    &#125;
    size_t bytesRead = fread(buffer, 1, fileSize, file);
    if(bytesRead!=fileSize) &#123;
        logd(&quot;Read bytes not equal file size!\n&quot;);
        free(buffer);
        fclose(file);
        return NULL;
    &#125;
    fclose(file);
    if(readSize)
        *readSize=bytesRead;
    return buffer;
&#125;

// 4å­—èŠ‚æ•°ç»„è½¬uint32_t
uint32_t bytes2uint32(unsigned char * bytes)&#123;
    uint32_t retnum = 0;
    for(int i = 3;i &gt;=0;i--)&#123;
        retnum &lt;&lt;= 8;
        retnum |= bytes[i];
    &#125;
    return retnum;
&#125;

const char * getArtLibPath() &#123;
    if(APILevel &lt; 29) &#123;
        return &quot;/system/lib64/libart.so&quot;;
    &#125; else if(APILevel == 29) &#123;
        return &quot;/apex/com.android.runtime/lib64/libart.so&quot;;
    &#125; else &#123;
        return &quot;/apex/com.android.art/lib64/libart.so&quot;;
    &#125;
&#125;

const char * getArtBaseLibPath() &#123;
    if(APILevel == 29) &#123;
        return &quot;/apex/com.android.runtime/lib64/libartbase.so&quot;;
    &#125; else &#123;
        return &quot;/apex/com.android.art/lib64/libartbase.so&quot;;
    &#125;
&#125;

const char* find_symbol_in_elf_file(const char *elf_file,int keyword_count,...) &#123;
    FILE *elf_fp = fopen(elf_file, &quot;r&quot;);
    if (elf_fp) &#123;
        // è·å–elfæ–‡ä»¶å¤§å°
        fseek(elf_fp, 0L, SEEK_END);
        size_t lib_size = ftell(elf_fp);
        fseek(elf_fp, 0L, SEEK_SET);
        // è¯»å–elfæ–‡ä»¶æ•°æ®
        char *data = (char *) calloc(lib_size, 1);
        fread(data, 1, lib_size, elf_fp);
        char *elf_bytes_data = data;
        // elfå¤´
        Elf64_Ehdr *ehdr = (Elf64_Ehdr *) elf_bytes_data;
        // èŠ‚å¤´
        Elf64_Shdr *shdr = (Elf64_Shdr *) (((uint8_t *) elf_bytes_data) + ehdr-&gt;e_shoff);
        va_list kw_list;
        // éå†èŠ‚
        for (int i = 0; i &lt; ehdr-&gt;e_shnum; i++) &#123;
            // å­—ç¬¦ä¸²è¡¨
            if (shdr-&gt;sh_type == SHT_STRTAB) &#123;
                const char *str_base = (char *) ((uint8_t *) elf_bytes_data + shdr-&gt;sh_offset);
                char *ptr = (char *) str_base;
                // éå†å­—ç¬¦ä¸²è¡¨
                for (int k = 0; ptr &lt; (str_base + shdr-&gt;sh_size); k++) &#123;
                    const char *item_value = ptr;
                    size_t item_len = strnlen(item_value, 128);
                    ptr += (item_len + 1);
                    if (item_len == 0) &#123;
                        continue;
                    &#125;
                    int match_count = 0;
                    va_start(kw_list, keyword_count);
                    for (int n = 0; n &lt; keyword_count; n++) &#123;
                        const char *keyword = va_arg(kw_list, const char*);
                        if (strstr(item_value, keyword)) &#123;
                            match_count++;
                        &#125;
                    &#125;
                    va_end(kw_list);
                    if (match_count == keyword_count) &#123;
                        return item_value;
                    &#125;
                &#125;
                break;
            &#125;
            shdr++;
        &#125;
        fclose(elf_fp);
        free(data);
    &#125;
    return nullptr;
&#125;

const char * getClassLinkerDefineClassLibPath()&#123;
    return getArtLibPath();
&#125;


const char * getClassLinkerDefineClassSymbol() &#123;
    const char * sym = find_symbol_in_elf_file(getClassLinkerDefineClassLibPath(),2,&quot;ClassLinker&quot;,&quot;DefineClass&quot;);
    return sym;
&#125;


const char * getClassLinkerLoadMethodLibPath()&#123;
    return getArtLibPath();
&#125;

//è·å–ClassLinker::LoadMethodçœŸå®ç¬¦å·å
const char * getClassLinkerLoadMethodSymbol() &#123;
    const char * sym = find_symbol_in_elf_file(getClassLinkerLoadMethodLibPath(),2,&quot;ClassLinker&quot;,&quot;LoadMethod&quot;);
    return sym;
&#125;

//è·å–libartçœŸå®åç§°
const char * getArtLibName() &#123;
    //Android 10åŠä»¥åå˜ä¸ºlibartbase.so
    return APILevel &gt;= 29 ? &quot;libartbase.so&quot; : &quot;libart.so&quot;;
&#125;

// ç¦ç”¨dex2oat
int fakeExecve(const char *pathname, char *const argv[], char *const envp[]) &#123;
    BYTEHOOK_STACK_SCOPE();
    // ç¦ç”¨dex2oat
    if (strstr(pathname, &quot;dex2oat&quot;) != nullptr) &#123;
        errno = EACCES;
        return -1;
    &#125;
    return BYTEHOOK_CALL_PREV(fakeExecve, pathname, argv, envp);
&#125;

void hookExecve()&#123;
    bytehook_stub_t stub = bytehook_hook_single(
            getArtLibName(),
            &quot;libc.so&quot;,
            &quot;execve&quot;,
            (void *) fakeExecve,
            nullptr,
            nullptr);
    if (stub != nullptr) &#123;
        logd(&quot;hook execve done&quot;);
    &#125;
&#125;

//ä¸ºdexæ–‡ä»¶æ·»åŠ å¯å†™æƒé™
void* fakeMmap(void * __addr, size_t __size, int __prot, int __flags, int __fd, off_t __offset)&#123;
    BYTEHOOK_STACK_SCOPE();
    int prot = __prot;
    int hasRead = (__prot &amp; PROT_READ) == PROT_READ;
    int hasWrite = (__prot &amp; PROT_WRITE) == PROT_WRITE;
    // æ·»åŠ å†™æƒé™
    if(hasRead &amp;&amp; !hasWrite) &#123;
        prot |= PROT_WRITE;
    &#125;
    void * addr = BYTEHOOK_CALL_PREV(fakeMmap, __addr, __size, prot, __flags, __fd, __offset);
    return addr;
&#125;

void hookMmap()&#123;
    bytehook_stub_t stub = bytehook_hook_single(
            getArtLibName(),
            &quot;libc.so&quot;,
            &quot;mmap&quot;,
            (void *) fakeMmap,
            nullptr,
            nullptr);
    if(stub != nullptr)&#123;
        logd(&quot;hook mmap done&quot;);
    &#125;
&#125;

// è§£ææŠ½å–ä»£ç æ–‡ä»¶,æ¯ä¸ªdex.codesåªè§£æä¸€æ¬¡
void parseExtractedCodeFiles(const std::string&amp; dexPath)&#123;
    //1.è¯»å–ä»£ç æ–‡ä»¶ä¸ºå­—èŠ‚æ•°ç»„
    std::string codeFilePath=dexPath+codeFilePostfix;
    logd(&quot;Code File Path: %s&quot;,codeFilePath.c_str());
    size_t codeBytesLen = 0;
    uint8_t* codeBytes = readFileToBytes(codeFilePath, &amp;codeBytesLen);
    if(codeBytes == nullptr || codeBytesLen == 0) &#123;
        logd(&quot;Code file not found!&quot;)
        return;
    &#125;
    logd(&quot;CodeFile: %s Len:%#llx&quot;, codeFilePath.c_str(),codeBytesLen);

    // 2.è§£æä»£ç å­—èŠ‚æ•°ç»„
    size_t offset=0;
    while(offset&lt;codeBytesLen)&#123;
        uint8_t* pointer = codeBytes + offset;  //æ¯ä¸ªç»“æ„çš„èµ·ç‚¹æŒ‡é’ˆ
        uint32_t codeOff = bytes2uint32(pointer); // 4å­—èŠ‚CodeOffå’Œ4å­—èŠ‚InsnSize
        uint32_t insnSize = bytes2uint32(pointer+4);
        if(codeOff == 0 || insnSize == 0)&#123;
            logd(&quot;CodeOff or InsnSize equals 0!&quot;)
            break;
        &#125;
        logd(&quot;CodeOff: %#x InsnSize: %#x&quot;, codeOff, insnSize);
        // åˆ›å»ºæŠ½å–ä»£ç å¯¹è±¡
        CodeItem codeItem = CodeItem(insnSize, pointer+8);
        // æ·»åŠ ä¸€ç»„CodeOff:CodeItemæ˜ å°„
        codeMapList[dexPath].insert(std::pair&lt;uint32_t, CodeItem&gt;(codeOff, codeItem));
        logd(&quot;CodeItem codeOff: %#x insnSize: %#x has created!&quot;, codeOff, insnSize);
        offset += 8 + insnSize*2; //è·³è¿‡CodeOff,InsnSizeå’ŒInsn[]
    &#125;
&#125;

// å›å¡«dexçš„æ–¹æ³•ä»£ç ,æ¯æ¬¡åªå›å¡«ä¸€ä¸ªMethod
void innerLoadMethod(void* thiz, const DexFile* dexFile, ClassAccessor::Method* method, void* klass, void* dest)&#123;
    // dexæ–‡ä»¶è·¯å¾„
    std::string location = dexFile-&gt;location_;
    //logd(&quot;Load Dex File Location: %s&quot;,location.c_str())
    // åˆ¤æ–­æ˜¯å¦ä¸ºè§£å¯†é‡Šæ”¾çš„dexæ–‡ä»¶,ä½äºç§æœ‰ç›®å½•å†…
    if(location.find(&quot;app_tmp_dex&quot;) == std::string::npos)&#123;
        return;
    &#125;
    // å¦‚æœæœªè§£æè¿‡dexCodesæ–‡ä»¶åˆ™è¿›è¡Œè§£æ,æ¯ä¸ªdexæ–‡ä»¶åªè§£æä¸€æ¬¡,åˆ›å»ºå¯¹åº”çš„map&lt;CodeOff,CodeItem&gt;æ˜ å°„
    if(codeMapList.find(location)==codeMapList.end())&#123;
        logd(&quot;Parse dex file %s codes&quot;,location.c_str());
        codeMapList[location]=std::map&lt;uint32_t,CodeItem&gt;(); //åˆ›å»ºæ–°çš„codeMap
        parseExtractedCodeFiles(location);
    &#125;
    // ä¸å­˜åœ¨DexCode ç›´æ¥è·³è¿‡
    if(method-&gt;code_off_==0)&#123;
        return;
    &#125;
    // æŒ‡ä»¤åœ°å€
    uint8_t* codeAddr = (uint8_t*)(dexFile-&gt;begin_ + method-&gt;code_off_ + 16); //insnç»“æ„å‰é¢æœ‰16å­—èŠ‚

    //logd(&quot;MethodCodeOff: %d&quot;,method-&gt;code_off_);
    // å›å¡«æŒ‡ä»¤
    std::map&lt;uint32_t,CodeItem&gt; codeMap=codeMapList[location];
    // ä¼¼ä¹æ²¡æœ‰èµ°åˆ°å›å¡«æŒ‡ä»¤å¤„ (æ³¨æ„c++æµ…æ‹·è´é—®é¢˜,ä¸èƒ½éšæ„delete)
    if(codeMap.find(method-&gt;code_off_) != codeMap.end())&#123;
        CodeItem codeItem = codeMap[method-&gt;code_off_];
        memcpy(codeAddr,codeItem.getInsns(),codeItem.getInsnsSize()*2); //æ³¨æ„æŒ‡ä»¤ä¸ºu2ç±»å‹,é•¿åº¦éœ€è¦*2
    &#125;
&#125;

void newLoadMethod(void* thiz, const DexFile* dex_file, ClassAccessor::Method* method, void* klass, void* dest)&#123;
    if(g_originLoadMethod!= nullptr)&#123;
        // å…ˆå›å¡«æŒ‡ä»¤,å†è°ƒç”¨
        innerLoadMethod(thiz,dex_file,method,klass,dest);
        g_originLoadMethod(thiz,dex_file,method, klass, dest);
    &#125;
    return;
&#125;

void hook_LoadMethod()&#123;
    void * loadMethodAddress =  DobbySymbolResolver(getClassLinkerLoadMethodLibPath(),getClassLinkerLoadMethodSymbol());
    DobbyHook(loadMethodAddress, (void *) newLoadMethod, (void **) &amp;g_originLoadMethod);
    logd(&quot;hook LoadMethod done&quot;);
&#125;

// åˆå§‹å‡½æ•°,å®ç°hook
extern &quot;C&quot;
void _init()&#123;
    APILevel = android_get_device_api_level();
    logd(&quot;Android API Level: %d&quot;, APILevel)
    logd(&quot;Setting hook...&quot;)
    hook();
&#125;
// hook
void hook()&#123;
    bytehook_init(BYTEHOOK_MODE_AUTOMATIC, false);
    hookExecve();   // ç¦ç”¨dex2oat
    hookMmap();     // ä½¿dexæ–‡ä»¶å¯å†™
    //hook_DefineClass(); //éœ€æ‰‹åŠ¨è§£æClassDef
    hook_LoadMethod();  // åŠ è½½æ–¹æ³•æ—¶å›å¡«æŒ‡ä»¤
&#125;
</code></pre>
</li>
</ol>
<h3 id="å››ã€åŠ å›ºæµ‹è¯•"><a href="#å››ã€åŠ å›ºæµ‹è¯•" class="headerlink" title="å››ã€åŠ å›ºæµ‹è¯•"></a>å››ã€åŠ å›ºæµ‹è¯•</h3><p>åªéœ€è¦æ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤</p>
<pre><code class="language-shell">python ThirdAndroidShell.py -src &lt;æºç¨‹åºApkè·¯å¾„&gt; -shell &lt;å£³ç¨‹åºApkè·¯å¾„&gt; -out &lt;åŠ å£³åçš„Apkè·¯å¾„&gt;
</code></pre>
<p>ç„¶åå°±å¯ä»¥å¾—åˆ°åŠ å›ºä¹‹åçš„ APK</p>
<h3 id="äº”ã€å‚è€ƒ"><a href="#äº”ã€å‚è€ƒ" class="headerlink" title="äº”ã€å‚è€ƒ"></a>äº”ã€å‚è€ƒ</h3><p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-286929-1.htm#msg_header_h2_32">åŸåˆ›]Androidä»æ•´ä½“åŠ å›ºåˆ°æŠ½å–åŠ å›ºçš„å®ç°åŠåŸç†-Androidå®‰å…¨-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-285870.htm">å®‰å“å£³å­¦ä¹ è®°å½•-åŠ å£³è„±å£³-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>

      
       <hr><span style="font-style: italic;color: gray;"> è½¬è½½è¯·æ³¨æ˜æ¥æºï¼Œæ¬¢è¿å¯¹æ–‡ç« ä¸­çš„å¼•ç”¨æ¥æºè¿›è¡Œè€ƒè¯ï¼Œæ¬¢è¿æŒ‡å‡ºä»»ä½•æœ‰é”™è¯¯æˆ–ä¸å¤Ÿæ¸…æ™°çš„è¡¨è¾¾ã€‚å¯ä»¥åœ¨ä¸‹é¢è¯„è®ºåŒºè¯„è®ºï¼Œä¹Ÿå¯ä»¥é‚®ä»¶è‡³ 1621925986@qq.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">ğŸ’°</a>
</p>




    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: 'Ov23lif2sndX4YqUPQwk',
            clientSecret: 'c76a4c487d51bf36e4dd1496b3f44bdbea037d50',
            repo: 'NshIdE1.github.io',
            owner: 'NshIdE1',
            admin: ['NshIdE1'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    Â©2024-2025 NshIdE
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="Toggle full screen shortcut key s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">Ã—</a>
    <div class="shang_tit">
        <p>Help us with donation</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="æ‰«ç æ”¯æŒ">
            <img src="/img/weixin.jpg" class="weixin" title="æ‰«ç æ”¯æŒ">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">alipay</label></span><span><label><input type="radio" name="pay" value="weixin">weixin</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*æ¸²æŸ“å¯¹åº”çš„è¡¨æ ¼æ ·å¼*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*æ¸²æŸ“æ‰“èµæ ·å¼*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*é«˜äº®ä»£ç å—è¡Œå·*/
        

        /*è®¿é—®æ•°é‡*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*ä»£ç é«˜äº®ï¼Œè¡Œå·å¯¹é½*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*æ‰“èµé¡µé¢éšè—ä¸å±•ç¤º*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--åŠ å…¥è¡Œå·çš„é«˜äº®ä»£ç å—æ ·å¼-->

<!--è‡ªå®šä¹‰æ ·å¼è®¾ç½®-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*åˆ—è¡¨æ ·å¼*/
    

    /* èƒŒæ™¯å›¾æ ·å¼ */
    
    


    /*å¼•ç”¨å—æ ·å¼*/
    

    /*æ–‡ç« åˆ—è¡¨èƒŒæ™¯å›¾*/
    

    
</style>







</html>
